
/* /web/static/src/module_loader.js */
(function(){"use strict";class ModuleLoader{factories=new Map();jobs=new Set();failed=new Set();modules=new Map();bus=new EventTarget();checkErrorProm=null;define(name,deps,factory){if(typeof name!=="string"){throw new Error(`Invalid name definition: ${name} (should be a string)"`);}
if(!(deps instanceof Array)){throw new Error(`Dependencies should be defined by an array: ${deps}`);}
if(typeof factory!=="function"){throw new Error(`Factory should be defined by a function ${factory}`);}
if(!this.factories.has(name)){this.factories.set(name,{deps,fn:factory,ignoreMissingDeps:globalThis.__odooIgnoreMissingDependencies,});this.addJob(name);this.checkErrorProm||=Promise.resolve().then(()=>{this.checkAndReportErrors();this.checkErrorProm=null;});}}
addJob(name){this.jobs.add(name);this.startModules();}
findJob(){for(const job of this.jobs){if(this.factories.get(job).deps.every((dep)=>this.modules.has(dep))){return job;}}
return null;}
startModules(){let job;while((job=this.findJob())){this.startModule(job);}}
startModule(name){const require=(name)=>this.modules.get(name);this.jobs.delete(name);const factory=this.factories.get(name);let value=null;try{value=factory.fn(require);}catch(error){this.failed.add(name);throw new Error(`Error while loading "${name}":\n${error}`);}
this.modules.set(name,value);this.bus.dispatchEvent(new CustomEvent("module-started",{detail:{moduleName:name,module:value}}));}
findErrors(){const dependencyGraph=new Map();for(const job of this.jobs){dependencyGraph.set(job,this.factories.get(job).deps);}
function visitJobs(jobs,visited=new Set()){for(const job of jobs){const result=visitJob(job,visited);if(result){return result;}}
return null;}
function visitJob(job,visited){if(visited.has(job)){const jobs=Array.from(visited).concat([job]);const index=jobs.indexOf(job);return jobs.slice(index).map((j)=>`"${j}"`).join(" => ");}
const deps=dependencyGraph.get(job);return deps?visitJobs(deps,new Set(visited).add(job)):null;}
const missing=new Set();for(const job of this.jobs){const factory=this.factories.get(job);if(factory.ignoreMissingDeps){continue;}
for(const dep of factory.deps){if(!this.factories.has(dep)){missing.add(dep);}}}
return{failed:[...this.failed],cycle:visitJobs(this.jobs),missing:[...missing],unloaded:[...this.jobs].filter((j)=>!this.factories.get(j).ignoreMissingDeps),};}
async checkAndReportErrors(){const{failed,cycle,missing,unloaded}=this.findErrors();if(!failed.length&&!unloaded.length){return;}
function domReady(cb){if(document.readyState==="complete"){cb();}else{document.addEventListener("DOMContentLoaded",cb);}}
function list(heading,names){const frag=document.createDocumentFragment();if(!names||!names.length){return frag;}
frag.textContent=heading;const ul=document.createElement("ul");for(const el of names){const li=document.createElement("li");li.textContent=el;ul.append(li);}
frag.appendChild(ul);return frag;}
domReady(()=>{while(document.body.childNodes.length){document.body.childNodes[0].remove();}
const container=document.createElement("div");container.className="o_module_error position-fixed w-100 h-100 d-flex align-items-center flex-column bg-white overflow-auto modal";container.style.zIndex="10000";const alert=document.createElement("div");alert.className="alert alert-danger o_error_detail fw-bold m-auto";container.appendChild(alert);alert.appendChild(list("The following modules failed to load because of an error, you may find more information in the devtools console:",failed));alert.appendChild(list("The following modules could not be loaded because they form a dependency cycle:",cycle&&[cycle]));alert.appendChild(list("The following modules are needed by other modules but have not been defined, they may not be present in the correct asset bundle:",missing));alert.appendChild(list("The following modules could not be loaded because they have unmet dependencies, this is a secondary error which is likely caused by one of the above problems:",unloaded));document.body.appendChild(container);});}}
if(!globalThis.odoo){globalThis.odoo={};}
const odoo=globalThis.odoo;if(odoo.debug&&!new URLSearchParams(location.search).has("debug")){odoo.debug="";}
const loader=new ModuleLoader();odoo.define=loader.define.bind(loader);odoo.loader=loader;})();;

/* /web_editor/static/src/js/editor/odoo-editor/src/OdooEditor.js */
odoo.define('@web_editor/js/editor/odoo-editor/src/OdooEditor',['@web_editor/js/editor/odoo-editor/src/commands/deleteBackward','@web_editor/js/editor/odoo-editor/src/commands/deleteForward','@web_editor/js/editor/odoo-editor/src/commands/enter','@web_editor/js/editor/odoo-editor/src/commands/shiftEnter','@web_editor/js/editor/odoo-editor/src/commands/shiftTab','@web_editor/js/editor/odoo-editor/src/commands/tab','@web_editor/js/editor/odoo-editor/src/commands/toggleList','@web_editor/js/editor/odoo-editor/src/commands/align','@web_editor/js/editor/odoo-editor/src/utils/sanitize','@web_editor/js/editor/odoo-editor/src/utils/serialize','@web_editor/js/editor/odoo-editor/src/utils/utils','@web_editor/js/editor/odoo-editor/src/commands/commands','@web_editor/js/editor/odoo-editor/src/powerbox/Powerbox','@web_editor/js/editor/odoo-editor/src/tablepicker/TablePicker','@web_editor/js/editor/odoo-editor/src/utils/constants'],function(require){'use strict';let __exports={};require("@web_editor/js/editor/odoo-editor/src/commands/deleteBackward");require("@web_editor/js/editor/odoo-editor/src/commands/deleteForward");require("@web_editor/js/editor/odoo-editor/src/commands/enter");require("@web_editor/js/editor/odoo-editor/src/commands/shiftEnter");require("@web_editor/js/editor/odoo-editor/src/commands/shiftTab");require("@web_editor/js/editor/odoo-editor/src/commands/tab");require("@web_editor/js/editor/odoo-editor/src/commands/toggleList");require("@web_editor/js/editor/odoo-editor/src/commands/align");const{sanitize}=require("@web_editor/js/editor/odoo-editor/src/utils/sanitize");const{serializeNode,unserializeNode,serializeSelection}=require("@web_editor/js/editor/odoo-editor/src/utils/serialize");const{closestBlock,commonParentGet,containsUnremovable,DIRECTIONS,ensureFocus,getCursorDirection,getFurthestUneditableParent,getListMode,getOuid,insertText,isColorGradient,nodeSize,preserveCursor,setCursorStart,setSelection,toggleClass,closestElement,isVisible,isHtmlContentSupported,rgbToHex,isFontAwesome,ICON_SELECTOR,getInSelection,getDeepRange,getRowIndex,getColumnIndex,ancestors,firstLeaf,previousLeaf,nextLeaf,isUnremovable,fillEmpty,isEmptyBlock,URL_REGEX,isSelectionFormat,YOUTUBE_URL_GET_VIDEO_ID,unwrapContents,peek,getAdjacentPreviousSiblings,getAdjacentNextSiblings,isBlock,getTraversedNodes,getSelectedNodes,descendants,hasValidSelection,hasTableSelection,pxToFloat,parseHTML,splitTextNode,isEditorTab,isMacOS,isProtected,isArtificialVoidElement,cleanZWS,isZWS,setCursorEnd,paragraphRelatedElements,getDeepestPosition,leftPos,isNotAllowedContent,EMAIL_REGEX,prepareUpdate,boundariesOut,getFontSizeDisplayValue,rightLeafOnlyNotBlockPath,lastLeaf,isUnbreakable,splitAroundUntil,ZERO_WIDTH_CHARS,ZERO_WIDTH_CHARS_REGEX,getAdjacentCharacter,isLinkEligibleForZwnbsp,}=require("@web_editor/js/editor/odoo-editor/src/utils/utils");const{editorCommands}=require("@web_editor/js/editor/odoo-editor/src/commands/commands");const{Powerbox}=require("@web_editor/js/editor/odoo-editor/src/powerbox/Powerbox");const{TablePicker}=require("@web_editor/js/editor/odoo-editor/src/tablepicker/TablePicker");Object.assign(__exports,require("@web_editor/js/editor/odoo-editor/src/utils/utils"));const{UNBREAKABLE_ROLLBACK_CODE,UNREMOVABLE_ROLLBACK_CODE}=require("@web_editor/js/editor/odoo-editor/src/utils/constants");const BACKSPACE_ONLY_COMMANDS=['oDeleteBackward','oDeleteForward'];const BACKSPACE_FIRST_COMMANDS=BACKSPACE_ONLY_COMMANDS.concat(['oEnter','oShiftEnter']);const HISTORY_SNAPSHOT_INTERVAL=1000*60;const HISTORY_SNAPSHOT_BUFFER_TIME=1000*10;const KEYBOARD_TYPES={VIRTUAL:'VIRTUAL',PHYSICAL:'PHYSICAL',UNKNOWN:'UKNOWN'};const AVATAR_SIZE=__exports.AVATAR_SIZE=25;const IS_KEYBOARD_EVENT_UNDO=ev=>ev.key==='z'&&(ev.ctrlKey||ev.metaKey);const IS_KEYBOARD_EVENT_REDO=ev=>ev.key==='y'&&(ev.ctrlKey||ev.metaKey);const IS_KEYBOARD_EVENT_BOLD=ev=>ev.key==='b'&&(ev.ctrlKey||ev.metaKey);const IS_KEYBOARD_EVENT_ITALIC=ev=>ev.key==='i'&&(ev.ctrlKey||ev.metaKey);const IS_KEYBOARD_EVENT_UNDERLINE=ev=>ev.key==='u'&&(ev.ctrlKey||ev.metaKey);const IS_KEYBOARD_EVENT_STRIKETHROUGH=ev=>ev.key==='5'&&(ev.ctrlKey||ev.metaKey);const IS_KEYBOARD_EVENT_LEFT_ARROW=ev=>ev.key==='ArrowLeft'&&!(ev.ctrlKey||ev.metaKey);const IS_KEYBOARD_EVENT_RIGHT_ARROW=ev=>ev.key==='ArrowRight'&&!(ev.ctrlKey||ev.metaKey);const CLIPBOARD_BLACKLISTS={unwrap:['.Apple-interchange-newline','DIV'],remove:['META','STYLE','SCRIPT'],};const CLIPBOARD_WHITELISTS=__exports.CLIPBOARD_WHITELISTS={nodes:['P','H1','H2','H3','H4','H5','H6','BLOCKQUOTE','PRE','UL','OL','LI','I','B','U','S','EM','FONT','STRONG','TABLE','THEAD','TH','TBODY','TR','TD','IMG','BR','A','.fa',],classes:[/^float-/,'d-block','mx-auto','img-fluid','img-thumbnail','rounded','rounded-circle','table','table-bordered',/^padding-/,/^shadow/,/^text-o-/,/^bg-o-/,'o_checked','o_checklist','oe-nested',/^btn/,/^fa/,],attributes:['class','href','src','target'],styledTags:['SPAN','B','STRONG','I','S','U','FONT','TD'],};const SELECTIONLESS_COMMANDS=['addRow','addColumn','removeRow','removeColumn','resetSize'];const FORMATTING_COMMANDS=['applyColor','bold','italic','underline','strikeThrough','setFontSize']
function defaultOptions(defaultObject,object){const newObject=Object.assign({},defaultObject,object);for(const[key,value]of Object.entries(object)){if(typeof value==='undefined'){newObject[key]=defaultObject[key];}}
return newObject;}
function getImageFiles(dataTransfer){return[...dataTransfer.items].filter(item=>item.kind==='file'&&item.type.includes('image/')).map((item)=>item.getAsFile());}
function getImageUrl(file){return new Promise((resolve,reject)=>{const reader=new FileReader();reader.readAsDataURL(file);reader.onloadend=(e)=>{if(reader.error){return reject(reader.error);}
resolve(e.target.result);};});}
const OdooEditor=__exports.OdooEditor=class OdooEditor extends EventTarget{constructor(editable,options={}){super();this.options=defaultOptions({controlHistoryFromDocument:false,getContextFromParentRect:()=>{return{top:0,left:0};},getScrollContainerRect:()=>document.body.getBoundingClientRect(),toSanitize:true,isRootEditable:true,placeholder:false,showEmptyElementHint:true,defaultLinkAttributes:{},plugins:[],getUnremovableElements:()=>[],getReadOnlyAreas:()=>[],getContentEditableAreas:()=>[],getPowerboxElement:()=>{const selection=document.getSelection();if(selection.isCollapsed&&selection.rangeCount){return closestElement(selection.anchorNode,'P, DIV');}},preHistoryUndo:()=>{},isHintBlacklisted:()=>false,filterMutationRecords:(records)=>records,postProcessExternalSteps:()=>null,onPostSanitize:()=>{},direction:'ltr',_t:string=>string,allowCommandVideo:true,renderingClasses:[],allowInlineAtRoot:false,useResponsiveFontSizes:true,showResponsiveFontSizesBadges:false,showExtendedTextStylesOptions:false,autoActivateContentEditable:true,getCSSVariableValue:()=>null,convertNumericToUnit:x=>x,},options,);this.document=options.document||document;this.isDestroyed=false;this.isMobile=matchMedia('(max-width: 767px)').matches;this.isFirefox=navigator.userAgent.toLowerCase().indexOf('firefox')>-1;this.isPrepareUpdateLocked=false;this.keyboardType=KEYBOARD_TYPES.UNKNOWN;this._checkStepUnbreakable=true;this._domListeners=[];this._observerTimeoutUnactive=new Set();this._observerUnactiveLabels=new Set();this._currentMouseState='mouseup';this._onKeyupResetContenteditableNodes=[];this._toRollback=false;this._idToNodeMap=new Map();this._plugins=[];for(const plugin of this.options.plugins){this._pluginAdd(plugin);}
if(editable.innerHTML.trim()===''){editable.innerHTML='<p><br></p>';}
this.initElementForEdition(editable);editable.oid='root';this._idToNodeMap.set(1,editable);this.editable=editable;this.editable.classList.add("odoo-editor-editable");if(this.options.toSanitize){sanitize(editable);this.options.onPostSanitize(editable);}
this.editable.setAttribute('dir',this.options.direction);this.canActivateContentEditable=this.options.autoActivateContentEditable;if(this.canActivateContentEditable){this._activateContenteditable();}
this._collabClientId=this.options.collaborationClientId;this._collabClientAvatarUrl=this.options.collaborationClientAvatarUrl;this._collabSelectionInfos=new Map();this._collabSelectionColor=`hsl(${(Math.random() * 360).toFixed(0)}, 75%, 50%)`;this._avatarsOverlaps={}
this.mainAbsoluteContainer=this.document.createElement('div');this.mainAbsoluteContainer.classList.add('oe-absolute-container');this.editable.before(this.mainAbsoluteContainer);this._selectionsContainer=this.makeAbsoluteContainer('oe-selections-container');this._avatarsContainer=this.makeAbsoluteContainer('oe-avatars-container');this._avatarsCountersContainer=this.makeAbsoluteContainer('oe-avatars-counters-container');this._postProcessExternalStepsPromise=null;this._externalStepsBuffer=[];this.idSet(editable);this._historyStepsActive=true;this.historyReset();if(this.options.initialHistoryId){this.historySetInitialId(this.options.initialHistoryId);}
this._pluginCall('start',[editable]);this._pluginCall('sanitizeElement',[editable]);this.powerboxTablePicker=new TablePicker({document:this.document,floating:true,getContextFromParentRect:this.options.getContextFromParentRect,direction:this.options.direction,});document.body.appendChild(this.powerboxTablePicker.el);this.powerboxTablePicker.addEventListener('cell-selected',ev=>{this.execCommand('insertTable',{rowNumber:ev.detail.rowNumber,colNumber:ev.detail.colNumber,});});this._tableUiContainer=this.document.createElement('div');this._tableUiContainer.classList.add('o_table_ui_container');const parser=new DOMParser();const isRTL=this.options.direction==="rtl";for(const direction of['row','column']){const iconClass=(direction==='row')?'fa-ellipsis-v':'fa-ellipsis-h';const ui=parser.parseFromString(`<div class="o_table_ui o_${direction}_ui" style="visibility: hidden;">
                <div>
                    <span class="o_table_ui_menu_toggler fa ${iconClass}"></span>
                    <div class="o_table_ui_menu"></div>
                </div>
            </div>`,'text/html').body.firstElementChild;const uiMenu=ui.querySelector('.o_table_ui_menu');if(direction==='column'){if(isRTL){uiMenu.append(...parser.parseFromString(`
                        <div class="o_move_right"><span class="fa fa-chevron-right"></span>`+this.options._t('Move left')+`</div>
                        <div class="o_move_left"><span class="fa fa-chevron-left"></span>`+this.options._t('Move right')+`</div>
                    `,'text/html').body.children);}else{uiMenu.append(...parser.parseFromString(`
                        <div class="o_move_left"><span class="fa fa-chevron-left"></span>`+this.options._t('Move left')+`</div>
                        <div class="o_move_right"><span class="fa fa-chevron-right"></span>`+this.options._t('Move right')+`</div>
                    `,'text/html').body.children);}
this.addDomListener(uiMenu.querySelector('.o_move_left'),'click',this._onTableMoveLeftClick);this.addDomListener(uiMenu.querySelector('.o_move_right'),'click',this._onTableMoveRightClick);}else{uiMenu.append(...parser.parseFromString(`
                    <div class="o_move_up"><span class="fa fa-chevron-left" style="transform: rotate(90deg);"></span>`+this.options._t('Move up')+`</div>
                    <div class="o_move_down"><span class="fa fa-chevron-right" style="transform: rotate(90deg);"></span>`+this.options._t('Move down')+`</div>
                `,'text/html').body.children);this.addDomListener(uiMenu.querySelector('.o_move_up'),'click',this._onTableMoveUpClick);this.addDomListener(uiMenu.querySelector('.o_move_down'),'click',this._onTableMoveDownClick);}
if(direction==='column'){if(isRTL){uiMenu.append(...parser.parseFromString(`
                        <div class="o_insert_right"><span class="fa fa-plus"></span>`+this.options._t('Insert left')+`</div>
                        <div class="o_insert_left"><span class="fa fa-plus"></span>`+this.options._t('Insert right')+`</div>
                    `,'text/html').body.children);}else{uiMenu.append(...parser.parseFromString(`
                        <div class="o_insert_left"><span class="fa fa-plus"></span>`+this.options._t('Insert left')+`</div>
                        <div class="o_insert_right"><span class="fa fa-plus"></span>`+this.options._t('Insert right')+`</div>
                    `,'text/html').body.children);}
this.addDomListener(uiMenu.querySelector('.o_insert_left'),'click',()=>this.execCommand('addColumn','before',this._columnUiTarget));this.addDomListener(uiMenu.querySelector('.o_insert_right'),'click',()=>this.execCommand('addColumn','after',this._columnUiTarget));}else{uiMenu.append(...parser.parseFromString(`
                    <div class="o_insert_above"><span class="fa fa-plus"></span>`+this.options._t('Insert above')+`</div>
                    <div class="o_insert_below"><span class="fa fa-plus"></span>`+this.options._t('Insert below')+`</div>
                `,'text/html').body.children);this.addDomListener(uiMenu.querySelector('.o_insert_above'),'click',()=>this.execCommand('addRow','before',this._rowUiTarget));this.addDomListener(uiMenu.querySelector('.o_insert_below'),'click',()=>this.execCommand('addRow','after',this._rowUiTarget));}
if(direction==='column'){uiMenu.append(parser.parseFromString(`<div class="o_delete_column"><span class="fa fa-trash"></span>`+this.options._t('Delete')+`</div>
                `,'text/html').body.firstChild)
this.addDomListener(uiMenu.querySelector('.o_delete_column'),'click',this._onTableDeleteColumnClick);}else{uiMenu.append(parser.parseFromString(`<div class="o_delete_row"><span class="fa fa-trash"></span>`+this.options._t('Delete')+`</div>
                `,'text/html').body.firstChild)
this.addDomListener(uiMenu.querySelector('.o_delete_row'),'click',this._onTableDeleteRowClick);}
uiMenu.append(parser.parseFromString(`<div class="o_reset_table_size"><span class="fa fa-table"></span>`+this.options._t('Reset Size')+`</div>
                `,'text/html').body.firstChild)
this.addDomListener(uiMenu.querySelector('.o_reset_table_size'),'click',()=>this.execCommand('resetSize',this._tableUiTarget));this[`_${direction}Ui`]=ui;this._tableUiContainer.append(ui);this.addDomListener(ui.querySelector('.o_table_ui_menu_toggler'),'click',this._onTableMenuTogglerClick);this.editable.before(this._tableUiContainer);}
this.powerbox=new Powerbox({editable:this.editable,getContextFromParentRect:this.options.getContextFromParentRect,commandFilters:this.options.powerboxFilters,onShow:()=>{this.powerboxTablePicker.hide();},beforeCommand:()=>{if(this._isPowerboxOpenOnInput){this.historyRevertUntil(this._powerboxBeforeStepIndex);this.historyStep(true);this._historyStepsStates.set(peek(this._historySteps).id,'consumed');ensureFocus(this.editable);getDeepRange(this.editable,{select:true});}},afterCommand:()=>{this.historyStep(true);this._isPowerboxOpenOnInput=false;},categories:[{name:this.options._t('Structure'),priority:70},{name:this.options._t('Format'),priority:60},{name:this.options._t('Widgets'),priority:30},...(this.options.categories||[]),],commands:[{category:this.options._t('Structure'),name:this.options._t('Bulleted list'),priority:110,description:this.options._t('Create a simple bulleted list'),fontawesome:'fa-list-ul',isDisabled:()=>!this.isSelectionInBlockRoot(),callback:()=>{this.execCommand('toggleList','UL');},},{category:this.options._t('Structure'),name:this.options._t('Numbered list'),priority:100,description:this.options._t('Create a list with numbering'),fontawesome:'fa-list-ol',isDisabled:()=>!this.isSelectionInBlockRoot(),callback:()=>{this.execCommand('toggleList','OL');},},{category:this.options._t('Structure'),name:this.options._t('Checklist'),priority:90,description:this.options._t('Track tasks with a checklist'),fontawesome:'fa-check-square-o',isDisabled:()=>!this.isSelectionInBlockRoot(),callback:()=>{this.execCommand('toggleList','CL');},},{category:this.options._t('Structure'),name:this.options._t('Table'),priority:80,description:this.options._t('Insert a table'),fontawesome:'fa-table',isDisabled:()=>!this.isSelectionInBlockRoot(),callback:()=>{if(this.isMobile){this.execCommand('insertTable',{rowNumber:this.powerboxTablePicker.rowNumber,colNumber:this.powerboxTablePicker.colNumber,});}else{this.powerboxTablePicker.show();}},},{category:this.options._t('Format'),name:this.options._t('Heading 1'),priority:50,description:this.options._t('Big section heading'),fontawesome:'fa-header',isDisabled:()=>!this.isSelectionInBlockRoot(),callback:()=>{this.execCommand('setTag','H1');},},{category:this.options._t('Format'),name:this.options._t('Heading 2'),priority:40,description:this.options._t('Medium section heading'),fontawesome:'fa-header',isDisabled:()=>!this.isSelectionInBlockRoot(),callback:()=>{this.execCommand('setTag','H2');},},{category:this.options._t('Format'),name:this.options._t('Heading 3'),priority:30,description:this.options._t('Small section heading'),fontawesome:'fa-header',isDisabled:()=>!this.isSelectionInBlockRoot(),callback:()=>{this.execCommand('setTag','H3');},},{category:this.options._t('Format'),name:this.options._t('Switch direction'),priority:20,description:this.options._t('Switch the text\'s direction'),fontawesome:'fa-exchange',callback:()=>{this.execCommand('switchDirection');},},{category:this.options._t('Format'),name:this.options._t('Text'),priority:10,description:this.options._t('Paragraph block'),fontawesome:'fa-paragraph',isDisabled:()=>!this.isSelectionInBlockRoot(),callback:()=>{this.execCommand('setTag','P');},},{category:this.options._t('Widgets'),name:this.options._t('3 Stars'),priority:20,description:this.options._t('Insert a rating over 3 stars'),fontawesome:'fa-star-o',callback:()=>{let html='\u200B<span contenteditable="false" class="o_stars o_three_stars">';html+=Array(3).fill().map(()=>'<i class="fa fa-star-o"></i>').join('');html+='</span>\u200B';this.execCommand('insert',parseHTML(this.document,html));},},{category:this.options._t('Widgets'),name:this.options._t('5 Stars'),priority:10,description:this.options._t('Insert a rating over 5 stars'),fontawesome:'fa-star',callback:()=>{let html='\u200B<span contenteditable="false" class="o_stars o_five_stars">';html+=Array(5).fill().map(()=>'<i class="fa fa-star-o"></i>').join('');html+='</span>\u200B';this.execCommand('insert',parseHTML(this.document,html));},},...(this.options.commands||[]),...(!this.options.commands||!this.options.commands.find(c=>c.name===this.options._t('Separator'))?[{category:this.options._t('Structure'),name:this.options._t('Separator'),priority:40,description:this.options._t('Insert a horizontal rule separator'),fontawesome:'fa-minus',isDisabled:()=>!this.isSelectionInBlockRoot(),callback:()=>{this.execCommand('insertHorizontalRule');},}]:[]),],});this.observerActive();this.addDomListener(this.editable,'keydown',this._onKeyDown);this.addDomListener(this.editable,'input',this._onInput);this.addDomListener(this.editable,'beforeinput',this._onBeforeInput);this.addDomListener(this.editable,'mousedown',this._onMouseDown);this.addDomListener(this.editable,'mouseup',this._onMouseup);this.addDomListener(this.editable,'mousemove',this._onMousemove);this.addDomListener(this.editable,'mouseleave',this._onMouseLeave);this.addDomListener(this.editable,'paste',this._onPaste);this.addDomListener(this.editable,'dragstart',this._onDragStart);this.addDomListener(this.editable,'drop',this._onDrop);this.addDomListener(this.editable,'copy',this._onClipboardCopy);this.addDomListener(this.editable,'cut',this._onClipboardCut);this.addDomListener(this.document,'selectionchange',this._onSelectionChange);this.addDomListener(this.document,'selectionchange',this._handleCommandHint);this.addDomListener(this.document,'keydown',this._onDocumentKeydown);this.addDomListener(this.document,'keyup',this._onDocumentKeyup);this.addDomListener(this.document,'mouseup',this._onDocumentMouseup);this.addDomListener(this.document,'click',this._onDocumentClick);this.addDomListener(this.document,'scroll',this._onScroll,true);this.multiselectionRefresh=this.multiselectionRefresh.bind(this);this._resizeObserver=new ResizeObserver(this.multiselectionRefresh);this._resizeObserver.observe(this.document.body);this._resizeObserver.observe(this.editable);this.addDomListener(this.editable,'scroll',this.multiselectionRefresh);if(this._collabClientId){this._snapshotInterval=setInterval(()=>{this._historyMakeSnapshot();},HISTORY_SNAPSHOT_INTERVAL);}
if(this.options.toolbar){this.setupToolbar(this.options.toolbar);}
if(editable.textContent===''&&this.options.placeholder){this._makeHint(editable.firstChild,this.options.placeholder,true);}}
destroy(){this.observerUnactive();this._removeDomListener();this.powerbox.destroy();this.powerboxTablePicker.el.remove();this.mainAbsoluteContainer.remove();this._resizeObserver.disconnect();clearInterval(this._snapshotInterval);this._pluginCall('destroy',[]);this.isDestroyed=true;this._rowUi.remove();this._columnUi.remove();}
setupToolbar(toolbar){this.toolbar=toolbar;this.autohideToolbar=this.options.autohideToolbar;if(!this.options.showExtendedTextStylesOptions){this.toolbar.querySelectorAll("[data-extended-text-style]").forEach(el=>el.classList.add("d-none"));}
this.bindExecCommand(this.toolbar);const toolbarAnchors=this.toolbar.querySelectorAll('a');toolbarAnchors.forEach(a=>a.addEventListener('click',e=>e.preventDefault()));for(const colorLabel of this.toolbar.querySelectorAll('label')){colorLabel.addEventListener('mousedown',ev=>{if(ev.detail<2){ev.preventDefault();ev.currentTarget.dispatchEvent(new MouseEvent('click',{detail:2}));}});colorLabel.addEventListener('input',ev=>{this.document.execCommand(ev.target.name,false,ev.target.value);this.updateColorpickerLabels();});}
const fontSizeInput=this.toolbar.querySelector('input#fontSizeCurrentValue');this.addDomListener(this.toolbar,'click',ev=>{if(fontSizeInput&&!fontSizeInput.readOnly&&ev.target.closest('#font-size .dropdown-toggle')){fontSizeInput.select();}else if(!this.isSelectionInEditable()&&ev.target.nodeName!=='INPUT'&&ev.target.id!=='image-transform'){this.historyResetLatestComputedSelection(true);}});const applyFontSizeREM=pxStrValue=>{const pxValue=parseFloat(pxStrValue);const remValue=this.options.convertNumericToUnit(pxValue,"px","rem");this.execCommand("setFontSize",`${remValue}rem`);};if(fontSizeInput){const debouncedOnInputChange=(()=>{let handle;return()=>new Promise(resolve=>{clearTimeout(handle);handle=setTimeout(()=>{handle=null;const fontSize=parseInt(fontSizeInput.value);if(fontSize>0){if(!this.isSelectionInEditable()){this.historyResetLatestComputedSelection(true);}
applyFontSizeREM(fontSize);fontSizeInput.blur();}
resolve();},50);});})();this.addDomListener(fontSizeInput,'change',debouncedOnInputChange);}
const fontSizeDropdown=this.toolbar.querySelector('#font-size');if(fontSizeDropdown){this.computeFontSizeSelectorValues(fontSizeDropdown);const applyFontSizeChoice=optionEl=>{if(!this.isSelectionInEditable()){this.historyResetLatestComputedSelection(true);}
if(this.options.useResponsiveFontSizes){const fontSizeClassName=optionEl.dataset.applyClass;this.execCommand("setFontSize",undefined);this.execCommand("setFontSizeClassName",fontSizeClassName);}else{applyFontSizeREM(optionEl.dataset.value);}};fontSizeDropdown.querySelectorAll('.dropdown-item').forEach(item=>{this.addDomListener(item,'mousedown',ev=>{applyFontSizeChoice(ev.currentTarget);});this.addDomListener(item,'keydown',ev=>{if(ev.key!=='Enter'){return;}
applyFontSizeChoice(ev.currentTarget);});});}
this._updateToolbar();}
computeFontSizeSelectorValues(fontSizeDropdownEl){fontSizeDropdownEl=fontSizeDropdownEl||this.toolbar.querySelector("#font-size");let previousItem=null;let previousValue=-1;const style=this.document.defaultView.getComputedStyle(this.document.body);for(const itemEl of fontSizeDropdownEl.querySelectorAll("[data-dynamic-value]")){const variableName=itemEl.dataset.dynamicValue;const strValue=this.options.getCSSVariableValue(variableName,style);const remValue=parseFloat(strValue);const pxValue=this.options.convertNumericToUnit(remValue,"rem","px");const roundedValue=Math.round(pxValue);itemEl.dataset.value=roundedValue;itemEl.firstChild.textContent=roundedValue;if(previousItem){previousItem.parentElement.classList.toggle('d-none',Math.abs(pxValue-previousValue)<0.001);}
previousItem=itemEl;previousValue=pxValue;}
for(const badgeEl of fontSizeDropdownEl.querySelectorAll(".o_we_font_size_badge")){badgeEl.classList.toggle("d-none",!this.options.showResponsiveFontSizesBadges);}}
resetContent(value){value=value||'<p><br></p>';this.editable.innerHTML=value;this.sanitize(this.editable);this.historyStep(true);this._toRollback=false;if(this.editable.textContent===''&&this.options.placeholder){this._makeHint(this.editable.firstChild,this.options.placeholder,true);}
this.multiselectionRefresh();}
sanitize(target){this.observerFlush();let record;if(!target){for(record of this._currentStep.mutations){const node=this.idFind(record.parentId||record.id)||this.editable;if(!this.editable.contains(node)){continue;}
target=target?commonParentGet(target,node,this.editable):node;}}
if(!target){return false;}
const nestedListAncestor=closestElement(target,'.oe-nested');if(nestedListAncestor&&nestedListAncestor.parentElement){target=nestedListAncestor.parentElement;}
sanitize(target,this.editable);this._resetLinkInSelection();this._pluginCall('sanitizeElement',[target.parentElement||target]);this.options.onPostSanitize(target);}
addDomListener(element,eventName,callback,useCapture){const boundCallback=callback.bind(this);this._domListeners.push([element,eventName,boundCallback]);element.addEventListener(eventName,boundCallback,useCapture);}
makeAbsoluteContainer(containerId){const container=this.document.createElement('div');container.className=`oe-absolute-container`;container.setAttribute('data-oe-absolute-container-id',containerId);this.mainAbsoluteContainer.append(container);return container;}
_generateId(){return Math.floor(Math.random()*Math.pow(2,52)).toString();}
idSet(node,testunbreak=false){if(!node.oid){node.oid=this._generateId();}
this._idToNodeMap.set(node.oid,node);node.ouid=node.ouid||getOuid(node,true);if(testunbreak&&!(node.nodeType===Node.TEXT_NODE&&!node.length)){const ouid=getOuid(node);if(!this._toRollback&&ouid&&ouid!==node.ouid){this._toRollback=UNBREAKABLE_ROLLBACK_CODE;}}
let childNode=node.firstChild;while(childNode){this.idSet(childNode,testunbreak);childNode=childNode.nextSibling;}}
idFind(id){return this._idToNodeMap.get(id);}
serializeNode(node,mutatedNodes){return this._collabClientId?serializeNode(node,mutatedNodes):node;}
unserializeNode(node){return this._collabClientId?unserializeNode(node):node;}
automaticStepActive(label){this._observerTimeoutUnactive.delete(label);}
automaticStepUnactive(label){this._observerTimeoutUnactive.add(label);}
automaticStepSkipStack(){this.automaticStepUnactive('skipStack');setTimeout(()=>this.automaticStepActive('skipStack'));}
observerUnactive(label){this._observerUnactiveLabels.add(label);if(this.observer){clearTimeout(this.observerTimeout);this.observerFlush();this.dispatchEvent(new Event('observerUnactive'));this.observer.disconnect();}}
observerFlush(){const records=this.observer.takeRecords();this.observerIdSet(records);this.observerApply(this.filterMutationRecords(records));}
observerActive(label){this._observerUnactiveLabels.delete(label);if(this._observerUnactiveLabels.size!==0)return;if(!this.observer){this.observer=new MutationObserver(records=>{this.observerIdSet(records);records=this.filterMutationRecords(records);if(!records.length)return;this.dispatchEvent(new Event('contentChanged'));clearTimeout(this.observerTimeout);if(this._observerTimeoutUnactive.size===0){this.observerTimeout=setTimeout(()=>{this.historyStep();},100);}
this.observerApply(records);});}
this.dispatchEvent(new Event('preObserverActive'));this.observer.observe(this.editable,{childList:true,subtree:true,attributes:true,attributeOldValue:true,characterData:true,characterDataOldValue:true,});this.dispatchEvent(new Event('observerActive'));}
observerIdSet(records){for(const record of records){if(record.type==='childList'){this.idSet(record.target);}}}
observerApply(records){const mutatedNodes=new Set();for(const record of records){if(record.type==='childList'){for(const node of record.addedNodes){this.idSet(node,this._checkStepUnbreakable);mutatedNodes.add(node.oid);}
for(const node of record.removedNodes){this.idSet(node,this._checkStepUnbreakable);mutatedNodes.delete(node.oid);}}}
for(const record of records){switch(record.type){case'characterData':{this._currentStep.mutations.push({'type':'characterData','id':record.target.oid,'text':record.target.textContent,'oldValue':record.oldValue,});break;}
case'attributes':{this._currentStep.mutations.push({'type':'attributes','id':record.target.oid,'attributeName':record.attributeName,'value':record.target.getAttribute(record.attributeName),'oldValue':record.oldValue,});break;}
case'childList':{record.addedNodes.forEach(added=>{if(!this._toRollback&&containsUnremovable(added)){this._toRollback=UNREMOVABLE_ROLLBACK_CODE;}
const mutation={'type':'add',};if(!record.nextSibling&&record.target.oid){mutation.append=record.target.oid;}else if(record.nextSibling&&record.nextSibling.oid){mutation.before=record.nextSibling.oid;}else if(!record.previousSibling&&record.target.oid){mutation.prepend=record.target.oid;}else if(record.previousSibling&&record.previousSibling.oid){mutation.after=record.previousSibling.oid;}else{return false;}
mutation.id=added.oid;mutation.node=this.serializeNode(added,mutatedNodes);this._currentStep.mutations.push(mutation);});record.removedNodes.forEach(removed=>{if(!this._toRollback&&containsUnremovable(removed)){this._toRollback=UNREMOVABLE_ROLLBACK_CODE;}
this._currentStep.mutations.push({'type':'remove','id':removed.oid,'parentId':record.target.oid,'node':this.serializeNode(removed),'nextId':record.nextSibling?record.nextSibling.oid:undefined,'previousId':record.previousSibling?record.previousSibling.oid:undefined,});});break;}}}
if(records.length){this.dispatchEvent(new Event('observerApply'));}}
filterMutationRecords(records){const attributeCache=new Map();const filteredRecords=[];for(const record of records){if(record.type==='attributes'){if(record.target===this.editable)continue;if(record.attributeName==='contenteditable'){continue;}
attributeCache.set(record.target,attributeCache.get(record.target)||{});if(record.attributeName==='class'){const classBefore=(record.oldValue&&record.oldValue.split(' '))||[];const classAfter=(record.target.className&&record.target.className.split&&record.target.className.split(' '))||[];const excludedClasses=[];for(const klass of classBefore){if(!classAfter.includes(klass)){excludedClasses.push(klass);}}
for(const klass of classAfter){if(!classBefore.includes(klass)){excludedClasses.push(klass);}}
if(excludedClasses.length&&excludedClasses.every(c=>this.options.renderingClasses.includes(c))){continue;}}
if(typeof attributeCache.get(record.target)[record.attributeName]==='undefined'){const oldValue=record.oldValue===undefined?null:record.oldValue;attributeCache.get(record.target)[record.attributeName]=oldValue!==record.target.getAttribute(record.attributeName);}
if(!attributeCache.get(record.target)[record.attributeName]){continue;}}
const closestProtectedCandidate=closestElement(record.target,'[data-oe-protected]');if(closestProtectedCandidate){const protectedValue=closestProtectedCandidate.dataset.oeProtected;switch(protectedValue){case"true":case"":if(record.type!=="attributes"||record.target!==closestProtectedCandidate||isProtected(closestProtectedCandidate.parentElement)){continue;}
break;case"false":if(record.type==="attributes"&&record.target===closestProtectedCandidate&&isProtected(closestProtectedCandidate.parentElement)){continue;}
break;}}
filteredRecords.push(record);}
return this.options.filterMutationRecords(filteredRecords);}
historyReset(){this._historyClean();const firstStep=this._historyGetSnapshotStep();this._firstStepId=firstStep.id;this._historySnapshots=[{step:firstStep}];this._historySteps.push(firstStep);this._historyIds=[];}
historySetInitialId(id){this._historyIds.unshift(id);}
historyGetBranchIds(){return this._historyIds.concat(this._historySteps.map(s=>s.id));}
historyGetSnapshotSteps(){if(!this._historySnapshots[0].time){return{steps:this._historySteps,historyIds:this.historyGetBranchIds()};}
const steps=[];let snapshot;if(this._historySnapshots[0].time+HISTORY_SNAPSHOT_BUFFER_TIME<Date.now()){snapshot=this._historySnapshots[0];}else{snapshot=this._historySnapshots[1];}
let index=this._historySteps.length-1;while(this._historySteps[index].id!==snapshot.step.id){steps.push(this._historySteps[index]);index--;}
steps.push(snapshot.step);steps.reverse();return{steps,historyIds:this.historyGetBranchIds()};}
historyResetFromSteps(steps,historyIds){this._historyIds=historyIds;this.observerUnactive();for(const node of[...this.editable.childNodes]){node.remove();}
this._historyClean();for(const step of steps){this.historyApply(step.mutations);}
this._historySnapshots=[{step:steps[0]}];this._historySteps=steps;this._postProcessExternalStepsPromise=this.options.postProcessExternalSteps(this.editable);this._handleCommandHint();this.multiselectionRefresh();this.observerActive();this.dispatchEvent(new Event('historyResetFromSteps'));}
historyGetSteps(){return this._historySteps;}
historyGetMissingSteps({fromStepId,toStepId}){const fromIndex=this._historySteps.findIndex(x=>x.id===fromStepId);const toIndex=toStepId?this._historySteps.findIndex(x=>x.id===toStepId):this._historySteps.length;if(fromIndex===-1||toIndex===-1){return-1;}
return this._historySteps.slice(fromIndex+1,toIndex);}
historyStep(skipRollback=false,{stepId}={}){if(!this._historyStepsActive){return;}
this.sanitize();if(this._toRollback){if(!skipRollback)this.historyRollback();this._toRollback=false;}
const currentStep=this._currentStep;if(!currentStep.mutations.length){return false;}
currentStep.id=stepId||this._generateId();const previousStep=peek(this._historySteps);currentStep.clientId=this._collabClientId;currentStep.previousStepId=previousStep.id;this._historySteps.push(currentStep);if(this.options.onHistoryStep){this.options.onHistoryStep(currentStep);}
this._currentStep={selection:{},mutations:[],};this._checkStepUnbreakable=true;this._recordHistorySelection();this.dispatchEvent(new Event('historyStep'));this.multiselectionRefresh();}
historyApply(records){for(const record of records){if(record.type==='characterData'){const node=this.idFind(record.id);if(node){node.textContent=record.text;}}else if(record.type==='attributes'){const node=this.idFind(record.id);if(node){let value=record.value;if(typeof value==='string'&&record.attributeName==='class'){value=value.split(' ').filter(c=>!this.options.renderingClasses.includes(c)).join(' ');}
if(this._collabClientId){this._safeSetAttribute(node,record.attributeName,value);}else{node.setAttribute(record.attributeName,value);}}}else if(record.type==='remove'){const toremove=this.idFind(record.id);if(toremove){toremove.remove();}}else if(record.type==='add'){let node=this.idFind(record.oid)||(record.node&&this.unserializeNode(record.node));if(!node){continue;}
if(this._collabClientId){const fakeNode=document.createElement('fake-el');fakeNode.appendChild(node);DOMPurify.sanitize(fakeNode,{IN_PLACE:true});node=fakeNode.childNodes[0];if(!node){continue;}}
this.idSet(node,true);if(record.append&&this.idFind(record.append)){this.idFind(record.append).append(node);}else if(record.before&&this.idFind(record.before)){this.idFind(record.before).before(node);}else if(record.after&&this.idFind(record.after)){this.idFind(record.after).after(node);}else{continue;}}}}
historyRollback(until=0){const step=this._currentStep;this.observerFlush();this.historyRevert(step,{until});this.observerFlush();step.mutations=step.mutations.slice(0,until);this._toRollback=false;}
historyRevertCurrentStep(){this.observerFlush();this.historyRevert(this._currentStep,{sideEffect:false});this.observerFlush();this._currentStep.mutations=[];this._activateContenteditable();this.historySetSelection(this._currentStep);}
historyUndo(){this.options.preHistoryUndo();const lastStep=this._currentStep;this.historyRevert(lastStep);lastStep.mutations=[];const pos=this._getNextUndoIndex();if(pos>0){this._historyStepsStates.set(this._historySteps[pos].id,'consumed');this.historyRevert(this._historySteps[pos]);const stepId=this._generateId();this._historyStepsStates.set(stepId,'undo');this.historyStep(true,{stepId});this.dispatchEvent(new Event('historyUndo'));}}
historyRedo(){this.historyRevert(this._currentStep);this._currentStep.mutations=[];const pos=this._getNextRedoIndex();if(pos>0){this._historyStepsStates.set(this._historySteps[pos].id,'consumed');this.historyRevert(this._historySteps[pos]);this.historySetSelection(this._historySteps[pos]);const stepId=this._generateId();this._historyStepsStates.set(stepId,'redo');this.historyStep(true,{stepId});this.dispatchEvent(new Event('historyRedo'));}}
historyCanUndo(){return this._getNextUndoIndex()>0;}
historyCanRedo(){return this._getNextRedoIndex()>0;}
historySize(){return this._historySteps.length;}
historyRevert(step,{until=0,sideEffect=true}={}){for(let i=step.mutations.length-1;i>=until;i--){const mutation=step.mutations[i];if(!mutation){break;}
switch(mutation.type){case'characterData':{const node=this.idFind(mutation.id);if(node)node.textContent=mutation.oldValue;break;}
case'attributes':{const node=this.idFind(mutation.id);if(node){if(mutation.oldValue){let value=mutation.oldValue;if(typeof value==='string'&&mutation.attributeName==='class'){value=value.split(' ').filter(c=>!this.options.renderingClasses.includes(c)).join(' ');}
if(this._collabClientId){this._safeSetAttribute(node,mutation.attributeName,value);}else{node.setAttribute(mutation.attributeName,value);}}else{node.removeAttribute(mutation.attributeName);}}
break;}
case'remove':{let nodeToRemove=this.idFind(mutation.id);if(!nodeToRemove){if(!mutation.node){continue;}
nodeToRemove=this.unserializeNode(mutation.node);const fakeNode=document.createElement('fake-el');fakeNode.appendChild(nodeToRemove);DOMPurify.sanitize(fakeNode,{IN_PLACE:true});nodeToRemove=fakeNode.childNodes[0];if(!nodeToRemove){continue;}
this.idSet(nodeToRemove);}
if(mutation.nextId&&this.idFind(mutation.nextId)?.isConnected){const node=this.idFind(mutation.nextId);node&&node.before(nodeToRemove);}else if(mutation.previousId&&this.idFind(mutation.previousId)?.isConnected){const node=this.idFind(mutation.previousId);node&&node.after(nodeToRemove);}else{const node=this.idFind(mutation.parentId);node&&node.append(nodeToRemove);}
break;}
case'add':{const node=this.idFind(mutation.id);if(node){node.remove();node.ouid=undefined;}}}}
if(sideEffect){this.historySetSelection(step);}}
withoutRollback(callback){const priorRollback=this._toRollback;callback();this.observerFlush();if(!priorRollback){this._toRollback=false;}}
historyResetLatestComputedSelection(limitToEditable){const computedSelection=limitToEditable?this._latestComputedSelectionInEditable:this._latestComputedSelection;if(computedSelection&&computedSelection.anchorNode){const anchorNode=this.idFind(computedSelection.anchorNode.oid);const focusNode=this.idFind(computedSelection.focusNode.oid)||anchorNode;if(anchorNode){setSelection(anchorNode,computedSelection.anchorOffset,focusNode,computedSelection.focusOffset,);return true;}}
return false;}
historySetSelection(step){if(step.selection&&step.selection.anchorNodeOid){const anchorNode=this.idFind(step.selection.anchorNodeOid);const focusNode=this.idFind(step.selection.focusNodeOid)||anchorNode;if(anchorNode){setSelection(anchorNode,step.selection.anchorOffset,focusNode,step.selection.focusOffset!==undefined?step.selection.focusOffset:step.selection.anchorOffset,false,);this._handleSelectionInTable();}}}
unbreakableStepUnactive(){if(this._toRollback===UNBREAKABLE_ROLLBACK_CODE){this._toRollback=false;}
this._checkStepUnbreakable=false;}
historyPauseSteps(){this._historyStepsActive=false;}
historyUnpauseSteps(){this._historyStepsActive=true;}
historyStash(){if(!this._historyStashedMutations){this._historyStashedMutations=[];}
this._historyStashedMutations.push(...this._currentStep.mutations);this._currentStep.mutations=[];}
historyUnstash(){if(!this._currentStep.mutations){this._currentStep.mutations=[];}
this._currentStep.mutations.unshift(...this._historyStashedMutations);this._historyStashedMutations=[];}
_historyClean(){this._historySteps=[];this._currentStep={selection:{anchorNodeOid:undefined,anchorOffset:undefined,focusNodeOid:undefined,focusOffset:undefined,},mutations:[],id:undefined,clientId:undefined,};this._historyStepsStates=new Map();}
_historyGetSnapshotStep(){return{selection:{anchorNode:undefined,anchorOffset:undefined,focusNode:undefined,focusOffset:undefined,},mutations:Array.from(this.editable.childNodes).map(node=>({type:'add',append:1,id:node.oid,node:this.serializeNode(node),})),id:this._generateId(),clientId:this.clientId,previousStepId:undefined,};}
_historyMakeSnapshot(){if(!this._lastSnapshotHistoryLength||this._lastSnapshotHistoryLength<this._historySteps.length){this._lastSnapshotHistoryLength=this._historySteps.length;const step=this._historyGetSnapshotStep();step.id=this._historySteps[this._historySteps.length-1].id;const snapshot={time:Date.now(),step:step,};this._historySnapshots=[snapshot,this._historySnapshots[0]];}}
_historyAddExternalStep(newStep){let index=this._historySteps.length-1;while(index>=0&&this._historySteps[index].id!==newStep.previousStepId){if(this._historySteps[index].id===newStep.id){return;}
index--;}
if(index<0){if(this.options.onHistoryMissingParentSteps){const historySteps=this._historySteps;let index=historySteps.length-1;while(index!==0){if(historySteps[index].clientId===newStep.clientId){break;}
index--;}
const fromStepId=historySteps[index].id;this.options.onHistoryMissingParentSteps({step:newStep,fromStepId:fromStepId,});}
return;}
let concurentSteps=[];index++;while(index<this._historySteps.length){if(this._historySteps[index].previousStepId===newStep.previousStepId){if(this._historySteps[index].id.localeCompare(newStep.id)===1){break;}else{concurentSteps=[this._historySteps[index].id];}}else{if(concurentSteps.includes(this._historySteps[index].previousStepId)){concurentSteps.push(this._historySteps[index].id);}else{break;}}
index++;}
const stepsAfterNewStep=this._historySteps.slice(index);for(const stepToRevert of stepsAfterNewStep.slice().reverse()){this.historyRevert(stepToRevert,{sideEffect:false});}
this.historyApply(newStep.mutations);this._historySteps.splice(index,0,newStep);for(const stepToApply of stepsAfterNewStep){this.historyApply(stepToApply.mutations);}}
collaborationSetClientId(id){this._collabClientId=id;}
onExternalHistorySteps(newSteps){if(this._postProcessExternalStepsPromise){this._externalStepsBuffer.push(...newSteps);}
this.observerUnactive();this._computeHistorySelection();let stepIndex=0;for(const newStep of newSteps){this._historyAddExternalStep(newStep);stepIndex++;this._postProcessExternalStepsPromise=this.options.postProcessExternalSteps(this.editable);if(this._postProcessExternalStepsPromise){this._postProcessExternalStepsPromise.then(()=>{this._postProcessExternalStepsPromise=undefined;this.onExternalHistorySteps(this._externalStepsBuffer);});this._externalStepsBuffer=newSteps.slice(stepIndex);break;}}
this.observerActive();this.historyResetLatestComputedSelection();this._handleCommandHint();this.multiselectionRefresh();this.dispatchEvent(new Event('onExternalHistorySteps'));}
onExternalMultiselectionUpdate(selection){const{clientId}=selection;const currentInfo=this._collabSelectionInfos.get(clientId);if(currentInfo){currentInfo.selection=selection;}else{this._collabSelectionInfos.set(clientId,{selection});}
this._drawClientSelection(selection);this._drawClientAvatar(selection);this._updateAvatarCounters();}
multiselectionRefresh(){for(const{selection}of this._collabSelectionInfos.values()){this._drawClientSelection(selection);this._drawClientAvatar(selection);}
this._updateAvatarCounters();}
_drawClientSelection({selection,color,clientId,clientName=this.options._t('Anonymous')}){this._multiselectionRemoveClient(clientId);let clientRects;let anchorNode=this.idFind(selection.anchorNodeOid);let focusNode=this.idFind(selection.focusNodeOid);let anchorOffset=selection.anchorOffset;let focusOffset=selection.focusOffset;if(!anchorNode||!focusNode){anchorNode=this.editable.children[0];focusNode=this.editable.children[0];anchorOffset=0;focusOffset=0;}
[anchorNode,anchorOffset]=getDeepestPosition(anchorNode,anchorOffset);[focusNode,focusOffset]=getDeepestPosition(focusNode,focusOffset);const direction=getCursorDirection(anchorNode,anchorOffset,focusNode,focusOffset,);const range=new Range();try{if(direction===DIRECTIONS.RIGHT){range.setStart(anchorNode,anchorOffset);range.setEnd(focusNode,focusOffset);}else{range.setStart(focusNode,focusOffset);range.setEnd(anchorNode,anchorOffset);}
clientRects=Array.from(range.getClientRects());}catch{clientRects=[];}
if(!clientRects.length){return;}
const containerRect=this._selectionsContainer.getBoundingClientRect();const indicators=clientRects.map(({x,y,width,height})=>{const rectElement=this.document.createElement('div');rectElement.style=`
                position: absolute;
                top: ${y - containerRect.y}px;
                left: ${x - containerRect.x}px;
                width: ${width}px;
                height: ${height}px;
                background-color: ${color};
                opacity: 0.25;
                pointer-events: none;
            `;rectElement.setAttribute('data-selection-client-id',clientId);return rectElement;});const caretElement=this.document.createElement('div');caretElement.style=`border-left: 2px solid ${color}; position: absolute;`;caretElement.setAttribute('data-selection-client-id',clientId);caretElement.className='oe-collaboration-caret';const caretTopSquare=this.document.createElement('div');caretTopSquare.className='oe-collaboration-caret-top-square';caretTopSquare.style['background-color']=color;caretTopSquare.setAttribute('data-client-name',clientName);caretElement.append(caretTopSquare);if(direction===DIRECTIONS.LEFT){const rect=clientRects[0];caretElement.style.height=`${rect.height * 1.2}px`;caretElement.style.top=`${rect.y - containerRect.y}px`;caretElement.style.left=`${rect.x - containerRect.x}px`;}else{const rect=peek(clientRects);caretElement.style.height=`${rect.height * 1.2}px`;caretElement.style.top=`${rect.y - containerRect.y}px`;caretElement.style.left=`${rect.right - containerRect.x}px`;}
this._selectionsContainer.append(caretElement,...indicators);}
_drawClientAvatar({selection,clientId,clientAvatarUrl='',clientName=this.options._t('Anonymous')}){const anchorNode=this.idFind(selection.anchorNodeOid);const focusNode=this.idFind(selection.focusNodeOid);if(!anchorNode||!focusNode){return;}
const anchorBlock=closestBlock(anchorNode);if(!anchorBlock)return;const containerRect=this._avatarsContainer.getBoundingClientRect();const selectionInfo=this._collabSelectionInfos.get(clientId)||{};let avatarElement=selectionInfo.avatarElement;if(!avatarElement){avatarElement=this.document.createElement('div');avatarElement.className='oe-collaboration-caret-avatar';avatarElement.style.display='none';const image=this.document.createElement('img');avatarElement.append(image);image.onload=()=>avatarElement.style.removeProperty('display');image.setAttribute('src',clientAvatarUrl);image.classList.add('o_object_fit_cover');}
if(!avatarElement.parentElement){this._avatarsContainer.append(avatarElement);}
selectionInfo.avatarElement=avatarElement;selectionInfo.clientName=clientName;selectionInfo.avatarTargetElement=anchorBlock;this._collabSelectionInfos.set(clientId,selectionInfo);const anchorBlockRect=anchorBlock.getBoundingClientRect();const top=anchorBlockRect.y-containerRect.y;avatarElement.style.top=top+'px';const closestList=closestElement(anchorNode,'ul, ol');const anchorX=closestList?closestList.getBoundingClientRect().x:anchorBlockRect.x;const left=anchorX-containerRect.x-AVATAR_SIZE;avatarElement.style.left=left+'px';selectionInfo.avatarPositionKey=`${left}|${top}`;}
_updateAvatarCounters(){this._avatarsOverlaps={};for(const info of this._collabSelectionInfos.values()){const key=info.avatarPositionKey;this._avatarsOverlaps[key]=this._avatarsOverlaps[key]||new Set();this._avatarsOverlaps[key].add(info);}
this._avatarsCountersContainer.replaceChildren();for(const[overlapKey,infos]of Object.entries(this._avatarsOverlaps)){const size=infos.size;if(size>1){const[left,top]=overlapKey.split('|').map((n)=>parseInt(n,10));const div=document.createElement('div');div.className='oe-overlapping-counter';div.style.left=left+10+'px';div.style.top=top+10+'px';div.innerText=size;this._avatarsCountersContainer.append(div);}}}
multiselectionRemove(clientId){const selectionInfo=this._collabSelectionInfos.get(clientId);if(selectionInfo&&selectionInfo.avatarElement){selectionInfo.avatarElement.remove();}
this._multiselectionRemoveClient(clientId)
this._collabSelectionInfos.delete(clientId);this._updateAvatarCounters();}
_multiselectionRemoveClient(clientId){const elements=this._selectionsContainer.querySelectorAll(`[data-selection-client-id="${clientId}"]`,);for(const element of elements){element.remove();}}
execCommand(...args){this._computeHistorySelection();return this._applyCommand(...args);}
bindExecCommand(element){for(const buttonEl of element.querySelectorAll('[data-call]')){buttonEl.addEventListener('click',ev=>{if(!this.isSelectionInEditable()){this.historyResetLatestComputedSelection(true);}
const arg1=buttonEl.dataset.arg1;const args=arg1&&arg1.split(",")||[];this.execCommand(buttonEl.dataset.call,...args);ev.preventDefault();this._updateToolbar();});}}
deselectTable(){const tds=this.editable.querySelectorAll('.o_selected_table, .o_selected_td');if(!tds.length){return false;}
this.observerUnactive('deselectTable');for(const td of tds){td.classList.remove('o_selected_td','o_selected_table');if(!td.classList.length){td.removeAttribute('class');}}
this.observerActive('deselectTable');return true;}
activateContenteditable(){this.canActivateContentEditable=true;this._activateContenteditable();}
_removeDomListener(){for(const[element,eventName,boundCallback]of this._domListeners){element.removeEventListener(eventName,boundCallback);}
this._domListeners=[];}
deleteRange(sel){if(this.deleteTableRange()){return;}
let range=getDeepRange(this.editable,{sel,correctTripleClick:true});if(!range)return;for(const node of descendants(closestBlock(range.commonAncestorContainer))){if(node.nodeType===Node.TEXT_NODE&&[...node.textContent].every(char=>char==='\uFEFF')){const restore=prepareUpdate(...leftPos(node));node.remove();restore();}}
if(!this.editable.childElementCount){const p=document.createElement('p');p.append(document.createElement('br'));this.editable.append(p);setSelection(p,0);return;}
range=getDeepRange(this.editable,{sel,splitText:true,select:true,correctTripleClick:true,});if(!range)return;const commonAncestorContainer=this.editable.contains(range.commonAncestorContainer)?range.commonAncestorContainer:this.editable;const startUneditable=getFurthestUneditableParent(range.startContainer,commonAncestorContainer);if(startUneditable){let leaf=previousLeaf(startUneditable);if(leaf){range.setStart(leaf,nodeSize(leaf));}else{range.setStart(commonAncestorContainer,0);}}
const endUneditable=getFurthestUneditableParent(range.endContainer,commonAncestorContainer);if(endUneditable){let leaf=nextLeaf(endUneditable);if(leaf){range.setEnd(leaf,0);}else{range.setEnd(commonAncestorContainer,nodeSize(commonAncestorContainer));}}
let insertedZws;let{startContainer:start,startOffset,endContainer:end,endOffset}=range;const startBlock=closestBlock(start);const endBlock=closestBlock(end);const[firstLeafOfStartBlock,lastLeafOfEndBlock]=[firstLeaf(startBlock),lastLeaf(endBlock)];const startLink=closestElement(range.startContainer,'a');if(sel&&!sel.isCollapsed&&!range.startOffset&&!range.startContainer.previousSibling&&!startLink){const zws=document.createTextNode('\u200B');range.startContainer.before(zws);insertedZws=zws;}
const doJoin=!(startBlock===closestBlock(range.commonAncestorContainer)&&endBlock===closestBlock(range.commonAncestorContainer))&&(startBlock.tagName!=='TD'&&endBlock.tagName!=='TD')&&!(firstLeafOfStartBlock===start&&lastLeafOfEndBlock===end);let next=nextLeaf(end,this.editable);if(end.nodeType===Node.TEXT_NODE){splitTextNode(end,endOffset);endOffset=nodeSize(end);}
if(start.nodeType===Node.TEXT_NODE){splitTextNode(start,startOffset);startOffset=0;}
const restoreUpdate=prepareUpdate(...boundariesOut(start).slice(0,2),...boundariesOut(end).slice(2,4),{allowReenter:false,label:'deleteRange'});const contents=range.extractContents();setSelection(start,nodeSize(start));const startLi=closestElement(start,'li');if(startLi&&startLi.classList.contains('o_checked')&&['\u200B',''].includes(startLi.textContent)&&closestElement(end,'li')!==startLi){startLi.classList.remove('o_checked');}
range=getDeepRange(this.editable,{sel});[...contents.querySelectorAll('*')].filter(isUnremovable).forEach(n=>{closestBlock(range.endContainer).after(n);n.textContent='';});const isRemovableInvisible=node=>!isVisible(node)&&!isZWS(node)&&!isUnremovable(node);const endIsStart=end===start;while(end&&isRemovableInvisible(end)&&!end.contains(range.endContainer)){const parent=end.parentNode;end.remove();end=parent;}
while(start&&!isBlock(start)&&isRemovableInvisible(start)&&!(endIsStart&&start.contains(range.startContainer))){const parent=start.parentNode;start.remove();start=parent;}
if(start){if(start===this.editable&&startBlock.textContent==='\u200B'){const p=document.createElement('p');start.appendChild(p);start=p;}
fillEmpty(closestBlock(start));}
fillEmpty(closestBlock(range.endContainer));range=getDeepRange(this.editable,{sel});let joinWith=range.endContainer;const rightLeaf=rightLeafOnlyNotBlockPath(joinWith).next().value;if(rightLeaf&&rightLeaf.nodeValue===' '){joinWith=rightLeaf;}
while(doJoin&&next&&!(next.previousSibling&&next.previousSibling===joinWith)&&this.editable.contains(next)&&(closestElement(joinWith,'TD')===closestElement(next,'TD'))){const restore=preserveCursor(this.document);this.observerFlush();const res=this._protect(()=>{next.oDeleteBackward();if(!this.editable.contains(joinWith)){this._toRollback=UNREMOVABLE_ROLLBACK_CODE;}else{next=firstLeaf(next);}},this._currentStep.mutations.length);if([UNBREAKABLE_ROLLBACK_CODE,UNREMOVABLE_ROLLBACK_CODE].includes(res)){restore();break;}}
if(startBlock&&startBlock.textContent==='\u200B'&&endBlock&&startBlock!==endBlock&&!isEmptyBlock(endBlock)&&paragraphRelatedElements.includes(endBlock.nodeName)){startBlock.remove();setSelection(endBlock,0);fillEmpty(endBlock);}
if(insertedZws){const el=closestElement(insertedZws);const next=insertedZws.nextSibling;insertedZws.remove();el&&fillEmpty(el);setSelection(next,0);}
if(joinWith){const el=closestElement(joinWith);el&&fillEmpty(el);}
const restoreCursor=preserveCursor(this.document);restoreUpdate();restoreCursor();}
deleteTableRange(){const selectedTds=this.editable.querySelectorAll('.o_selected_td');const fullySelectedTables=[...this.editable.querySelectorAll('.o_selected_table')].filter(table=>([...table.querySelectorAll('td')].every(td=>td.classList.contains('o_selected_td'))));if(selectedTds.length&&!fullySelectedTables.length){this.historyPauseSteps();const rows=[...closestElement(selectedTds[0],'tr').parentElement.children].filter(child=>child.nodeName==='TR');const firstRowCells=[...rows[0].children].filter(child=>child.nodeName==='TD'||child.nodeName==='TH');const areFullColumnsSelected=getRowIndex(selectedTds[0])===0&&getRowIndex(selectedTds[selectedTds.length-1])===rows.length-1;const areFullRowsSelected=getColumnIndex(selectedTds[0])===0&&getColumnIndex(selectedTds[selectedTds.length-1])===firstRowCells.length-1;if(areFullColumnsSelected||areFullRowsSelected){if(areFullColumnsSelected){const startIndex=getColumnIndex(selectedTds[0]);let endIndex=getColumnIndex(selectedTds[selectedTds.length-1]);let currentIndex=startIndex;while(currentIndex<=endIndex){this.execCommand('removeColumn',firstRowCells[currentIndex]);currentIndex++;}}
if(areFullRowsSelected){const startIndex=getRowIndex(selectedTds[0]);let endIndex=getRowIndex(selectedTds[selectedTds.length-1]);let currentIndex=startIndex;while(currentIndex<=endIndex){this.execCommand('removeRow',rows[currentIndex]);currentIndex++;}}}else{for(const td of selectedTds){[...td.childNodes].forEach(child=>child.remove());td.append(document.createElement('br'));}}
this.historyUnpauseSteps();this.historyStep();return true;}else if(fullySelectedTables.length){fullySelectedTables.forEach(table=>table.remove());}
this._toggleTableUi();return false;}
updateColorpickerLabels(params={}){function hexFromColor(color){if(isColorGradient(color)){color=color.match(/gradient(.*)/)[0];let r=0,g=0,b=0,count=0;for(const entry of color.matchAll(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+(?:\.\d+)?))?\)/g)){count++;r+=parseInt(entry[1],10);g+=parseInt(entry[2],10);b+=parseInt(entry[3],10);}
color=`rgb(${Math.round(r / count)}, ${Math.round(g / count)}, ${Math.round(b / count)})`;}
return rgbToHex(color);}
let foreColor=params.foreColor;let hiliteColor=params.hiliteColor;const sel=this.document.getSelection();if(sel.rangeCount&&(!foreColor||!hiliteColor)){const endContainer=closestElement(sel.getRangeAt(0).endContainer);const computedStyle=getComputedStyle(endContainer);const backgroundImage=computedStyle.backgroundImage;const hasGradient=isColorGradient(backgroundImage);const hasTextGradientClass=endContainer.classList.contains('text-gradient');if(!foreColor){if(hasGradient&&hasTextGradientClass){foreColor=backgroundImage;}else{foreColor=this.document.queryCommandValue('foreColor');}}
if(!hiliteColor){if(hasGradient&&!hasTextGradientClass){hiliteColor=backgroundImage;}else{let ancestor=endContainer;while(ancestor&&!hiliteColor){hiliteColor=ancestor.style.backgroundColor;ancestor=ancestor.parentElement;}
if(!hiliteColor){hiliteColor=this.document.queryCommandValue('backColor');}}}}
foreColor=hexFromColor(foreColor);this.toolbar.style.setProperty('--fore-color',foreColor);const foreColorInput=this.toolbar.querySelector('#foreColor input');if(foreColorInput){foreColorInput.value=foreColor;}
hiliteColor=hexFromColor(hiliteColor);this.toolbar.style.setProperty('--hilite-color',hiliteColor);const hiliteColorInput=this.toolbar.querySelector('#hiliteColor input');if(hiliteColorInput){hiliteColorInput.value=hiliteColor.length<=7?hiliteColor:hexFromColor(hiliteColor);}}
_applyRawCommand(method,...args){const sel=this.document.getSelection();if(sel.anchorNode&&isProtected(sel.anchorNode)){return;}
if(!(SELECTIONLESS_COMMANDS.includes(method)&&args.length)&&!this.isSelectionInEditable(sel)&&!(closestElement(sel.anchorNode,"*[t-field],*[t-out],*[t-esc]")&&FORMATTING_COMMANDS.includes(method))){return false;}
if(!sel.isCollapsed&&BACKSPACE_FIRST_COMMANDS.includes(method)){let range=getDeepRange(this.editable,{sel,splitText:true,select:true,correctTripleClick:true});if(range&&range.startContainer===range.endContainer&&range.endContainer.nodeType===Node.TEXT_NODE&&ZERO_WIDTH_CHARS.includes(range.cloneContents().textContent)){sel.collapseToStart();if(BACKSPACE_ONLY_COMMANDS.includes(method)){this._applyRawCommand(method);}
return;}
this.deleteRange(sel);if(BACKSPACE_ONLY_COMMANDS.includes(method)){return true;}}
if(editorCommands[method]){return editorCommands[method](this,...args);}
if(method.startsWith('justify')){const mode=method.split('justify').join('').toLocaleLowerCase();return this._align(mode==='full'?'justify':mode);}
return sel.anchorNode[method](sel.anchorOffset,...args);}
_applyCommand(...args){this._recordHistorySelection(true);const result=this._protect(()=>this._applyRawCommand(...args));this.historyStep();this._handleCommandHint();return result;}
_protect(callback,rollbackCounter){try{const result=callback.call(this);this.observerFlush();if(this._toRollback){const torollbackCode=this._toRollback;this.historyRollback(rollbackCounter);return torollbackCode;}else{return result;}}catch(error){if(error===UNBREAKABLE_ROLLBACK_CODE||error===UNREMOVABLE_ROLLBACK_CODE){this.historyRollback(rollbackCounter);return error;}else{throw error;}}}
_activateContenteditable(){this.observerUnactive('_activateContenteditable');this.editable.setAttribute('contenteditable',this.options.isRootEditable);const editableAreas=this.options.getContentEditableAreas(this);for(const node of editableAreas){if(!node.isContentEditable){if(isArtificialVoidElement(node)||node.nodeName==='IMG'){node.classList.add('o_editable_media');}else{node.setAttribute('contenteditable',true);}}}
for(const node of this.options.getReadOnlyAreas()){node.setAttribute('contenteditable',false);}
for(const element of this.options.getUnremovableElements()){element.classList.add("oe_unremovable");}
this.observerActive('_activateContenteditable');}
_stopContenteditable(){this.observerUnactive('_stopContenteditable');if(this.options.isRootEditable){this.editable.setAttribute('contenteditable',!this.options.isRootEditable);}
for(const node of this.options.getContentEditableAreas(this)){if(node.getAttribute('contenteditable')==='true'){node.setAttribute('contenteditable',false);}}
this.observerActive('_stopContenteditable');}
_handleSelectionInTable(ev=undefined){const selection=this.document.getSelection();const anchorNode=selection&&selection.rangeCount&&selection.getRangeAt(0)&&selection.anchorNode;if(anchorNode&&!ancestors(anchorNode).includes(this.editable)){return false;}
const traversedNodes=getTraversedNodes(this.editable);if(this._isResizingTable||!traversedNodes.some(node=>!!closestElement(node,'td')&&!isProtected(node))){return false;}
let range;if(selection.rangeCount>1){const startRange=getDeepRange(this.editable,{range:selection.getRangeAt(0)});const endRange=getDeepRange(this.editable,{range:selection.getRangeAt(selection.rangeCount-1)});range=this.document.createRange();range.setStart(startRange.startContainer,0);range.setEnd(endRange.startContainer,0);}else{range=getDeepRange(this.editable,{correctTripleClick:anchorNode&&anchorNode.nodeName==='TR'});}
const startTd=closestElement(range.startContainer,'td');const endTd=closestElement(range.endContainer,'td');let appliedCustomSelection=false;const startTable=ancestors(range.startContainer,this.editable).filter(node=>node.nodeName==='TABLE').pop();const endTable=ancestors(range.endContainer,this.editable).filter(node=>node.nodeName==='TABLE').pop();if(startTd!==endTd&&startTable===endTable){if(!isProtected(startTable)){this._selectTableCells(range);appliedCustomSelection=true;}}else if(!traversedNodes.every(node=>node.parentElement&&closestElement(node.parentElement,'table'))){this.observerUnactive('handleSelectionInTable');const traversedTables=new Set(traversedNodes.map((node)=>closestElement(node,"table")).filter((node)=>!isProtected(node)));for(const table of traversedTables){if(table&&!ancestors(table,this.editable).some(node=>[...traversedTables].includes(node))){table.classList.toggle('o_selected_table',true);for(const td of[...table.querySelectorAll('td')].filter(td=>closestElement(td,'table')===table)){td.classList.toggle('o_selected_td',true);}
appliedCustomSelection=true;}}
this.observerActive('handleSelectionInTable');}else if(ev&&startTd&&!isProtected(startTd)){const selectedNodes=getSelectedNodes(this.editable);const cellContents=descendants(startTd);const areCellContentsFullySelected=cellContents.filter(d=>!isBlock(d)).every(child=>selectedNodes.includes(child));if(areCellContentsFullySelected){const SENSITIVITY=5;const rangeRect=range.getBoundingClientRect();const isMovingAwayFromSelection=ev.clientX>rangeRect.x+rangeRect.width+SENSITIVITY||ev.clientX<rangeRect.x-SENSITIVITY;if(isMovingAwayFromSelection){this._selectTableCells(range);appliedCustomSelection=true;}}else if(cellContents.filter(isBlock).every(isEmptyBlock)&&Math.abs(ev.clientX-(this._lastMouseClickPosition?this._lastMouseClickPosition[0]:ev.clientX))>=15){this._selectTableCells(range);appliedCustomSelection=true;}}
return appliedCustomSelection;}
_selectTableCells(range){const table=closestElement(range.commonAncestorContainer,'table');if(!table){return;}
this.observerUnactive('_selectTableCells');const alreadyHadSelection=table.classList.contains('o_selected_table');this.deselectTable();table.classList.toggle('o_selected_table',true);const columns=[...table.querySelectorAll('td')].filter(td=>closestElement(td,'table')===table);const startCol=[range.startContainer,...ancestors(range.startContainer,this.editable)].find(node=>node.nodeName==='TD'&&closestElement(node,'table')===table)||columns[0];const endCol=[range.endContainer,...ancestors(range.endContainer,this.editable)].find(node=>node.nodeName==='TD'&&closestElement(node,'table')===table)||columns[columns.length-1];const[startRow,endRow]=[closestElement(startCol,'tr'),closestElement(endCol,'tr')];const[startColIndex,endColIndex]=[getColumnIndex(startCol),getColumnIndex(endCol)];const[startRowIndex,endRowIndex]=[getRowIndex(startRow),getRowIndex(endRow)];const[minRowIndex,maxRowIndex]=[Math.min(startRowIndex,endRowIndex),Math.max(startRowIndex,endRowIndex)];const[minColIndex,maxColIndex]=[Math.min(startColIndex,endColIndex),Math.max(startColIndex,endColIndex)];const grid=[...table.querySelectorAll('tr')].filter(tr=>closestElement(tr,'table')===table).map(tr=>[...tr.children].filter(child=>child.nodeName==='TD'));for(const tds of grid.filter((_,index)=>index>=minRowIndex&&index<=maxRowIndex)){for(const td of tds.filter((_,index)=>index>=minColIndex&&index<=maxColIndex)){td.classList.toggle('o_selected_td',true);}}
if(!alreadyHadSelection){this.toolbarShow();}
this.observerActive('_selectTableCells');}
_isHoveringTdBorder(ev){if(ev.target&&ev.target.nodeName==='TD'&&ev.target.isContentEditable){const SENSITIVITY=5;const targetRect=ev.target.getBoundingClientRect();if(ev.clientX<=targetRect.x+SENSITIVITY){return'left';}else if(ev.clientY<=targetRect.y+SENSITIVITY){return'top';}else if(ev.clientX>=targetRect.x+ev.target.clientWidth-SENSITIVITY){return'right';}else if(ev.clientY>=targetRect.y+ev.target.clientHeight-SENSITIVITY){return'bottom';}}
return false;}
_toggleTableResizeCursor(direction){this.editable.classList.remove('o_col_resize','o_row_resize');if(direction==='col'){this.editable.classList.add('o_col_resize');}else if(direction==='row'){this.editable.classList.add('o_row_resize');}}
_resizeTable(ev,direction,target1,target2){ev.preventDefault();let position=target1?(target2?'middle':'last'):'first';let[item,neighbor]=[target1||target2,target2];const table=closestElement(item,'table');const[sizeProp,positionProp,clientPositionProp]=direction==='col'?['width','x','clientX']:['height','y','clientY'];const isRTL=this.options.direction==="rtl";if(sizeProp==='width'){const tableRect=table.getBoundingClientRect();table.style[sizeProp]=tableRect[sizeProp]+'px';}
const unsizedItemsSelector=`${direction === 'col' ? 'td' : 'tr'}:not([style*=${sizeProp}])`;for(const unsizedItem of table.querySelectorAll(unsizedItemsSelector)){unsizedItem.style[sizeProp]=unsizedItem.getBoundingClientRect()[sizeProp]+'px';}
if(direction==='col'){let hostCell=closestElement(table,'td');const hostCells=[];while(hostCell){hostCells.push(hostCell);hostCell=closestElement(hostCell.parentElement,'td');}
const nthColumn=getColumnIndex(item);const firstRow=[...table.querySelector('tr').children];[item,neighbor]=[firstRow[nthColumn],firstRow[nthColumn+1]];for(const td of hostCells){if(td!==item&&td!==neighbor&&closestElement(td,'table')===table&&getColumnIndex(td)!==0){td.style.removeProperty(sizeProp);}}
if(isRTL&&position=="middle"){[item,neighbor]=[neighbor,item];}}
const MIN_SIZE=33;switch(position){case'first':{const marginProp=direction==='col'?(isRTL?'marginRight':'marginLeft'):'marginTop';const itemRect=item.getBoundingClientRect();const tableStyle=getComputedStyle(table);const currentMargin=pxToFloat(tableStyle[marginProp]);let sizeDelta=itemRect[positionProp]-ev[clientPositionProp];if(direction==='col'&&isRTL){sizeDelta=ev[clientPositionProp]-itemRect[positionProp]-itemRect[sizeProp];}
const newMargin=currentMargin-sizeDelta;const currentSize=itemRect[sizeProp];const newSize=currentSize+sizeDelta;if(newMargin>=0&&newSize>MIN_SIZE){const tableRect=table.getBoundingClientRect();const hostCell=closestElement(table.parentElement,'td');const childTable=item.querySelector('table');const endProp=isRTL?'left':'right'
if(direction==='col'&&(hostCell&&tableRect[endProp]+sizeDelta>hostCell.getBoundingClientRect()[endProp]-5||childTable&&childTable.getBoundingClientRect()[endProp]>itemRect[endProp]+sizeDelta-5)){break;}
table.style[marginProp]=newMargin+'px';item.style[sizeProp]=newSize+'px';if(sizeProp==='width'){table.style[sizeProp]=tableRect[sizeProp]+sizeDelta+'px';}}
break;}
case'middle':{const[itemRect,neighborRect]=[item.getBoundingClientRect(),neighbor.getBoundingClientRect()];const[currentSize,newSize]=[itemRect[sizeProp],ev[clientPositionProp]-itemRect[positionProp]];const editableStyle=getComputedStyle(this.editable);const sizeDelta=newSize-currentSize;const currentNeighborSize=neighborRect[sizeProp];const newNeighborSize=currentNeighborSize-sizeDelta;const maxWidth=this.editable.clientWidth-pxToFloat(editableStyle.paddingLeft)-pxToFloat(editableStyle.paddingRight);const tableRect=table.getBoundingClientRect();if(newSize>MIN_SIZE&&(direction==='row'||newNeighborSize>MIN_SIZE||tableRect[sizeProp]+sizeDelta<maxWidth)){const childTable=item.querySelector('table');if(direction==='col'&&childTable&&childTable.getBoundingClientRect().right>itemRect.right+sizeDelta-5){break}
item.style[sizeProp]=newSize+'px';if(direction==='col'){neighbor.style[sizeProp]=(newNeighborSize>MIN_SIZE?newNeighborSize:currentNeighborSize)+'px';}else if(sizeProp==='width'){table.style[sizeProp]=tableRect[sizeProp]+sizeDelta+'px';}}
break;}
case'last':{const itemRect=item.getBoundingClientRect();let sizeDelta=ev[clientPositionProp]-(itemRect[positionProp]+itemRect[sizeProp]);if(direction==='col'&&isRTL){sizeDelta=itemRect[positionProp]-ev[clientPositionProp];}
const currentSize=itemRect[sizeProp];const newSize=currentSize+sizeDelta;if((newSize>=0||direction==='row')&&newSize>MIN_SIZE){const tableRect=table.getBoundingClientRect();const hostCell=closestElement(table.parentElement,'td');const childTable=item.querySelector('table');const endProp=isRTL?'left':'right'
if(direction==='col'&&(hostCell&&tableRect[endProp]+sizeDelta>hostCell.getBoundingClientRect()[endProp]-5||childTable&&childTable.getBoundingClientRect()[endProp]>itemRect[endProp]+sizeDelta-5)){break}
if(sizeProp==='width'){table.style[sizeProp]=tableRect[sizeProp]+sizeDelta+'px';}
item.style[sizeProp]=newSize+'px';}
break;}}}
_toggleTableUi(row=false,column=false){if(row){this._rowUi.style.visibility='visible';this._rowUiTarget=row;this._positionTableUi(row);}else{this._rowUi.style.visibility='hidden';}
if(column){this._columnUi.style.visibility='visible';this._columnUiTarget=column;this._positionTableUi(column);}else{this._columnUi.style.visibility='hidden';}
if(row||column){this._tableUiTarget=closestElement(row||column,'table');this._tableUiTarget&&this._tableUiTarget.addEventListener('mouseleave',()=>this._toggleTableUi(),{once:true});}}
_positionTableUi(element){if(!element.isConnected){return;}
const tableUiContainerRect=this._tableUiContainer.getBoundingClientRect();const isRtl=this.options.direction==='rtl';const isRow=element.nodeName==='TR';const ui=isRow?this._rowUi:this._columnUi;const elementRect=element.getBoundingClientRect();const wrappedUi=ui.firstElementChild;const table=closestElement(element,'table');const tableRect=table&&table.getBoundingClientRect();const resetTableSize=ui.querySelector('.o_reset_table_size');if(table&&!table.hasAttribute('style')){resetTableSize.classList.add('d-none');}else{resetTableSize.classList.remove('d-none');}
let left;let top;if(isRow){if(isRtl){left=tableRect.right-tableUiContainerRect.x;}else{left=elementRect.left-tableUiContainerRect.left-wrappedUi.clientWidth;}}else if(isRtl){left=elementRect.left-tableUiContainerRect.left+wrappedUi.clientWidth;}else{left=elementRect.left-tableUiContainerRect.left-(isRow?wrappedUi.clientWidth:0);}
top=elementRect.top-tableUiContainerRect.top-(isRow?0:wrappedUi.clientHeight);ui.style.left=left+'px';ui.style.top=top+'px';wrappedUi.style[isRow?'height':'width']=elementRect[isRow?'height':'width']+'px';}
_computeHistorySelection(){const sel=this.document.getSelection();if(!(sel&&sel.anchorNode)){return this._latestComputedSelection;}
this._latestComputedSelection={anchorNode:sel.anchorNode,anchorOffset:sel.anchorOffset,focusNode:sel.focusNode,focusOffset:sel.focusOffset,};if(this.isSelectionInEditable(sel)){this._latestComputedSelectionInEditable=this._latestComputedSelection;}
return this._latestComputedSelection;}
_recordHistorySelection(useCache=false){this._currentStep.selection=serializeSelection(useCache?this._latestComputedSelection:this._computeHistorySelection(),)||{};}
_isLatestComputedSelectionInsideEmptyInlineTag(){if(!this._latestComputedSelection){return false;}
const anchorNode=this._latestComputedSelection.anchorNode;const focusNode=this._latestComputedSelection.focusNode;const parentTextContent=anchorNode.parentElement?anchorNode.parentElement.textContent:null;return anchorNode===focusNode&&(['',...ZERO_WIDTH_CHARS].includes(parentTextContent))}
_getNextUndoIndex(){for(let index=this._historySteps.length-1;index>=0;index--){if(this._historySteps[index]&&this._historySteps[index].clientId===this._collabClientId){const state=this._historyStepsStates.get(this._historySteps[index].id);if(state==='redo'||!state){return index;}}}
return-1;}
_getNextRedoIndex(){let totalConsumed=0;for(let index=this._historySteps.length-1;index>=0;index--){if(this._historySteps[index]&&this._historySteps[index].clientId===this._collabClientId){const state=this._historyStepsStates.get(this._historySteps[index].id);switch(state){case'undo':return totalConsumed<=0?index:-1;case'redo':totalConsumed-=1;break;case'consumed':totalConsumed+=1;break;default:return-1;}}}
return-1;}
historyRevertUntil(toStepIndex){const lastStep=this._currentStep;this.historyRevert(lastStep);let stepIndex=this._historySteps.length-1;while(stepIndex>toStepIndex){const step=this._historySteps[stepIndex];const stepState=this._historyStepsStates.get(step.id);if(step.clientId===this._collabClientId&&stepState!=='consumed'){this.historyRevert(this._historySteps[stepIndex]);this._historyStepsStates.set(''+step.id,'consumed');}
stepIndex--;}}
toolbarHide(){this._updateToolbar(false);}
toolbarShow(){this._updateToolbar(true);}
_updateToolbar(show){if(!this.toolbar){return;}
if(!this.autohideToolbar&&this.toolbar.style.visibility!=='visible'){this.toolbar.style.visibility='visible';}
const sel=this.document.getSelection();if(!hasTableSelection(this.editable)){if(this.editable.classList.contains('o_col_resize')||this.editable.classList.contains('o_row_resize')){show=false;}
if(!sel.anchorNode){show=false;}else{const selAncestors=[sel.anchorNode,...ancestors(sel.anchorNode,this.editable)];const isInStars=selAncestors.some(node=>node.classList&&node.classList.contains('o_stars'));if(isInStars){show=false;}}}
if(this.autohideToolbar&&!this.toolbar.contains(sel.anchorNode)){if(!this.isMobile){if(this.powerboxTablePicker.el.style.display==='block'){this.toolbar.style.visibility='hidden';return;}
if(show!==undefined){this.toolbar.style.visibility=show?'visible':'hidden';}
if(show===false){for(const menu of this.toolbar.querySelectorAll('.dropdown-menu.show')){menu.parentElement?.querySelector('[data-bs-toggle="dropdown"]')?.click();};return;}}}
if(!this.isSelectionInEditable(sel)){return;}
const paragraphDropdownButton=this.toolbar.querySelector('#paragraphDropdownButton');if(paragraphDropdownButton){for(const commandState of['justifyLeft','justifyRight','justifyCenter','justifyFull',]){const button=this.toolbar.querySelector('#'+commandState);const direction=commandState==='justifyFull'?'justify':commandState.replace('justify','').toLowerCase();let isStateTrue=false;const link=sel.anchorNode&&closestElement(sel.anchorNode,'a');const linkBlock=link&&closestBlock(link);if(linkBlock){const alignment=getComputedStyle(linkBlock).textAlign;isStateTrue=alignment===direction;}else{isStateTrue=this.document.queryCommandState(commandState)}
button.classList.toggle('active',isStateTrue);const newClass=`fa-align-${direction}`;paragraphDropdownButton.classList.toggle(newClass,isStateTrue);}}
if(sel.rangeCount){for(const format of['bold','italic','underline','strikeThrough','switchDirection']){const formatButton=this.toolbar.querySelector(`#${format.toLowerCase()}`);if(formatButton){formatButton.classList.toggle('active',isSelectionFormat(this.editable,format));}}
const fontSizeEl=this.toolbar.querySelector("#fontSizeCurrentValue");if(fontSizeEl){fontSizeEl.value=Math.round(getFontSizeDisplayValue(sel,this.options.getCSSVariableValue,this.options.convertNumericToUnit));}
const table=getInSelection(this.document,'table');const toolbarButton=this.toolbar.querySelector('.toolbar-edit-table');if(toolbarButton){this.toolbar.querySelector('.toolbar-edit-table').style.display=table?'block':'none';}}
this.updateColorpickerLabels();const listUIClasses={UL:'fa-list-ul',OL:'fa-list-ol',CL:'fa-tasks'};const block=closestBlock(sel.anchorNode);let activeLabel=undefined;for(const[style,cssSelector,isList]of[['paragraph','p:not(.small, .lead, .o_small)',false],['pre','pre',false],['heading1','h1:not(.display-1, .display-2, .display-3, .display-4)',false],['heading2','h2',false],['heading3','h3',false],['heading4','h4',false],['heading5','h5',false],['heading6','h6',false],['display-1','h1.display-1',false],['display-2','h1.display-2',false],['display-3','h1.display-3',false],['display-4','h1.display-4',false],['blockquote','blockquote',false],['small','.small, .o_small',false],['light','.lead',false],['unordered','UL',true],['ordered','OL',true],['checklist','CL',true],]){const button=this.toolbar.querySelector('#'+style);if(button&&!block){button.classList.toggle('active',false);}else if(button){const isActive=isList?block.tagName==='LI'&&getListMode(block.parentElement)===cssSelector:block.matches(cssSelector);button.classList.toggle('active',isActive);if(!isList&&isActive){activeLabel=button.textContent;}}}
if(block){const listMode=getListMode(block.parentElement);const listDropdownButton=this.toolbar.querySelector('#listDropdownButton');if(listDropdownButton){if(listMode){listDropdownButton.classList.remove('fa-list-ul','fa-list-ol','fa-tasks');listDropdownButton.classList.add(listUIClasses[listMode]);}
listDropdownButton.closest('button').classList.toggle('active',block.tagName==='LI');}}
const styleSection=this.toolbar.querySelector('#style');if(styleSection){if(!activeLabel){const firstButtonEl=styleSection.querySelector('#paragraph');firstButtonEl.classList.add('active');activeLabel=firstButtonEl.textContent;}
styleSection.querySelector('button span').textContent=activeLabel;}
const isInMedia=this.toolbar.classList.contains('oe-media');const linkNode=getInSelection(this.document,'a');const linkButton=this.toolbar.querySelector('#create-link');linkButton&&linkButton.classList.toggle('active',!!linkNode);const unlinkButton=this.toolbar.querySelector('#unlink');unlinkButton?.classList.toggle('d-none',isInMedia||!linkNode);const undoButton=this.toolbar.querySelector('#undo');undoButton&&undoButton.classList.toggle('disabled',!this.historyCanUndo());const redoButton=this.toolbar.querySelector('#redo');redoButton&&redoButton.classList.toggle('disabled',!this.historyCanRedo());const range=getDeepRange(this.editable,{sel,correctTripleClick:true});const spansBlocks=[...range.commonAncestorContainer.childNodes].some(isBlock);linkButton?.classList.toggle('d-none',spansBlocks||isInMedia);const linkBtnGroup=this.toolbar.querySelector('#link.btn-group');linkBtnGroup?.classList.toggle('d-none',!linkBtnGroup.querySelector('.btn:not(.d-none)'));if(this.autohideToolbar&&!this.isMobile&&!this.toolbar.contains(sel.anchorNode)){this._positionToolbar();}}
updateToolbarPosition(){if(this.autohideToolbar&&!this.isMobile&&getComputedStyle(this.toolbar).visibility==='visible'){this._positionToolbar();}}
_positionToolbar(){const OFFSET=10;let isBottom=false;this.toolbar.classList.toggle('d-none',false);this.toolbar.style.maxWidth=window.innerWidth-OFFSET*2+'px';const sel=this.document.getSelection();const range=sel.getRangeAt(0);const isSelForward=sel.anchorNode===range.startContainer&&sel.anchorOffset===range.startOffset;const startRect=range.startContainer.getBoundingClientRect&&range.startContainer.getBoundingClientRect();const selRect=range.getBoundingClientRect();const isSelectionPotentiallyBugged=[selRect.x,selRect.y,selRect.width,selRect.height].every(x=>x===0);let correctedSelectionRect=isSelectionPotentiallyBugged&&startRect?startRect:selRect;const selAncestors=[sel.anchorNode,...ancestors(sel.anchorNode,this.editable)];const selectedTable=selAncestors.find(node=>node.classList&&node.classList.contains('o_selected_table'));if(selectedTable){correctedSelectionRect=selectedTable.getBoundingClientRect();}
const toolbarWidth=this.toolbar.offsetWidth;const toolbarHeight=this.toolbar.offsetHeight;const editorRect=this.editable.getBoundingClientRect();const parentContextRect=this.options.getContextFromParentRect();const scrollContainerRect=this.options.getScrollContainerRect();const editorTopPos=Math.max(0,editorRect.top);const scrollX=document.defaultView.scrollX;const scrollY=document.defaultView.scrollY;let left=correctedSelectionRect.left+OFFSET;left=Math.max(OFFSET,left);left=Math.min(window.innerWidth-OFFSET-toolbarWidth,left);const adjustedLeft=left+parentContextRect.left;this.toolbar.style.left=scrollX+adjustedLeft+'px';let top=correctedSelectionRect.top-toolbarHeight-OFFSET;if(top<editorTopPos||top+parentContextRect.top-scrollContainerRect.top<OFFSET/2){top=correctedSelectionRect.bottom+OFFSET;isBottom=true;}
top+=parentContextRect.top;this.toolbar.style.top=scrollY+top+'px';let arrowLeftPos=(isSelForward&&!isSelectionPotentiallyBugged?correctedSelectionRect.right:correctedSelectionRect.left)-left-OFFSET;arrowLeftPos=Math.max(OFFSET,arrowLeftPos);arrowLeftPos=Math.min(toolbarWidth-OFFSET-20,arrowLeftPos);this.toolbar.style.setProperty('--arrow-left-pos',arrowLeftPos+'px');const arrowTopPos=isBottom?-17:toolbarHeight-3;this.toolbar.classList.toggle('toolbar-bottom',isBottom);this.toolbar.style.setProperty('--arrow-top-pos',arrowTopPos+'px');const toolbarTop=Math.min(top,top+arrowTopPos);const toolbarBottom=Math.max(top+toolbarHeight,top+arrowTopPos+20);const distToScrollContainer=Math.min(toolbarTop-scrollContainerRect.top,scrollContainerRect.bottom-toolbarBottom);this.toolbar.classList.toggle('d-none',distToScrollContainer<OFFSET/2);}
_prepareClipboardData(clipboardData){const container=document.createElement('fake-container');container.append(parseHTML(this.document,clipboardData));for(const tableElement of container.querySelectorAll('table')){tableElement.classList.add('table','table-bordered','o_table');}
const progId=container.querySelector('meta[name="ProgId"]')
if(progId&&progId.content==='Excel.Sheet'){const xlStylesheet=container.querySelector('style');const xlNodes=container.querySelectorAll("[class*=xl],[class*=font]");for(const xlNode of xlNodes){for(const xlClass of xlNode.classList){const xlStyle=xlStylesheet.textContent.match(`.${xlClass}[^\{]*\{(?<xlStyle>[^\}]*)\}`).groups.xlStyle.replace('background:','background-color:');xlNode.setAttribute('style',xlNode.style.cssText+';'+xlStyle)}}}
for(const child of[...container.childNodes]){this._cleanForPaste(child);}
const fragment=document.createDocumentFragment();let p=document.createElement('p');for(const child of[...container.childNodes]){if(isBlock(child)){if(p.childNodes.length>0){fragment.appendChild(p);p=document.createElement('p');}
fragment.appendChild(child);}else{p.appendChild(child);}
if(p.childNodes.length>0){fragment.appendChild(p);}}
const brs=fragment.querySelectorAll('br');for(const br of brs){const block=closestBlock(br);if(['P','H1','H2','H3','H4','H5','H6'].includes(block.nodeName)&&!block.closest('li')){const isEmptyLine=block.firstChild.nodeName==='BR';const remainingBrContainer=splitAroundUntil(br,block);if(!isEmptyLine){remainingBrContainer.remove();}}}
return fragment;}
_cleanForPaste(node){if(!this._isWhitelisted(node)||this._isBlacklisted(node)||node.id&&node.id.startsWith('docs-internal-guid')){if(!node.matches||node.matches(CLIPBOARD_BLACKLISTS.remove.join(','))){node.remove();}else{for(const unwrappedNode of unwrapContents(node)){this._cleanForPaste(unwrappedNode);}}}else if(node.nodeType!==Node.TEXT_NODE){if(node.nodeName==='TD'){if(node.hasAttribute('bgcolor')&&!node.style['background-color']){node.style['background-color']=node.getAttribute('bgcolor');}}else if(node.nodeName==='FONT'){if(node.hasAttribute('color')&&!node.style['color']){node.style['color']=node.getAttribute('color');}
if(node.hasAttribute('size')&&!node.style['font-size']){node.style['font-size']=+node.getAttribute('size')+10+'pt';}}else if(['S','U'].includes(node.nodeName)&&node.childNodes.length===1&&node.firstChild.nodeName==='FONT'){const fontNode=node.firstChild;node.before(fontNode);node.replaceChildren(...fontNode.childNodes);fontNode.appendChild(node);}
for(const attribute of[...node.attributes]){if(CLIPBOARD_WHITELISTS.styledTags.includes(node.nodeName)&&attribute.name==='style'){node.removeAttribute(attribute.name);if(['SPAN','FONT'].includes(node.tagName)){for(const unwrappedNode of unwrapContents(node)){this._cleanForPaste(unwrappedNode);}}}else if(!this._isWhitelisted(attribute)){node.removeAttribute(attribute.name);}}
for(const klass of[...node.classList]){if(!this._isWhitelisted(klass)){node.classList.remove(klass);}}
for(const child of[...node.childNodes]){this._cleanForPaste(child);}}}
_isWhitelisted(item){if(item instanceof Attr){return CLIPBOARD_WHITELISTS.attributes.includes(item.name);}else if(typeof item==='string'){return CLIPBOARD_WHITELISTS.classes.some(okClass=>okClass instanceof RegExp?okClass.test(item):okClass===item,);}else{return(item.nodeType===Node.TEXT_NODE||(item.matches&&item.matches(CLIPBOARD_WHITELISTS.nodes)));}}
_isBlacklisted(node){return(node.nodeType!==Node.TEXT_NODE&&node.matches([].concat(...Object.values(CLIPBOARD_BLACKLISTS)).join(',')));}
_safeSetAttribute(node,attributeName,attributeValue){const clone=document.createElement(node.tagName);clone.setAttribute(attributeName,attributeValue);DOMPurify.sanitize(clone,{IN_PLACE:true});if(clone.hasAttribute(attributeName)){node.setAttribute(attributeName,clone.getAttribute(attributeName));}else{node.removeAttribute(attributeName);}}
disableAvatarForElement(element){this.enableAvatars();for(const info of this._collabSelectionInfos.values()){if(info.avatarTargetElement===element){if(!info.avatarElement.classList.contains('opacity-0')){info.avatarElement.classList.add('opacity-0');}}}}
enableAvatars(){for(const element of this._avatarsContainer.querySelectorAll('.oe-collaboration-caret-avatar.opacity-0')){element.classList.remove('opacity-0');}}
_onBeforeInput(ev){this._lastBeforeInputType=ev.inputType;if(ev.inputType==="insertParagraph"){const banner=closestElement(ev.target,".o_editor_banner");if(banner&&closestElement(banner,"ul, ol")){ev.preventDefault();this._onInput(ev);return;}}}
_onInput(ev){const newSelection=this.document.getSelection();if(newSelection.anchorNode&&isProtected(newSelection.anchorNode)){return;}
const shouldOpenPowerbox=newSelection.isCollapsed&&newSelection.rangeCount&&ev.data==='/'&&this.powerbox&&!this.powerbox.isOpen&&(!this.options.getPowerboxElement||!!this.options.getPowerboxElement());if(shouldOpenPowerbox){this._powerboxBeforeStepIndex=this._historySteps.length-1;}
this._recordHistorySelection(true);const selection=this._currentStep.selection;const{anchorNodeOid,anchorOffset,focusNodeOid,focusOffset}=selection||{};const wasCollapsed=!selection||(focusNodeOid===anchorNodeOid&&focusOffset===anchorOffset);const isChromeDeleteforward=ev.inputType==='insertText'&&ev.data===null&&this._lastBeforeInputType==='deleteContentForward';const isChromeInsertParagraph=ev.inputType==='insertText'&&ev.data===null&&this._lastBeforeInputType==='insertParagraph';const isCompositionEvent=ev.inputType==="insertCompositionText"||(ev.inputType==="insertText"&&(this.keyboardType===KEYBOARD_TYPES.VIRTUAL||this.isMobile));if(isCompositionEvent){this._fromCompositionText=true;}
if(this.keyboardType===KEYBOARD_TYPES.PHYSICAL||!wasCollapsed){const anchorNode=this.idFind(anchorNodeOid);const focusNode=this.idFind(focusNodeOid);const wasSelectingAcrossDifferentBlocks=anchorNode&&focusNode&&closestBlock(anchorNode)!==closestBlock(focusNode);const shouldInterveneForDeletion=!this._fromCompositionText||wasSelectingAcrossDifferentBlocks;if(ev.inputType==='deleteContentBackward'&&shouldInterveneForDeletion){this._compositionStep();this.historyRollback();ev.preventDefault();this._applyCommand('oDeleteBackward');}else if((ev.inputType==='deleteContentForward'||isChromeDeleteforward)&&shouldInterveneForDeletion){this._compositionStep();this.historyRollback();ev.preventDefault();this._applyCommand('oDeleteForward');}else if((ev.inputType==='insertParagraph'||isChromeInsertParagraph)){this._compositionStep();this.historyRollback();ev.preventDefault();this._handleAutomaticLinkInsertion();if(this._applyCommand('oEnter')===UNBREAKABLE_ROLLBACK_CODE){this._applyCommand('oShiftEnter');}}else if(['insertText','insertCompositionText'].includes(ev.inputType)){const selection=this.document.getSelection();const isUnitTests=!ev.isTrusted&&this.testMode;const latestSelectionInsideEmptyTag=this._isLatestComputedSelectionInsideEmptyInlineTag();const shouldInterveneForInsertion=!wasCollapsed&&shouldInterveneForDeletion;if(shouldInterveneForInsertion||latestSelectionInsideEmptyTag||isUnitTests){ev.preventDefault();if(!isUnitTests){this._protect(()=>this._applyRawCommand('oDeleteBackward'));}
if(latestSelectionInsideEmptyTag){const selectionBackup=this._latestComputedSelection;setSelection(selectionBackup.anchorNode,selectionBackup.anchorOffset);}
insertText(selection,ev.data===null?ev.dataTransfer.getData('text/plain'):ev.data);selection.collapseToEnd();}
if(ev.data==='`'&&!closestElement(selection.anchorNode,'code')){const range=getDeepRange(this.editable);let textNode=range.startContainer;let offset=range.startOffset;let sibling=textNode.previousSibling;while(sibling&&sibling.nodeType===Node.TEXT_NODE){offset+=sibling.textContent.length;sibling.textContent+=textNode.textContent;textNode.remove();textNode=sibling;sibling=textNode.previousSibling;}
sibling=textNode.nextSibling;while(sibling&&sibling.nodeType===Node.TEXT_NODE){textNode.textContent+=sibling.textContent;sibling.remove();sibling=textNode.nextSibling;}
setSelection(textNode,offset);const textHasTwoTicks=/`.*`/.test(textNode.textContent);if(textHasTwoTicks){this.historyStep();const insertedBacktickIndex=offset-1;const textBeforeInsertedBacktick=textNode.textContent.substring(0,insertedBacktickIndex-1);let startOffset,endOffset;const isClosingForward=textBeforeInsertedBacktick.includes('`');if(isClosingForward){startOffset=textBeforeInsertedBacktick.lastIndexOf('`');endOffset=insertedBacktickIndex;}else{const textAfterInsertedBacktick=textNode.textContent.substring(offset);startOffset=insertedBacktickIndex;endOffset=offset+textAfterInsertedBacktick.indexOf('`');}
if(endOffset&&endOffset<textNode.textContent.length){splitTextNode(textNode,endOffset+1,DIRECTIONS.LEFT);}
if(startOffset){splitTextNode(textNode,startOffset);}
textNode.textContent=textNode.textContent.substring(1,textNode.textContent.length-1);const codeElement=this.document.createElement('code');codeElement.classList.add('o_inline_code');textNode.before(codeElement);codeElement.append(textNode);if(!codeElement.previousSibling||codeElement.previousSibling.nodeType!==Node.TEXT_NODE){codeElement.before(document.createTextNode('\u200B'));}
if(isClosingForward){codeElement.after(document.createTextNode('\u200B'));setSelection(codeElement.nextSibling,1);}else{setSelection(codeElement.firstChild,0);}}}
this.historyStep();}else{this.historyStep();}}
if(!isCompositionEvent){this._fromCompositionText=false;}
if(shouldOpenPowerbox){this._isPowerboxOpenOnInput=true;this.powerbox.open();}}
_onClipboardCut(clipboardEvent){this._onClipboardCopy(clipboardEvent);this._recordHistorySelection();this.deleteRange();this.historyStep();}
_onClipboardCopy(clipboardEvent){if(!this.isSelectionInEditable()){return;}
clipboardEvent.preventDefault();const selection=this.document.getSelection();const range=selection.getRangeAt(0);let rangeContent=range.cloneContents();if(!rangeContent.hasChildNodes()){return;}
if(rangeContent.firstChild.nodeName==='LI'){const list=range.commonAncestorContainer.cloneNode();list.replaceChildren(...rangeContent.childNodes);rangeContent=list;}
if(rangeContent.firstChild.nodeName==='TR'||rangeContent.firstChild.nodeName==='TD'){const table=closestElement(range.commonAncestorContainer,'table');const tableClone=table.cloneNode(true);const isTableFullySelected=table.parentElement&&!!closestElement(table.parentElement,'td.o_selected_td')||[...table.querySelectorAll('td')].filter(td=>closestElement(td,'table')===table).every(td=>td.classList.contains('o_selected_td'));if(!isTableFullySelected){for(const td of tableClone.querySelectorAll('td:not(.o_selected_td)')){if(closestElement(td,'table')===tableClone){td.remove();}}
const trsWithoutTd=Array.from(tableClone.querySelectorAll('tr')).filter(row=>!row.querySelector('td'));for(const tr of trsWithoutTd){if(closestElement(tr,'table')===tableClone){tr.remove();}}}
rangeContent=tableClone;}
const table=closestElement(range.startContainer,'table');if(rangeContent.firstChild.nodeName==='TABLE'&&table){rangeContent.firstChild.after(table.cloneNode(true));rangeContent.firstChild.remove();}
if(rangeContent.lastChild.nodeName==='TABLE'){rangeContent.lastChild.before(closestElement(range.endContainer,'table').cloneNode(true));rangeContent.lastChild.remove();}
const commonAncestorElement=closestElement(range.commonAncestorContainer);if(commonAncestorElement&&!isBlock(rangeContent.firstChild)){const blockEl=closestBlock(commonAncestorElement);const ancestorsList=[commonAncestorElement,...ancestors(commonAncestorElement,blockEl)];for(const ancestor of ancestorsList){if(!isBlock(ancestor)||paragraphRelatedElements.includes(ancestor.nodeName)){const clone=ancestor.cloneNode();clone.append(...rangeContent.childNodes);rangeContent.appendChild(clone);}}}
const dataHtmlElement=document.createElement('data');dataHtmlElement.append(rangeContent);const odooHtml=dataHtmlElement.innerHTML;const odooText=selection.toString();clipboardEvent.clipboardData.setData('text/plain',odooText);clipboardEvent.clipboardData.setData('text/html',odooHtml);clipboardEvent.clipboardData.setData('text/odoo-editor',odooHtml);}
_onKeyDown(ev){const selection=this.document.getSelection();if(selection.anchorNode&&isProtected(selection.anchorNode)){return;}
this.keyboardType=ev.key==='Unidentified'?KEYBOARD_TYPES.VIRTUAL:KEYBOARD_TYPES.PHYSICAL;this._currentKeyPress=ev.key;if(/^.$/u.test(ev.key)&&!ev.ctrlKey&&!ev.metaKey&&(isMacOS()||!ev.altKey)){const selection=this.document.getSelection();if(selection&&!selection.isCollapsed&&this.isSelectionInEditable(selection)){this.deleteRange(selection);}}
if(ev.key==='Backspace'){const selection=this.document.getSelection();if(!ev.ctrlKey&&!ev.metaKey){if(selection.isCollapsed&&!this._fromCompositionText){ev.preventDefault();this._applyCommand('oDeleteBackward');}}else if(selection.isCollapsed&&selection.anchorNode){const anchor=(selection.anchorNode.nodeType!==Node.TEXT_NODE&&selection.anchorOffset)?selection.anchorNode[selection.anchorOffset]:selection.anchorNode;const element=closestBlock(anchor);if(isEmptyBlock(element)&&element.parentElement.children.length===1){ev.preventDefault();if(element.tagName!=='P'){const paragraph=this.document.createElement('P');const br=this.document.createElement('BR');paragraph.append(br);element.before(paragraph);const result=this._protect(()=>element.remove());if(result!==UNBREAKABLE_ROLLBACK_CODE&&result!==UNREMOVABLE_ROLLBACK_CODE){setCursorStart(paragraph);this.historyStep();}}}}}else if(ev.key==='Tab'){const tabHtml='<span class="oe-tabs" contenteditable="false">\u0009</span>\u200B';const sel=this.document.getSelection();const closestLi=closestElement(sel.anchorNode,'li');if(closestElement(sel.anchorNode,'table')&&!closestLi){this._onTabulationInTable(ev);}else if(!ev.shiftKey&&sel.isCollapsed&&!closestLi){this.execCommand('insert',parseHTML(this.document,tabHtml));}else{const listItems=new Set();const nonListItems=new Set();for(const node of getTraversedNodes(this.editable)){const closestLi=closestElement(node,'li');const target=closestLi||node;if(!(target.querySelector&&target.querySelector('li'))){if(closestLi){listItems.add(closestLi);}else{nonListItems.add(node);}}}
const restore=preserveCursor(this.document);for(const listItem of listItems){if(ev.shiftKey){listItem.oShiftTab(0);}else{listItem.oTab(0);}}
if(ev.shiftKey){const editorTabs=new Set([...nonListItems].map(node=>{const block=closestBlock(node);return descendants(block).find(child=>isEditorTab(child));}).filter(node=>(node&&!getAdjacentPreviousSiblings(node).some(sibling=>(sibling.nodeType===Node.TEXT_NODE&&!/^[\u200B\s]*$/.test(sibling.textContent))))));for(const tab of editorTabs){let{anchorNode,anchorOffset,focusNode,focusOffset}=sel;const updateAnchor=anchorNode===tab.nextSibling;const updateFocus=focusNode===tab.nextSibling;let zwsRemoved=0;while(tab.nextSibling&&tab.nextSibling.nodeType===Node.TEXT_NODE&&tab.nextSibling.textContent.startsWith('\u200B')){splitTextNode(tab.nextSibling,1,DIRECTIONS.LEFT);tab.nextSibling.remove();zwsRemoved++;}
if(updateAnchor||updateFocus){setSelection(updateAnchor?tab.nextSibling:anchorNode,updateAnchor?Math.max(0,anchorOffset-zwsRemoved):anchorOffset,updateFocus?tab.nextSibling:focusNode,updateFocus?Math.max(0,focusOffset-zwsRemoved):focusOffset);}
tab.remove();};}else{const tab=parseHTML(this.document,tabHtml);for(const block of new Set([...nonListItems].map(node=>closestBlock(node)).filter(node=>node))){block.prepend(tab.cloneNode(true));}
restore();}
this.historyStep();}
ev.preventDefault();ev.stopPropagation();}else if(ev.shiftKey&&ev.key==="Enter"){ev.preventDefault();this._handleAutomaticLinkInsertion();this._applyCommand('oShiftEnter');}else if(ev.key===' '){this._handleAutomaticLinkInsertion();}else if(IS_KEYBOARD_EVENT_UNDO(ev)){ev.preventDefault();ev.stopPropagation();this.historyUndo();}else if(IS_KEYBOARD_EVENT_REDO(ev)){ev.preventDefault();ev.stopPropagation();this.historyRedo();}else if(IS_KEYBOARD_EVENT_BOLD(ev)){ev.preventDefault();ev.stopPropagation();this.execCommand('bold');}else if(IS_KEYBOARD_EVENT_ITALIC(ev)){ev.preventDefault();ev.stopPropagation();this.execCommand('italic');}else if(IS_KEYBOARD_EVENT_UNDERLINE(ev)){ev.preventDefault();ev.stopPropagation();this.execCommand('underline');}else if(IS_KEYBOARD_EVENT_STRIKETHROUGH(ev)){ev.preventDefault();ev.stopPropagation();this.execCommand('strikeThrough');}else if(IS_KEYBOARD_EVENT_LEFT_ARROW(ev)||IS_KEYBOARD_EVENT_RIGHT_ARROW(ev)){const side=ev.key==='ArrowLeft'?'previous':'next';const{anchorNode,anchorOffset}=this.document.getSelection()||{};const codeElement=anchorNode&&closestElement(anchorNode,'code');const siblingProperty=`${side}Sibling`;if(codeElement?.classList.contains('o_inline_code')&&((side==='previous'&&!anchorOffset)||(side==='next'&&anchorOffset===nodeSize(anchorNode)))&&codeElement[siblingProperty]?.nodeType!==Node.TEXT_NODE&&!isZWS(codeElement[siblingProperty])){codeElement[side==='previous'?'before':'after'](document.createTextNode('\u200B'));setSelection(codeElement[siblingProperty],side==='previous'?0:1);}else{let didSkipFeff=false;let adjacentCharacter=getAdjacentCharacter(this.editable,side);let previousSelection;const hasSelectionChanged=(oldSelection={})=>{const newSelection=this.document.getSelection();return(oldSelection.anchorNode!==newSelection.anchorNode||oldSelection.anchorOffset!==newSelection.anchorOffset||oldSelection.focusNode!==newSelection.focusNode||oldSelection.focusOffset!==newSelection.focusOffset);};while(ZERO_WIDTH_CHARS.includes(adjacentCharacter)&&hasSelectionChanged(previousSelection)){const selection=this.document.getSelection();previousSelection={...selection};selection.modify(ev.shiftKey?'extend':'move',side==='previous'?'backward':'forward','character',);didSkipFeff=didSkipFeff||adjacentCharacter==='\ufeff';adjacentCharacter=getAdjacentCharacter(this.editable,side);}
if(didSkipFeff&&!ev.shiftKey){ev.preventDefault();ev.stopPropagation();}}}}
_onSelectionChange(){const currentKeyPress=this._currentKeyPress;delete this._currentKeyPress;const selection=this.document.getSelection();if(!selection){return;}
const anchorNode=selection.anchorNode;if(selection.isCollapsed&&anchorNode===this.editable&&!this.options.allowInlineAtRoot){this._fixSelectionOnEditableRoot(selection,currentKeyPress);return;}
let appliedCustomSelection=false;if(selection.rangeCount&&selection.getRangeAt(0)){appliedCustomSelection=this._handleSelectionInTable();if(!appliedCustomSelection){this.deselectTable();}}
const isSelectionInEditable=this.isSelectionInEditable(selection);if(!appliedCustomSelection){this._updateToolbar(!selection.isCollapsed&&isSelectionInEditable);}
if(!isSelectionInEditable){return;}
if(selection.anchorNode===this.editable&&selection.focusNode===this.editable&&selection.anchorOffset===0&&selection.focusOffset===[...this.editable.childNodes].length){getDeepRange(this.editable,{select:true});return;}
this._resetLinkInSelection();this._computeHistorySelection();if(this._currentMouseState==='mouseup'){this._fixFontAwesomeSelection();}
if(selection.rangeCount&&selection.getRangeAt(0)&&this.options.onCollaborativeSelectionChange){this.options.onCollaborativeSelectionChange(this.getCurrentCollaborativeSelection());}}
_resetLinkInSelection(){const selection=this.document.getSelection();if(!selection){return;}
const[anchorLink,focusLink]=[selection.anchorNode,selection.focusNode].map(node=>closestElement(node,'a:not(.btn)'));const singleLinkInSelection=anchorLink===focusLink&&anchorLink&&isLinkEligibleForZwnbsp(this.editable,anchorLink)&&anchorLink;if(singleLinkInSelection){singleLinkInSelection.classList.add('o_link_in_selection');}
for(const link of this.editable.querySelectorAll('.o_link_in_selection')){if(link!==singleLinkInSelection){link.classList.remove('o_link_in_selection');}};}
isSelectionInEditable(selection){selection=selection||this.document.getSelection();if(selection&&selection.anchorNode&&selection.focusNode){const anchorElement=closestElement(selection.anchorNode);const focusElement=closestElement(selection.focusNode);return anchorElement&&anchorElement.isContentEditable&&focusElement&&focusElement.isContentEditable&&this.editable.contains(selection.anchorNode)&&this.editable.contains(selection.focusNode);}else{return false;}}
isSelectionInBlockRoot(){const selection=this.document.getSelection();let selectionInBlockRoot;let currentNode=closestElement(selection.anchorNode);while(!currentNode.classList.contains('o_editable')&&!currentNode.classList.contains('odoo-editor-editable')&&!selectionInBlockRoot){selectionInBlockRoot=isBlock(currentNode);currentNode=currentNode.parentElement;}
return!!selectionInBlockRoot;}
_compositionStep(){if(this._fromCompositionText){this._fromCompositionText=false;this.sanitize();this.historyStep();}}
getCurrentCollaborativeSelection(){const selection=this._latestComputedSelection||this._computeHistorySelection();return{selection:selection?serializeSelection(selection):{anchorNodeOid:undefined,anchorOffset:undefined,focusNodeOid:undefined,focusOffset:undefined,},color:this._collabSelectionColor,clientId:this._collabClientId,clientAvatarUrl:this._collabClientAvatarUrl,};}
clean(){this.observerUnactive();this.cleanForSave();this.observerActive();}
initElementForEdition(element=this.editable){const orphanInlineChildNodes=[...element.childNodes].find((n)=>!isBlock(n)&&(n.nodeType===Node.ELEMENT_NODE||n.textContent.trim()!==""));if(orphanInlineChildNodes&&!this.options.allowInlineAtRoot){const childNodes=[...element.childNodes];const tempEl=document.createElement('temp-container');let currentP=document.createElement('p');currentP.style.marginBottom='0';do{const node=childNodes.shift();const nodeIsBlock=isBlock(node);const nodeIsBR=node.nodeName==='BR';if(!(nodeIsBlock||(nodeIsBR&&currentP.childNodes.length))){currentP.append(node);}
if(nodeIsBlock||nodeIsBR||childNodes.length===0){if(currentP.childNodes.length&&currentP.innerHTML.trim()!==''){tempEl.append(currentP);}
currentP=currentP.cloneNode();if(nodeIsBlock){tempEl.append(node);}}}while(childNodes.length)
element.replaceChildren(...tempEl.childNodes);}
for(const el of element.querySelectorAll('[contenteditable="false"]')){el.setAttribute('data-oe-keep-contenteditable','');}
for(const el of element.querySelectorAll('.oe-tabs')){el.setAttribute('contenteditable','false');}}
cleanForSave(element=this.editable){for(const hint of element.querySelectorAll('.oe-hint')){hint.classList.remove('oe-hint','oe-command-temporary-hint');if(hint.classList.length===0){hint.removeAttribute('class');}
hint.removeAttribute('placeholder');}
this._pluginCall('cleanForSave',[element]);const allWhitespaceRegex=/^[\s\u200b]*$/;for(const emptyElement of[...element.querySelectorAll('[data-oe-zws-empty-inline]')].reverse()){emptyElement.removeAttribute('data-oe-zws-empty-inline');if(!allWhitespaceRegex.test(emptyElement.textContent)){cleanZWS(emptyElement);}else if(!emptyElement.classList.length){emptyElement.remove();}}
const protectedNodes=element.querySelectorAll('[data-oe-transient-content="true"], [data-oe-transient-content=""]');for(const node of protectedNodes){node.replaceChildren();}
sanitize(element);for(const link of element.querySelectorAll('.o_link_in_selection')){link.classList.remove('o_link_in_selection');}
for(const node of descendants(element)){if(node.nodeType===Node.TEXT_NODE&&node.textContent.includes('\uFEFF')){const restore=prepareUpdate(...leftPos(node));node.textContent=node.textContent.replaceAll('\uFEFF','');restore();}}
const tAttrs=['t-elif','t-else','t-esc','t-foreach','t-if','t-out','t-raw','t-value'];for(const link of element.querySelectorAll('a')){if(![...link.childNodes].some(isVisible)&&!link.classList.length&&!tAttrs.some(attr=>link.hasAttribute(attr))){link.remove();}}
for(const el of element.querySelectorAll('[contenteditable="false"]')){if(!el.hasAttribute('data-oe-keep-contenteditable')){el.removeAttribute('contenteditable');}}
for(const el of element.querySelectorAll('[data-oe-keep-contenteditable]')){el.removeAttribute('data-oe-keep-contenteditable');}
for(const el of element.querySelectorAll(ICON_SELECTOR)){cleanZWS(el);}
if(this.deselectTable()&&hasValidSelection(this.editable)){this.document.getSelection().collapseToStart();}
for(const el of element.querySelectorAll('*[class=""]')){el.removeAttribute('class');}}
_handleCommandHint(){const selection=this.document.getSelection();const anchorNode=selection.anchorNode;if(isProtected(anchorNode)){return;}
const selectors={BLOCKQUOTE:this.options._t('Empty quote'),H1:this.options._t('Heading 1'),H2:this.options._t('Heading 2'),H3:this.options._t('Heading 3'),H4:this.options._t('Heading 4'),H5:this.options._t('Heading 5'),H6:this.options._t('Heading 6'),'UL LI':this.options._t('List'),'OL LI':this.options._t('List'),'CL LI':this.options._t('To-do'),};for(const hint of this.editable.querySelectorAll('.oe-hint')){if(hint.classList.contains('oe-command-temporary-hint')||!isEmptyBlock(hint)||hint.querySelector('T[t-out]')){this.observerUnactive();hint.classList.remove('oe-hint','oe-command-temporary-hint');if(hint.dataset.oeEditPlaceholder){hint.setAttribute("placeholder",hint.dataset.oeEditPlaceholder);if(hint.innerText.trim().length===0){hint.classList.add("oe-hint");}}else{hint.removeAttribute("placeholder");}
if(hint.classList.length===0){hint.removeAttribute('class');}
this.observerActive();}}
if(this.options.showEmptyElementHint){for(const[selector,text]of Object.entries(selectors)){for(const el of this.editable.querySelectorAll(selector)){if(!this.options.isHintBlacklisted(el)){this._makeHint(el,text);}}}}
const block=this.options.getPowerboxElement();if(block){this._makeHint(block,this.options._t('Type "/" for commands'),true);}
const sel=this.document.getSelection();if(this.editable.textContent.trim()===''&&this.options.placeholder&&this.editable.firstChild&&this.editable.firstChild.innerHTML&&!this.editable.contains(sel.focusNode)){this._makeHint(this.editable.firstChild,this.options.placeholder,true);}}
_makeHint(block,text,temporary=false){const content=block&&block.innerHTML.trim();if(block&&(content===''||content==='<br>')&&!block.querySelector('T[t-out],[t-field]')&&ancestors(block,this.editable).includes(this.editable)){this.observerUnactive();block.setAttribute('placeholder',text);block.classList.add('oe-hint');if(temporary){block.classList.add('oe-command-temporary-hint');}
this.observerActive();}}
_fixSelectionOnEditableRoot(selection,currentKeyPress){if(!this.editable.isContentEditable){return;}
let nodeAfterCursor=this.editable.childNodes[selection.anchorOffset];let nodeBeforeCursor=nodeAfterCursor&&nodeAfterCursor.previousElementSibling;if(currentKeyPress==='ArrowRight'||currentKeyPress==='ArrowDown'){while(nodeAfterCursor&&isNotAllowedContent(nodeAfterCursor)){nodeAfterCursor=nodeAfterCursor.nextElementSibling;}
if(nodeAfterCursor){setSelection(...getDeepestPosition(nodeAfterCursor,0));}else{this.historyResetLatestComputedSelection(true);}}else if(currentKeyPress==='ArrowLeft'||currentKeyPress==='ArrowUp'){while(nodeBeforeCursor&&isNotAllowedContent(nodeBeforeCursor)){nodeBeforeCursor=nodeBeforeCursor.previousElementSibling;}
if(nodeBeforeCursor){setSelection(...getDeepestPosition(nodeBeforeCursor,nodeSize(nodeBeforeCursor)));}else{this.historyResetLatestComputedSelection(true);}}else if(nodeAfterCursor&&paragraphRelatedElements.includes(nodeAfterCursor.nodeName)){setCursorStart(nodeAfterCursor);}else if(nodeBeforeCursor&&paragraphRelatedElements.includes(nodeBeforeCursor.nodeName)){setCursorEnd(nodeBeforeCursor);}else if(this._currentMouseState==='mousedown'){this._recordHistorySelection(true);const p=this.document.createElement('p');p.append(this.document.createElement('br'));if(!nodeAfterCursor){this.editable.append(p);}else if(!nodeBeforeCursor){this.editable.prepend(p);}else{nodeAfterCursor.before(p);}
setCursorStart(p);this.historyStep();}else{selection.removeAllRanges();}}
_onMouseup(ev){this._currentMouseState=ev.type;this._fixFontAwesomeSelection();}
_onMouseDown(ev){this._currentMouseState=ev.type;this._lastMouseClickPosition=[ev.x,ev.y];if(this.canActivateContentEditable){this._activateContenteditable();}
this.observer.takeRecords();const node=ev.target;if(node.tagName=='LI'&&getListMode(node.parentElement)=='CL'){const beforStyle=window.getComputedStyle(node,':before');const style1={left:parseInt(beforStyle.getPropertyValue('left'),10),top:parseInt(beforStyle.getPropertyValue('top'),10),}
style1.right=style1.left+parseInt(beforStyle.getPropertyValue('width'),10);style1.bottom=style1.top+parseInt(beforStyle.getPropertyValue('height'),10);const isMouseInsideCheckboxBox=ev.offsetX>=style1.left&&ev.offsetX<=style1.right&&ev.offsetY>=style1.top&&ev.offsetY<=style1.bottom;if(isMouseInsideCheckboxBox){toggleClass(node,'o_checked');this.historyStep();if(!document.getSelection().isCollapsed){this._updateToolbar(true);}}}
const isStar=el=>el.nodeType===Node.ELEMENT_NODE&&(el.classList.contains('fa-star')||el.classList.contains('fa-star-o'));if(isStar(node)&&node.parentElement&&node.parentElement.className.includes('o_stars')){const previousStars=getAdjacentPreviousSiblings(node,isStar);const nextStars=getAdjacentNextSiblings(node,isStar);if(nextStars.length||previousStars.length){const shouldToggleOff=node.classList.contains('fa-star')&&(!nextStars[0]||!nextStars[0].classList.contains('fa-star'));for(const star of[...previousStars,node]){star.classList.toggle('fa-star-o',shouldToggleOff);star.classList.toggle('fa-star',!shouldToggleOff);};for(const star of nextStars){star.classList.toggle('fa-star-o',true);star.classList.toggle('fa-star',false);};this.historyStep();}}
if(this.toolbar&&!ancestors(ev.target,this.editable).includes(this.toolbar)){this.toolbar.style.pointerEvents='none';if(this.deselectTable()&&hasValidSelection(this.editable)){this.document.getSelection().collapseToStart();this._updateToolbar(false);}}
const isHoveringTdBorder=this._isHoveringTdBorder(ev);const isRTL=this.options.direction==='rtl';if(isHoveringTdBorder){ev.preventDefault();const direction={top:'row',right:'col',bottom:'row',left:'col'}[isHoveringTdBorder]||false;let target1,target2;const column=closestElement(ev.target,'tr');if(isHoveringTdBorder==='top'&&column){target1=getAdjacentPreviousSiblings(column).find(node=>node.nodeName==='TR');target2=closestElement(ev.target,'tr');}else if(isHoveringTdBorder==='right'){if(isRTL){target1=getAdjacentPreviousSiblings(ev.target).find(node=>node.nodeName==='TD');target2=ev.target;}else{target1=ev.target;target2=getAdjacentNextSiblings(ev.target).find(node=>node.nodeName==='TD');}}else if(isHoveringTdBorder==='bottom'&&column){target1=closestElement(ev.target,'tr');target2=getAdjacentNextSiblings(column).find(node=>node.nodeName==='TR');}else if(isHoveringTdBorder==='left'){if(isRTL){target1=ev.target;target2=getAdjacentNextSiblings(ev.target).find(node=>node.nodeName==='TD');}else{target1=getAdjacentPreviousSiblings(ev.target).find(node=>node.nodeName==='TD');target2=ev.target;}}
this._isResizingTable=true;this._toggleTableResizeCursor(direction);const resizeTable=ev=>this._resizeTable(ev,direction,target1,target2);const stopResizing=ev=>{ev.preventDefault();this._isResizingTable=false;this._toggleTableResizeCursor(false);this.historyStep();this.document.removeEventListener('mousemove',resizeTable);this.document.removeEventListener('mouseup',stopResizing);this.document.removeEventListener('mouseleave',stopResizing);};this.document.addEventListener('mousemove',resizeTable);this.document.addEventListener('mouseup',stopResizing);this.document.addEventListener('mouseleave',stopResizing);}
const isEmojiPopover=document.querySelector('.o-EmojiPicker');if(isEmojiPopover&&ev.target!==isEmojiPopover){isEmojiPopover.remove();}}
_onScroll(ev){if(this._rowUiTarget&&!this._rowUi.classList.contains('o_open')){this._positionTableUi(this._rowUiTarget);}
if(this._columnUiTarget&&!this._columnUi.classList.contains('o_open')){this._positionTableUi(this._columnUiTarget);}}
_onDocumentKeydown(ev){const canUndoRedo=!['INPUT','TEXTAREA'].includes(this.document.activeElement.tagName);if(this.options.controlHistoryFromDocument&&canUndoRedo){if(IS_KEYBOARD_EVENT_UNDO(ev)&&canUndoRedo){ev.preventDefault();this.historyUndo();}else if(IS_KEYBOARD_EVENT_REDO(ev)&&canUndoRedo){ev.preventDefault();this.historyRedo();}}else{if(IS_KEYBOARD_EVENT_REDO(ev)||IS_KEYBOARD_EVENT_UNDO(ev)){this._onKeyupResetContenteditableNodes.push(...this.editable.querySelectorAll('[contenteditable=true]'),);if(this.editable.getAttribute('contenteditable')==='true'){this._onKeyupResetContenteditableNodes.push(this.editable);}
for(const node of this._onKeyupResetContenteditableNodes){this.automaticStepSkipStack();node.setAttribute('contenteditable',false);}}}}
_onDocumentKeyup(){if(this._onKeyupResetContenteditableNodes.length){for(const node of this._onKeyupResetContenteditableNodes){this.automaticStepSkipStack();node.setAttribute('contenteditable',true);}
this._onKeyupResetContenteditableNodes=[];}}
_onDocumentMouseup(ev){this._currentMouseState=ev.type;if(this.toolbar){this.toolbar.style.pointerEvents='auto';}}
_onMousemove(ev){if(this._currentMouseState==='mousedown'&&!this._isResizingTable){this._handleSelectionInTable(ev);}
if(!this._rowUi.classList.contains('o_open')&&!this._columnUi.classList.contains('o_open')){const column=closestElement(ev.target,'td');if(this._isResizingTable||!column||!column.isContentEditable||!ev.target||ev.target.nodeType!==Node.ELEMENT_NODE){this._toggleTableUi(false,false);}else{const row=closestElement(column,'tr');const isFirstColumn=column===row.querySelector('td');const table=column&&closestElement(column,'table');const isFirstRow=table&&row===table.querySelector('tr');this._toggleTableUi(isFirstColumn&&row,isFirstRow&&column);}}
const direction={top:'row',right:'col',bottom:'row',left:'col'}[this._isHoveringTdBorder(ev)]||false;if(direction||!this._isResizingTable){this._toggleTableResizeCursor(direction);}}
_onMouseLeave(ev){if(!this._isResizingTable){this._toggleTableResizeCursor(false);}}
_onDocumentClick(ev){this._rowUi.classList.remove('o_open');this._columnUi.classList.remove('o_open');}
_handleAutomaticLinkInsertion(){const selection=this.document.getSelection();if(selection&&selection.anchorNode&&isHtmlContentSupported(selection.anchorNode)&&!closestElement(selection.anchorNode).closest('a')&&selection.anchorNode.nodeType===Node.TEXT_NODE){selection.anchorNode.parentNode.normalize();const textSliced=selection.anchorNode.textContent.slice(0,selection.anchorOffset);const textNodeSplitted=textSliced.split(/\s/);const potentialUrl=textNodeSplitted.pop()||'';const match=[...potentialUrl.matchAll(new RegExp(URL_REGEX,'g'))].pop();if(match&&!EMAIL_REGEX.test(match[0])){const nodeForSelectionRestore=selection.anchorNode.splitText(selection.anchorOffset);const url=match[2]?match[0]:'http://'+match[0];const range=this.document.createRange();const startOffset=selection.anchorOffset-potentialUrl.length+match.index;range.setStart(selection.anchorNode,startOffset);range.setEnd(selection.anchorNode,startOffset+match[0].length);const link=this._createLink(range.extractContents().textContent,url);range.insertNode(link);setCursorStart(nodeForSelectionRestore,false);}}}
_createLink(label,url){const link=this.document.createElement('a');link.setAttribute('href',url);for(const[param,value]of Object.entries(this.options.defaultLinkAttributes)){link.setAttribute(param,`${value}`);}
link.innerText=label;return link;}
addImagesFiles(imageFiles){const promises=[];for(const imageFile of imageFiles){const imageNode=document.createElement('img');imageNode.classList.add('img-fluid');if(this.options.dropImageAsAttachment){imageNode.classList.add('o_b64_image_to_save');}
imageNode.dataset.fileName=imageFile.name;promises.push(getImageUrl(imageFile).then(url=>{imageNode.src=url;return imageNode;}));}
return Promise.all(promises).then(nodes=>{const fragment=document.createDocumentFragment();fragment.append(...nodes);return fragment;});}
_onPaste(ev){const sel=this.document.getSelection();if(sel.anchorNode&&isProtected(sel.anchorNode)){return;}
ev.preventDefault();const files=getImageFiles(ev.clipboardData);const odooEditorHtml=ev.clipboardData.getData('text/odoo-editor');const clipboardHtml=ev.clipboardData.getData('text/html');const targetSupportsHtmlContent=isHtmlContentSupported(sel.anchorNode);const link=closestElement(sel.anchorNode,'a');if(link&&sel.toString().replace(ZERO_WIDTH_CHARS_REGEX,'')===link.innerText.replace(ZERO_WIDTH_CHARS_REGEX,'')){const start=leftPos(link);link.remove();setSelection(...start,...start,false);}
if(!targetSupportsHtmlContent){const text=ev.clipboardData.getData("text/plain");this._applyCommand("insert",text);}else if(odooEditorHtml){const fragment=parseHTML(this.document,odooEditorHtml);const selector=this.options.renderingClasses.map(c=>`.${c}`).join(',');if(selector){for(const element of fragment.querySelectorAll(selector)){element.classList.remove(...this.options.renderingClasses);}}
this.DOMPurify??=DOMPurify(this.document.defaultView);this.DOMPurify.sanitize(fragment,{IN_PLACE:true});if(fragment.hasChildNodes()){this._applyCommand('insert',fragment);}}else if(files.length||clipboardHtml){const clipboardElem=this._prepareClipboardData(clipboardHtml);if(files.length&&!clipboardElem.querySelector('table')){this.addImagesFiles(files).then(html=>{this._applyCommand('insert',html);});}else{if(closestElement(sel.anchorNode,'a')){this._applyCommand('insert',clipboardElem.textContent);}
else{this._applyCommand('insert',clipboardElem);}}}else{const text=ev.clipboardData.getData('text/plain');const selectionIsInsideALink=!!closestElement(sel.anchorNode,'a');let splitAroundUrl=[text];if(!text.match(/\${.*}/gi)){splitAroundUrl=text.split(URL_REGEX);splitAroundUrl=splitAroundUrl.filter((_,index)=>((index+1)%3));}
if(splitAroundUrl.length===3&&!splitAroundUrl[0]&&!splitAroundUrl[2]){const url=/^https?:\/\//i.test(text)?text:'http://'+text;const youtubeUrl=this.options.allowCommandVideo&&YOUTUBE_URL_GET_VIDEO_ID.exec(url);const urlFileExtention=url.split('.').pop();const isImageUrl=['jpg','jpeg','png','gif','svg','webp'].includes(urlFileExtention.toLowerCase());if(selectionIsInsideALink){if(isImageUrl){const img=document.createElement('IMG');img.setAttribute('src',url);this._applyCommand('insert',img);}else{this._applyCommand('insert',text);}}else if(isImageUrl||youtubeUrl){const stepIndexBeforeInsert=this._historySteps.length-1;this.observerFlush();const currentStepMutations=[...this._currentStep.mutations];this._applyCommand('insert',text);const revertTextInsertion=()=>{this.historyRevertUntil(stepIndexBeforeInsert);this.historyStep(true);this._historyStepsStates.set(peek(this._historySteps).id,'consumed');this.historyApply(currentStepMutations);};let commands;const pasteAsURLCommand={name:this.options._t('Paste as URL'),description:this.options._t('Create an URL.'),fontawesome:'fa-link',callback:()=>{revertTextInsertion();this._applyRawCommand('insert',this._createLink(text,url))},};if(isImageUrl){const embedImageCommand={name:this.options._t('Embed Image'),description:this.options._t('Embed the image in the document.'),fontawesome:'fa-image',callback:()=>{revertTextInsertion();const img=document.createElement('IMG');img.setAttribute('src',url);this._applyRawCommand('insert',img);},};commands=[embedImageCommand,pasteAsURLCommand];}else{const embedVideoCommand={name:this.options._t('Embed Youtube Video'),description:this.options._t('Embed the youtube video in the document.'),fontawesome:'fa-youtube-play',callback:async()=>{revertTextInsertion();let videoElement;if(this.options.getYoutubeVideoElement){videoElement=await this.options.getYoutubeVideoElement(youtubeUrl[0]);}else{videoElement=document.createElement('iframe');videoElement.setAttribute('width','560');videoElement.setAttribute('height','315');videoElement.setAttribute('src',`https://www.youtube.com/embed/${encodeURIComponent(youtubeUrl[1])}`,);videoElement.setAttribute('title','YouTube video player');videoElement.setAttribute('frameborder','0');videoElement.setAttribute('allow','accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture',);videoElement.setAttribute('allowfullscreen','1');}
this._applyRawCommand('insert',videoElement);},};commands=[embedVideoCommand,pasteAsURLCommand];}
this.powerbox.open(commands);}else{this._applyCommand('insert',this._createLink(text,url));}}else{this.historyPauseSteps();for(let i=0;i<splitAroundUrl.length;i++){const url=/^https?:\/\//gi.test(splitAroundUrl[i])?splitAroundUrl[i]:'http://'+splitAroundUrl[i];if(i%2&&!selectionIsInsideALink){this._applyCommand('insert',this._createLink(splitAroundUrl[i],url));}else if(splitAroundUrl[i]!==''){const textFragments=splitAroundUrl[i].split(/\r?\n/);let textIndex=1;for(const textFragment of textFragments){const modifiedTextFragment=textFragment.replace(/( {2,})/g,match=>{let alertnateValue=false;return match.replace(/ /g,()=>{alertnateValue=!alertnateValue;const replaceContent=alertnateValue?'\u00A0':' ';return replaceContent;});});this._applyCommand('insert',modifiedTextFragment);if(textIndex<textFragments.length){const p=closestElement(sel.anchorNode,'p');if(isUnbreakable(closestBlock(sel.anchorNode))){this._applyCommand('oShiftEnter');}else{this._applyCommand('oEnter');p&&(p.style.marginBottom='0px');}}
textIndex++;}}}
this.historyUnpauseSteps();this.historyStep();}}}
_onDragStart(ev){if(ev.target.nodeName==='IMG'){ev.dataTransfer.setData('text/plain',`oid:${ev.target.oid}`);}}
_onDrop(ev){ev.preventDefault();if(!isHtmlContentSupported(ev.target)){return;}
const sel=this.document.getSelection();let isInEditor=false;let ancestor=sel.anchorNode;while(ancestor&&!isInEditor){if(ancestor===this.editable){isInEditor=true;}
ancestor=ancestor.parentNode;}
const dataTransfer=(ev.originalEvent||ev).dataTransfer;const imageOidMatch=(dataTransfer.getData('text')||'').match('oid:(.*)');const imageOid=imageOidMatch&&imageOidMatch[1];const image=imageOid&&[...this.editable.querySelectorAll('*')].find(node=>node.oid===imageOid,);const fileTransferItems=getImageFiles(dataTransfer);const htmlTransferItem=[...dataTransfer.items].find(item=>item.type==='text/html',);if(image||fileTransferItems.length||htmlTransferItem){if(this.document.caretPositionFromPoint){const range=this.document.caretPositionFromPoint(ev.clientX,ev.clientY);setSelection(range.offsetNode,range.offset);}else if(this.document.caretRangeFromPoint){const range=this.document.caretRangeFromPoint(ev.clientX,ev.clientY);setSelection(range.startContainer,range.startOffset);}}
if(image){image.classList.toggle('img-fluid',true);const html=image.outerHTML;image.remove();this.execCommand('insert',this._prepareClipboardData(html));}else if(fileTransferItems.length){this.addImagesFiles(fileTransferItems).then(html=>{this.execCommand('insert',html);});}else if(htmlTransferItem){htmlTransferItem.getAsString(pastedText=>{this.execCommand('insert',this._prepareClipboardData(pastedText));});}
this.historyStep();}
_onTabulationInTable(ev){const sel=this.document.getSelection();const closestTable=closestElement(sel.anchorNode,'table');if(!closestTable){return;}
const closestTd=closestElement(sel.anchorNode,'td');const tds=[...closestTable.querySelectorAll('td')];const direction=ev.shiftKey?DIRECTIONS.LEFT:DIRECTIONS.RIGHT;const cursorDestination=tds[tds.findIndex(td=>closestTd===td)+(direction===DIRECTIONS.LEFT?-1:1)];if(cursorDestination){setCursorEnd(lastLeaf(cursorDestination));}else if(direction===DIRECTIONS.RIGHT){this.execCommand('addRow','after');this._onTabulationInTable(ev);}}
_onTableMenuTogglerClick(ev){const uiWrapper=ev.target.closest('.o_table_ui');uiWrapper.classList.toggle('o_open');if(this.options.direction==='rtl'){const menuRowEl=this._tableUiContainer.querySelector('.o_row_ui .o_table_ui_menu')
const menuRowRect=menuRowEl.getBoundingClientRect();menuRowEl.style.position='absolute';menuRowEl.style.left=`-${menuRowRect.width}px`;menuRowEl.style.margin=`0px`;}
if(uiWrapper.classList.contains('o_column_ui')){const columnIndex=getColumnIndex(this._columnUiTarget);uiWrapper.querySelector('.o_move_left').classList.toggle('o_hide',columnIndex===0);const shouldHideRight=columnIndex===[...this._columnUiTarget.parentElement.children].filter(child=>child.nodeName==='TD').length-1;uiWrapper.querySelector('.o_move_right').classList.toggle('o_hide',shouldHideRight);}else{const rowIndex=getRowIndex(this._rowUiTarget);uiWrapper.querySelector('.o_move_up').classList.toggle('o_hide',rowIndex===0);const shouldHideDown=rowIndex===[...this._rowUiTarget.parentElement.children].filter(child=>child.nodeName==='TR').length-1;uiWrapper.querySelector('.o_move_down').classList.toggle('o_hide',shouldHideDown);}
ev.stopPropagation();}
_onTableMoveUpClick(){if(this._rowUiTarget.previousSibling){if(!this._rowUiTarget.previousSibling.previousSibling){this._rowUiTarget.childNodes.forEach((cell,index)=>{cell.style.width=this._rowUiTarget.previousSibling.childNodes[index].style.width;});}
this._rowUiTarget.previousSibling.before(this._rowUiTarget);}}
_onTableMoveDownClick(){if(this._rowUiTarget.nextSibling){if(!this._rowUiTarget.previousSibling){this._rowUiTarget.nextSibling.childNodes.forEach((cell,index)=>{cell.style.width=this._rowUiTarget.childNodes[index].style.width;});}
this._rowUiTarget.nextSibling.after(this._rowUiTarget);}}
_onTableMoveRightClick(){const trs=[...this._columnUiTarget.parentElement.parentElement.children].filter(child=>child.nodeName==='TR');const columnIndex=getColumnIndex(this._columnUiTarget);const tdsToMove=trs.map(tr=>[...tr.children].filter(child=>child.nodeName==='TD')[columnIndex]);for(const tdToMove of tdsToMove){const target=[...tdToMove.parentElement.children].filter(child=>child.nodeName==='TD')[columnIndex+1];target.after(tdToMove);}}
_onTableMoveLeftClick(){const trs=[...this._columnUiTarget.parentElement.parentElement.children].filter(child=>child.nodeName==='TR');const columnIndex=getColumnIndex(this._columnUiTarget);const tdsToMove=trs.map(tr=>[...tr.children].filter(child=>child.nodeName==='TD')[columnIndex]);for(const tdToMove of tdsToMove){const target=[...tdToMove.parentElement.children].filter(child=>child.nodeName==='TD')[columnIndex-1];target.before(tdToMove);}}
_onTableDeleteColumnClick(){this.historyPauseSteps();const rows=[...closestElement(this._columnUiTarget,'tr').parentElement.children].filter(child=>child.nodeName==='TR');this.execCommand('removeColumn',this._columnUiTarget);if(rows.every(row=>!row.parentElement)){this.execCommand('deleteTable',this.editable.querySelector('.o_selected_table'));}
this.historyUnpauseSteps();this.historyStep();}
_onTableDeleteRowClick(){this.historyPauseSteps();const rows=[...this._rowUiTarget.parentElement.children].filter(child=>child.nodeName==='TR');this.execCommand('removeRow',this._rowUiTarget);if(rows.every(row=>!row.parentElement)){this.execCommand('deleteTable',this.editable.querySelector('.o_selected_table'));}
this.historyUnpauseSteps();this.historyStep();}
_fixFontAwesomeSelection(){const selection=this.document.getSelection();if(selection.isCollapsed||(selection.anchorNode&&!ancestors(selection.anchorNode,this.editable).includes(this.editable)))
return;let shouldUpdateSelection=false;const fixedSelection={anchorNode:selection.anchorNode,anchorOffset:selection.anchorOffset,focusNode:selection.focusNode,focusOffset:selection.focusOffset,};const selectionDirection=getCursorDirection(selection.anchorNode,selection.anchorOffset,selection.focusNode,selection.focusOffset,);const closestAnchorNodeEl=closestElement(selection.anchorNode);if(isFontAwesome(closestAnchorNodeEl)){shouldUpdateSelection=true;fixedSelection.anchorNode=selectionDirection===DIRECTIONS.RIGHT?closestAnchorNodeEl.previousSibling:closestAnchorNodeEl.nextSibling;if(fixedSelection.anchorNode){fixedSelection.anchorOffset=selectionDirection===DIRECTIONS.RIGHT?fixedSelection.anchorNode.length:0;}else{fixedSelection.anchorNode=closestAnchorNodeEl.parentElement;fixedSelection.anchorOffset=0;}}
const closestFocusNodeEl=closestElement(selection.focusNode);if(isFontAwesome(closestFocusNodeEl)){shouldUpdateSelection=true;fixedSelection.focusNode=selectionDirection===DIRECTIONS.RIGHT?closestFocusNodeEl.nextSibling:closestFocusNodeEl.previousSibling;if(fixedSelection.focusNode){fixedSelection.focusOffset=selectionDirection===DIRECTIONS.RIGHT?0:fixedSelection.focusNode.length;}else{fixedSelection.focusNode=closestFocusNodeEl.parentElement;fixedSelection.focusOffset=0;}}
if(shouldUpdateSelection){setSelection(fixedSelection.anchorNode,fixedSelection.anchorOffset,fixedSelection.focusNode,fixedSelection.focusOffset,false,);}}
_pluginAdd(Plugin){this._plugins.push(new Plugin({editor:this}));}
_pluginCall(method,args=[]){for(const plugin of this._plugins){if(plugin[method]){plugin[method](...args);}}}}
return __exports;});;

/* /web_editor/static/src/js/editor/odoo-editor/src/commands/align.js */
odoo.define('@web_editor/js/editor/odoo-editor/src/commands/align',['@web_editor/js/editor/odoo-editor/src/utils/utils'],function(require){'use strict';let __exports={};const{childNodeIndex,isBlock}=require("@web_editor/js/editor/odoo-editor/src/utils/utils");Text.prototype.oAlign=function(offset,mode){this.parentElement.oAlign(childNodeIndex(this),mode);};HTMLElement.prototype.oAlign=function(offset,mode){if(!isBlock(this)){return this.parentElement.oAlign(childNodeIndex(this),mode);}
const{textAlign}=getComputedStyle(this);const alreadyAlignedLeft=textAlign==='start'||textAlign==='left';const shouldApplyStyle=!(alreadyAlignedLeft&&mode==='left');if(shouldApplyStyle){this.style.textAlign=mode;}};return __exports;});;

/* /web_editor/static/src/js/editor/odoo-editor/src/commands/commands.js */
odoo.define('@web_editor/js/editor/odoo-editor/src/commands/commands',['@web_editor/js/editor/odoo-editor/src/utils/constants','@web_editor/js/editor/odoo-editor/src/utils/utils'],function(require){'use strict';let __exports={};const{REGEX_BOOTSTRAP_COLUMN}=require("@web_editor/js/editor/odoo-editor/src/utils/constants");const{ancestors,descendants,childNodeIndex,closestBlock,closestElement,closestPath,DIRECTIONS,findNode,getCursors,getDeepRange,getInSelection,getListMode,getSelectedNodes,getTraversedNodes,insertAndSelectZws,insertText,isBlock,isColorGradient,isSelectionFormat,isShrunkBlock,isSelfClosingElement,leftLeafFirstPath,preserveCursor,rightPos,setSelection,setCursorStart,setTagName,splitAroundUntil,splitElement,splitTextNode,startPos,nodeSize,allowsParagraphRelatedElements,isUnbreakable,makeContentsInline,unwrapContents,getColumnIndex,pxToFloat,getRowIndex,parseHTML,formatSelection,getDeepestPosition,fillEmpty,isEmptyBlock,isWhitespace,isVisibleTextNode,getCursorDirection,resetOuids,FONT_SIZE_CLASSES,TEXT_STYLE_CLASSES,padLinkWithZws,isLinkEligibleForZwnbsp,paragraphRelatedElements,lastLeaf,firstLeaf,}=require("@web_editor/js/editor/odoo-editor/src/utils/utils");const TEXT_CLASSES_REGEX=/\btext-[^\s]*\b/;const BG_CLASSES_REGEX=/\bbg-[^\s]*\b/;function align(editor,mode){const sel=editor.document.getSelection();const visitedBlocks=new Set();const traversedNode=getTraversedNodes(editor.editable);for(const node of traversedNode){if(isVisibleTextNode(node)){const block=closestBlock(node);if(!visitedBlocks.has(block)){const hasModifier=getComputedStyle(block).textAlign===mode;if(!hasModifier&&block.isContentEditable){block.oAlign(sel.anchorOffset,mode);}
visitedBlocks.add(block);}}}}
function colorElement(element,color,mode){const newClassName=element.className.replace(mode==='color'?TEXT_CLASSES_REGEX:BG_CLASSES_REGEX,'').replace(/\btext-gradient\b/g,'').replace(/\s+/,' ');element.className!==newClassName&&(element.className=newClassName);element.style['background-image']='';if(mode==='backgroundColor'){element.style['background']='';}
if(color.startsWith('text')||color.startsWith('bg-')){element.style[mode]='';element.classList.add(color);}else if(isColorGradient(color)){element.style[mode]='';if(mode==='color'){element.style['background']='';element.style['background-image']=color;element.classList.add('text-gradient');}else{element.style['background-image']=color;}}else{element.style[mode]=color;}}
function hasColor(element,mode){const style=element.style;const parent=element.parentNode;const classRegex=mode==='color'?TEXT_CLASSES_REGEX:BG_CLASSES_REGEX;if(isColorGradient(style['background-image'])){if(element.classList.contains('text-gradient')){if(mode==='color'){return true;}}else{if(mode!=='color'){return true;}}}
return((style[mode]&&style[mode]!=='inherit'&&(!parent||style[mode]!==parent.style[mode]))||(classRegex.test(element.className)&&(!parent||getComputedStyle(element)[mode]!==getComputedStyle(parent)[mode])));}
const editorCommands=__exports.editorCommands={insert:(editor,content)=>{if(!content)return;const selection=editor.document.getSelection();let startNode;let insertBefore=false;if(!selection.isCollapsed){editor.deleteRange(selection);}
const range=selection.getRangeAt(0);const block=closestBlock(selection.anchorNode);const isSelectionAtStart=firstLeaf(block)===selection.anchorNode&&selection.anchorOffset===0;const isSelectionAtEnd=lastLeaf(block)===selection.focusNode&&selection.focusOffset===nodeSize(selection.focusNode);if(range.startContainer.nodeType===Node.TEXT_NODE){insertBefore=!range.startOffset;splitTextNode(range.startContainer,range.startOffset,DIRECTIONS.LEFT);startNode=range.startContainer;}
const container=document.createElement('fake-element');const containerFirstChild=document.createElement('fake-element-fc');const containerLastChild=document.createElement('fake-element-lc');if(typeof content==='string'){container.textContent=content;}else{container.replaceChildren(content);}
if(closestElement(selection.anchorNode,'UL, OL')&&(container.firstChild.nodeName==='UL'||container.firstChild.nodeName==='OL')){container.replaceChildren(...container.firstChild.childNodes);}
startNode=startNode||editor.document.getSelection().anchorNode;const shouldUnwrap=(node)=>([...paragraphRelatedElements,'LI'].includes(node.nodeName)&&block.textContent!==""&&node.textContent!==""&&(block.nodeName===node.nodeName||['BLOCKQUOTE','PRE','DIV'].includes(block.nodeName))&&selection.anchorNode.oid!=='root');if(container.lastElementChild&&isBlock(container.lastElementChild)&&!container.lastElementChild.hasChildNodes()){fillEmpty(container.lastElementChild);}
if(container.childElementCount===1&&(['P','LI'].includes(container.firstChild.nodeName)||shouldUnwrap(container.firstChild))&&selection.anchorNode.oid!=='root'){const p=container.firstElementChild;container.replaceChildren(...p.childNodes);}else if(container.childElementCount>1){if(shouldUnwrap(container.firstChild)&&!isSelectionAtStart){containerFirstChild.replaceChildren(...container.firstElementChild.childNodes);container.firstElementChild.remove();}
if(shouldUnwrap(container.lastChild)&&!isSelectionAtEnd){containerLastChild.replaceChildren(...container.lastElementChild.childNodes);container.lastElementChild.remove();}}
if(startNode.nodeType===Node.ELEMENT_NODE){if(selection.anchorOffset===0){const textNode=editor.document.createTextNode('');if(isSelfClosingElement(startNode)){startNode.parentNode.insertBefore(textNode,startNode);}else{startNode.prepend(textNode);}
startNode=textNode;}else{startNode=startNode.childNodes[selection.anchorOffset-1];}}
let currentNode=startNode;let lastChildNode=false;const _insertAt=(reference,nodes,insertBefore)=>{for(const child of(insertBefore?nodes.reverse():nodes)){reference[insertBefore?'before':'after'](child);reference=child;}}
const lastInsertedNodes=[...containerLastChild.childNodes];if(containerLastChild.hasChildNodes()){const toInsert=[...containerLastChild.childNodes];_insertAt(currentNode,[...toInsert],insertBefore);currentNode=insertBefore?toInsert[0]:currentNode;lastChildNode=toInsert[toInsert.length-1];}
const firstInsertedNodes=[...containerFirstChild.childNodes];if(containerFirstChild.hasChildNodes()){const toInsert=[...containerFirstChild.childNodes];_insertAt(currentNode,[...toInsert],insertBefore);currentNode=toInsert[toInsert.length-1];insertBefore=false;}
if(!container.hasChildNodes()){if(isUnbreakable(closestBlock(currentNode.nextSibling))){currentNode.nextSibling.oShiftEnter(0);}else{const parent=currentNode.nextSibling.parentElement;const index=[...parent.childNodes].indexOf(currentNode.nextSibling);currentNode.nextSibling.parentElement.oEnter(index);}}
let nodeToInsert;const insertedNodes=[...container.childNodes];while((nodeToInsert=container.childNodes[0])){if(isBlock(nodeToInsert)&&!allowsParagraphRelatedElements(currentNode)){while(currentNode.parentElement!==editor.editable&&(!allowsParagraphRelatedElements(currentNode.parentElement)||currentNode.parentElement.nodeName==='LI')){if(isUnbreakable(currentNode.parentElement)){makeContentsInline(container);nodeToInsert=container.childNodes[0];break;}
let offset=childNodeIndex(currentNode);if(!insertBefore){offset+=1;}
if(offset){const[left,right]=splitElement(currentNode.parentElement,offset);if(isUnbreakable(nodeToInsert)&&container.childNodes.length===1){fillEmpty(right);}else if(isEmptyBlock(right)){right.remove();}
currentNode=insertBefore?right:left;}else{currentNode=currentNode.parentElement;}}}
const isNodeToInsertContentEditable=nodeToInsert.isContentEditable;if(insertBefore){currentNode.before(nodeToInsert);insertBefore=false;}else{currentNode.after(nodeToInsert);}
if(['BLOCKQUOTE','PRE'].includes(block.nodeName)&&paragraphRelatedElements.includes(nodeToInsert.nodeName)){nodeToInsert=setTagName(nodeToInsert,block.nodeName);}
if(currentNode.tagName!=='BR'&&isShrunkBlock(currentNode)){currentNode.remove();}
if(!isNodeToInsertContentEditable&&editor.editable.firstChild===nodeToInsert&&nodeToInsert.nodeName==='DIV'){const zws=document.createTextNode('\u200B');nodeToInsert.before(zws);}
currentNode=nodeToInsert;}
currentNode=lastChildNode||currentNode;if(currentNode.nodeName!=='BR'&&currentNode.nextSibling&&currentNode.nextSibling.nodeName==='BR'&&lastLeaf(currentNode.parentNode)===currentNode.nextSibling&&!closestElement(currentNode,'[t-field],[t-esc],[t-out]')){currentNode.nextSibling.remove();}
selection.removeAllRanges();const newRange=new Range();let lastPosition;if(currentNode.nodeName==='A'&&isLinkEligibleForZwnbsp(editor.editable,currentNode)){padLinkWithZws(editor.editable,currentNode);currentNode=currentNode.nextSibling;lastPosition=getDeepestPosition(...rightPos(currentNode));}else{lastPosition=[...paragraphRelatedElements,'LI'].includes(currentNode.nodeName)?rightPos(lastLeaf(currentNode)):rightPos(currentNode);}
if(!editor.options.allowInlineAtRoot&&lastPosition[0]===editor.editable){lastPosition=getDeepestPosition(...lastPosition);}
newRange.setStart(lastPosition[0],lastPosition[1]);newRange.setEnd(lastPosition[0],lastPosition[1]);selection.addRange(newRange);return[...firstInsertedNodes,...insertedNodes,...lastInsertedNodes];},insertFontAwesome:(editor,faClass='fa fa-star')=>{const insertedNode=editorCommands.insert(editor,document.createElement('i'))[0];insertedNode.className=faClass;const position=rightPos(insertedNode);setSelection(...position,...position,false);},undo:editor=>editor.historyUndo(),redo:editor=>editor.historyRedo(),setTag(editor,tagName,extraClass=""){const range=getDeepRange(editor.editable,{correctTripleClick:true});const selectedBlocks=[...new Set(getTraversedNodes(editor.editable,range).map(closestBlock))];const deepestSelectedBlocks=selectedBlocks.filter(block=>(!descendants(block).some(descendant=>selectedBlocks.includes(descendant))&&block.isContentEditable));let{startContainer,startOffset,endContainer,endOffset}=range;const startContainerChild=startContainer.firstChild;const endContainerChild=endContainer.lastChild;for(const block of deepestSelectedBlocks){if(['P','PRE','H1','H2','H3','H4','H5','H6','LI','BLOCKQUOTE'].includes(block.nodeName,)){const inLI=block.closest('li');if(inLI&&tagName==="P"){inLI.oToggleList(0);}else{const newEl=setTagName(block,tagName);newEl.classList.remove(...FONT_SIZE_CLASSES,...TEXT_STYLE_CLASSES,"h1","h2","h3","h4","h5","h6");delete newEl.style.fontSize;if(extraClass){newEl.classList.add(extraClass);}
if(newEl.classList.length===0){newEl.removeAttribute("class");}}}else{const newBlock=editor.document.createElement(tagName);const children=[...block.childNodes];block.insertBefore(newBlock,block.firstChild);children.forEach(child=>newBlock.appendChild(child));}}
const isContextBlock=container=>['TD','DIV','LI'].includes(container.nodeName);if(!startContainer.isConnected||isContextBlock(startContainer)){startContainer=startContainerChild.parentNode;}
if(!endContainer.isConnected||isContextBlock(endContainer)){endContainer=endContainerChild.parentNode;}
const newRange=new Range();newRange.setStart(startContainer,startOffset);newRange.setEnd(endContainer,endOffset);getDeepRange(editor.editable,{range:newRange,select:true});editor.historyStep();},bold:editor=>formatSelection(editor,'bold'),italic:editor=>formatSelection(editor,'italic'),underline:editor=>formatSelection(editor,'underline'),strikeThrough:editor=>formatSelection(editor,'strikeThrough'),setFontSize:(editor,size)=>formatSelection(editor,'fontSize',{applyStyle:true,formatProps:{size}}),setFontSizeClassName:(editor,className)=>formatSelection(editor,'setFontSizeClassName',{formatProps:{className}}),switchDirection:editor=>{getDeepRange(editor.editable,{splitText:true,select:true,correctTripleClick:true});const selection=editor.document.getSelection();const selectedTextNodes=[selection.anchorNode,...getSelectedNodes(editor.editable),selection.focusNode].filter(n=>n.nodeType===Node.TEXT_NODE&&closestElement(n).isContentEditable&&n.nodeValue.trim().length);const changedElements=[];const defaultDirection=editor.options.direction;const shouldApplyStyle=!isSelectionFormat(editor.editable,'switchDirection');let blocks=new Set(selectedTextNodes.map(textNode=>closestElement(textNode,'ul,ol')||closestBlock(textNode)));blocks.forEach(block=>{blocks=[...blocks,...block.querySelectorAll('ul,ol')];})
for(const block of blocks){if(!shouldApplyStyle){block.removeAttribute('dir');}else{block.setAttribute('dir',defaultDirection==='ltr'?'rtl':'ltr');}
changedElements.push(block);}
for(const element of changedElements){const style=getComputedStyle(element);if(style.direction==='ltr'&&style.textAlign==='right'){element.style.setProperty('text-align','left');}else if(style.direction==='rtl'&&style.textAlign==='left'){element.style.setProperty('text-align','right');}}},removeFormat:editor=>{const textAlignStyles=new Map();getTraversedNodes(editor.editable).forEach((element)=>{const block=closestBlock(element);if(block.style.textAlign){textAlignStyles.set(block,block.style.textAlign);}});editor.historyPauseSteps();editor.document.execCommand('removeFormat');for(const node of getTraversedNodes(editor.editable)){if(node.nodeType===Node.ELEMENT_NODE&&node.hasAttribute('color')){node.removeAttribute('color');}
const element=closestElement(node);element.style.removeProperty('color');element.style.removeProperty('background');}
textAlignStyles.forEach((textAlign,block)=>{block.style.setProperty('text-align',textAlign);});editor.historyUnpauseSteps();},justifyLeft:editor=>align(editor,'left'),justifyRight:editor=>align(editor,'right'),justifyCenter:editor=>align(editor,'center'),justifyFull:editor=>align(editor,'justify'),createLink:(editor,link,content)=>{const sel=editor.document.getSelection();if(content&&!sel.isCollapsed){editor.deleteRange(sel);}
if(sel.isCollapsed){insertText(sel,content||'link');}
const currentLink=closestElement(sel.focusNode,'a');link=link||prompt('URL or Email',(currentLink&&currentLink.href)||'http://');const res=editor.document.execCommand('createLink',false,link);if(res){setSelection(sel.anchorNode,sel.anchorOffset,sel.focusNode,sel.focusOffset);const node=findNode(closestPath(sel.focusNode),node=>node.tagName==='A');for(const[param,value]of Object.entries(editor.options.defaultLinkAttributes)){node.setAttribute(param,`${value}`);}
const pos=[node.parentElement,childNodeIndex(node)+1];setSelection(...pos,...pos,false);}},unlink:editor=>{const sel=editor.document.getSelection();const isCollapsed=sel.isCollapsed;getDeepRange(editor.editable,{sel,splitText:true,select:true});if(!isCollapsed){let{anchorNode,focusNode,anchorOffset,focusOffset}=sel;const direction=getCursorDirection(anchorNode,anchorOffset,focusNode,focusOffset);const[startLink,endLink]=[closestElement(anchorNode,'a'),closestElement(focusNode,'a')];if(startLink){anchorNode=splitAroundUntil(anchorNode,startLink);anchorOffset=direction===DIRECTIONS.RIGHT?0:nodeSize(anchorNode);setSelection(anchorNode,anchorOffset,focusNode,focusOffset,true);}
if(endLink&&endLink.isConnected){focusNode=splitAroundUntil(focusNode,endLink);focusOffset=direction===DIRECTIONS.RIGHT?nodeSize(focusNode):0;setSelection(anchorNode,anchorOffset,focusNode,focusOffset,true);}}
const targetedNodes=isCollapsed?[sel.anchorNode]:getSelectedNodes(editor.editable);const links=new Set(targetedNodes.map(node=>closestElement(node,'a')).filter(a=>a&&a.isContentEditable));if(links.size){const cr=preserveCursor(editor.document);for(const link of links){unwrapContents(link);}
cr();}},indentList:(editor,mode='indent')=>{const[pos1,pos2]=getCursors(editor.document);const end=leftLeafFirstPath(...pos1).next().value;const li=new Set();for(const node of leftLeafFirstPath(...pos2)){const cli=closestElement(node,'li');if(cli&&cli.tagName=='LI'&&!li.has(cli)&&!cli.classList.contains('oe-nested')&&cli.isContentEditable&&!cli.classList.contains('nav-item')){li.add(cli);}
if(node==end)break;}
for(const node of li){if(mode=='indent'){node.oTab(0);}else{node.oShiftTab(0);}}
return true;},toggleList:(editor,mode)=>{const li=new Set();const blocks=new Set();const selectedBlocks=getTraversedNodes(editor.editable);const deepestSelectedBlocks=selectedBlocks.filter(block=>(!descendants(block).some(descendant=>selectedBlocks.includes(descendant))));for(const node of deepestSelectedBlocks){if(node.nodeType===Node.TEXT_NODE&&isWhitespace(node)&&closestElement(node).isContentEditable){node.remove();}else{const isNavItemList=node=>node.nodeName==='LI'&&node.classList.contains('nav-item');let nodeToToggle=closestBlock(node);nodeToToggle=isNavItemList(nodeToToggle)?node:nodeToToggle;if(!['OL','UL'].includes(nodeToToggle.tagName)&&(nodeToToggle.isContentEditable||nodeToToggle.nodeType===Node.TEXT_NODE)){const closestLi=closestElement(nodeToToggle,'li');nodeToToggle=closestLi&&!isNavItemList(closestLi)?closestLi:nodeToToggle;const ublock=nodeToToggle.nodeName==='LI'&&nodeToToggle.closest('ol, ul');ublock&&getListMode(ublock)==mode?li.add(nodeToToggle):blocks.add(nodeToToggle);}}}
let target=[...(blocks.size?blocks:li)];if(blocks.size){for(const block of blocks){if(block.style){block.style.padding="";}}}
while(target.length){const node=target.pop();if(!node.oToggleList(0,mode)){target=target.filter(li=>li.parentNode!=node.parentNode||li.tagName!='LI',);}}},applyColor:(editor,color,mode,element)=>{const selectedTds=[...editor.editable.querySelectorAll('td.o_selected_td')].filter(node=>closestElement(node).isContentEditable);let coloredTds=[];if(selectedTds.length&&mode==="backgroundColor"){for(const td of selectedTds){colorElement(td,color,mode);}
coloredTds=[...selectedTds];}else if(element){colorElement(element,color,mode);return[element];}
const selection=editor.document.getSelection();let wasCollapsed=false;if(selection.getRangeAt(0).collapsed&&!selectedTds.length){insertAndSelectZws(selection);wasCollapsed=true;}
const range=getDeepRange(editor.editable,{splitText:true,select:true});if(!range)return;const restoreCursor=preserveCursor(editor.document);const selectionNodes=getSelectedNodes(editor.editable).filter(node=>closestElement(node).isContentEditable&&node.nodeName!=="T");if(isEmptyBlock(range.endContainer)){selectionNodes.push(range.endContainer,...descendants(range.endContainer));}
const selectedNodes=mode==="backgroundColor"?selectionNodes.filter(node=>!closestElement(node,'table.o_selected_table')):selectionNodes;const selectedFieldNodes=new Set(getSelectedNodes(editor.editable).map(n=>closestElement(n,"*[t-field],*[t-out],*[t-esc]")).filter(Boolean));function getFonts(selectedNodes){return selectedNodes.flatMap(node=>{let font=closestElement(node,'font')||closestElement(node,'span');const children=font&&descendants(font);if(font&&(font.nodeName==='FONT'||(font.nodeName==='SPAN'&&font.style[mode]))){const selectedChildren=children.filter(child=>selectedNodes.includes(child));if(selectedChildren.length){font=splitAroundUntil(selectedChildren,font);}else{font=[];}}else if((node.nodeType===Node.TEXT_NODE&&!isWhitespace(node)&&node.textContent!=='\ufeff')||(node.nodeName==='BR'&&isEmptyBlock(node.parentNode))||(node.nodeType===Node.ELEMENT_NODE&&node.nodeName!=='FIGURE'&&['inline','inline-block'].includes(getComputedStyle(node).display)&&!isWhitespace(node.textContent)&&!node.classList.contains('btn')&&!node.querySelector('font'))&&node.nodeName!=='A'&&!(node.nodeName==='SPAN'&&node.style['fontSize'])){const previous=node.previousSibling;const classRegex=mode==='color'?BG_CLASSES_REGEX:TEXT_CLASSES_REGEX;if(previous&&previous.nodeName==='FONT'&&!previous.style[mode==='color'?'backgroundColor':'color']&&!classRegex.test(previous.className)&&selectedNodes.includes(previous.firstChild)&&selectedNodes.includes(previous.lastChild)){font=previous;}else{font=document.createElement('font');node.after(font);}
if(node.textContent){font.appendChild(node);}else{fillEmpty(font);}}else{font=[];}
return font;});}
for(const fieldNode of selectedFieldNodes){colorElement(fieldNode,color,mode);}
let fonts=getFonts(selectedNodes);if(!fonts.every((font)=>font.isConnected)){fonts=getFonts(selectedNodes);}
const fontsSet=new Set(fonts);for(const font of fontsSet){colorElement(font,color,mode);if((!hasColor(font,'color')&&!hasColor(font,'backgroundColor'))&&(!font.hasAttribute('style')||!color)){for(const child of[...font.childNodes]){font.parentNode.insertBefore(child,font);}
font.parentNode.removeChild(font);fontsSet.delete(font);}}
restoreCursor();if(wasCollapsed){const newSelection=editor.document.getSelection();const range=new Range();range.setStart(newSelection.anchorNode,newSelection.anchorOffset);range.collapse(true);newSelection.removeAllRanges();newSelection.addRange(range);}
return[...fontsSet,...coloredTds];},insertTable:(editor,{rowNumber=2,colNumber=2}={})=>{const tdsHtml=new Array(colNumber).fill('<td><p><br></p></td>').join('');const trsHtml=new Array(rowNumber).fill(`<tr>${tdsHtml}</tr>`).join('');const tableHtml=`<table class="table table-bordered o_table"><tbody>${trsHtml}</tbody></table>`;const sel=editor.document.getSelection();if(!sel.isCollapsed){editor.deleteRange(sel);}
while(!isBlock(sel.anchorNode)){const anchorNode=sel.anchorNode;const isTextNode=anchorNode.nodeType===Node.TEXT_NODE;const newAnchorNode=isTextNode?splitTextNode(anchorNode,sel.anchorOffset,DIRECTIONS.LEFT)+1&&anchorNode:splitElement(anchorNode,sel.anchorOffset).shift();const newPosition=rightPos(newAnchorNode);setSelection(...newPosition,...newPosition,false);}
const[table]=editorCommands.insert(editor,parseHTML(editor.document,tableHtml));setCursorStart(table.querySelector('p'));},addColumn:(editor,beforeOrAfter,referenceCell)=>{if(!referenceCell){getDeepRange(editor.editable,{select:true});referenceCell=getInSelection(editor.document,'td');if(!referenceCell)return;}
const columnIndex=getColumnIndex(referenceCell);const table=closestElement(referenceCell,'table');const tableWidth=table.style.width?pxToFloat(table.style.width):table.clientWidth;const referenceColumn=table.querySelectorAll(`tr td:nth-of-type(${columnIndex + 1})`);const referenceCellWidth=referenceCell.style.width?pxToFloat(referenceCell.style.width):referenceCell.clientWidth;const firstRow=table.querySelector('tr');const firstRowCells=[...firstRow.children].filter(child=>child.nodeName==='TD'||child.nodeName==='TH');let totalWidth=0;for(const cell of firstRowCells){const width=cell.style.width?pxToFloat(cell.style.width):cell.clientWidth;cell.style.width=width+'px';const newWidth=Math.max(Math.round((width*tableWidth)/(tableWidth+referenceCellWidth-1)),13);cell.style.width=newWidth+'px';totalWidth+=newWidth;}
referenceColumn.forEach((cell,rowIndex)=>{const newCell=document.createElement('td');const p=document.createElement('p');p.append(document.createElement('br'));newCell.append(p);cell[beforeOrAfter](newCell);if(rowIndex===0){newCell.style.width=cell.style.width;totalWidth+=pxToFloat(cell.style.width);}});if(totalWidth!==tableWidth-1){firstRowCells[firstRowCells.length-1].style.width=pxToFloat(firstRowCells[firstRowCells.length-1].style.width)+(tableWidth-totalWidth-1)+'px';}
table.style.width=tableWidth+'px';},addRow:(editor,beforeOrAfter,referenceRow)=>{if(!referenceRow){getDeepRange(editor.editable,{select:true});referenceRow=getInSelection(editor.document,'tr');if(!referenceRow)return;}
const referenceRowHeight=referenceRow.style.height?pxToFloat(referenceRow.style.height):referenceRow.clientHeight;const newRow=document.createElement('tr');newRow.style.height=referenceRowHeight+'px';const cells=referenceRow.querySelectorAll('td');newRow.append(...Array.from(Array(cells.length)).map(()=>{const td=document.createElement('td');const p=document.createElement('p');p.append(document.createElement('br'));td.append(p);return td;}));referenceRow[beforeOrAfter](newRow);newRow.style.height=referenceRowHeight+'px';if(getRowIndex(newRow)===0){let columnIndex=0;for(const newColumn of newRow.children){newColumn.style.width=cells[columnIndex].style.width;cells[columnIndex].style.width='';columnIndex++;}}},removeColumn:(editor,cell)=>{if(!cell){getDeepRange(editor.editable,{select:true});cell=getInSelection(editor.document,'td');if(!cell)return;}
const table=closestElement(cell,'table');const cells=[...closestElement(cell,'tr').querySelectorAll('th, td')];const index=cells.findIndex(td=>td===cell);const siblingCell=cells[index-1]||cells[index+1];if(table.style.width){const tableRect=table.getBoundingClientRect();const cellRect=cell.getBoundingClientRect();table.style.width=tableRect.width-cellRect.width+'px';}
table.querySelectorAll(`tr td:nth-of-type(${index + 1})`).forEach(td=>td.remove());siblingCell?setSelection(...startPos(siblingCell)):editorCommands.deleteTable(editor,table);},removeRow:(editor,row)=>{if(!row){getDeepRange(editor.editable,{select:true});row=getInSelection(editor.document,'tr');if(!row)return;}
const table=closestElement(row,'table');const rows=[...table.querySelectorAll('tr')];const rowIndex=rows.findIndex(tr=>tr===row);const siblingRow=rows[rowIndex-1]||rows[rowIndex+1];row.remove();siblingRow?setSelection(...startPos(siblingRow)):editorCommands.deleteTable(editor,table);},resetSize:(editor,table)=>{if(!table){getDeepRange(editor.editable,{select:true});table=getInSelection(editor.document,'table');}
table.removeAttribute('style');const cells=[...table.querySelectorAll('tr, td')];cells.forEach(cell=>{const cStyle=cell.style;if(cell.tagName==='TR'){cStyle.height='';}else{cStyle.width='';}})},deleteTable:(editor,table)=>{table=table||getInSelection(editor.document,'table');if(!table)return;const p=document.createElement('p');p.appendChild(document.createElement('br'));table.before(p);table.remove();setSelection(p,0);},columnize:(editor,numberOfColumns,addParagraphAfter=true)=>{const sel=editor.document.getSelection();const anchor=sel.anchorNode;const hasColumns=!!closestElement(anchor,'.o_text_columns');if(!numberOfColumns&&hasColumns){const restore=preserveCursor(editor.document);const container=closestElement(anchor,'.o_text_columns');const rows=unwrapContents(container);for(const row of rows){const columns=unwrapContents(row);for(const column of columns){const columnContents=unwrapContents(column);for(const node of columnContents){resetOuids(node);}}}
restore();}else if(numberOfColumns&&!hasColumns){const restore=preserveCursor(editor.document);const container=document.createElement('div');if(!closestElement(anchor,'.container')){container.classList.add('container');}
container.classList.add('o_text_columns');const row=document.createElement('div');row.classList.add('row');container.append(row);const block=closestBlock(anchor);resetOuids(block);const columnSize=Math.floor(12/numberOfColumns);const columns=[];for(let i=0;i<numberOfColumns;i++){const column=document.createElement('div');column.classList.add(`col-${columnSize}`);row.append(column);columns.push(column);}
block.before(container);columns.shift().append(block);for(const column of columns){const p=document.createElement('p');p.append(document.createElement('br'));p.classList.add('oe-hint');p.setAttribute('placeholder','New column...');column.append(p);}
restore();if(addParagraphAfter){const p=document.createElement('p');p.append(document.createElement('br'));container.after(p);}}else if(numberOfColumns&&hasColumns){const row=closestElement(anchor,'.row');const columns=[...row.children];const columnSize=Math.floor(12/numberOfColumns);const diff=numberOfColumns-columns.length;if(diff>0){const restore=preserveCursor(editor.document);for(const column of columns){column.className=column.className.replace(REGEX_BOOTSTRAP_COLUMN,`col$1-${columnSize}`);}
let lastColumn=columns[columns.length-1];for(let i=0;i<diff;i++){const column=document.createElement('div');column.classList.add(`col-${columnSize}`);const p=document.createElement('p');p.append(document.createElement('br'));p.classList.add('oe-hint');p.setAttribute('placeholder','New column...');column.append(p);lastColumn.after(column);lastColumn=column;}
restore();}else if(diff<0){const restore=preserveCursor(editor.document);for(const column of columns){column.className=column.className.replace(REGEX_BOOTSTRAP_COLUMN,`col$1-${columnSize}`);}
const contents=[];for(let i=diff;i<0;i++){const column=columns.pop();const columnContents=unwrapContents(column);for(const node of columnContents){resetOuids(node);}
contents.unshift(...columnContents);}
columns[columns.length-1].append(...contents);restore();}}},insertHorizontalRule(editor){const selection=editor.document.getSelection();const range=selection.getRangeAt(0);const element=closestElement(range.startContainer,paragraphRelatedElements)||closestBlock(range.startContainer);if(element&&ancestors(element).includes(editor.editable)){element.before(editor.document.createElement('hr'));}},};return __exports;});;

/* /web_editor/static/src/js/editor/odoo-editor/src/commands/deleteBackward.js */
odoo.define('@web_editor/js/editor/odoo-editor/src/commands/deleteBackward',['@web_editor/js/editor/odoo-editor/src/utils/constants','@web_editor/js/editor/odoo-editor/src/commands/deleteForward','@web_editor/js/editor/odoo-editor/src/utils/utils'],function(require){'use strict';let __exports={};const{UNBREAKABLE_ROLLBACK_CODE,UNREMOVABLE_ROLLBACK_CODE,REGEX_BOOTSTRAP_COLUMN}=require("@web_editor/js/editor/odoo-editor/src/utils/constants");const{deleteText}=require("@web_editor/js/editor/odoo-editor/src/commands/deleteForward");const{boundariesOut,childNodeIndex,CTGROUPS,CTYPES,DIRECTIONS,endPos,fillEmpty,getState,isBlock,isEmptyBlock,isUnbreakable,isUnremovable,isVisible,leftPos,rightPos,moveNodes,nodeSize,paragraphRelatedElements,prepareUpdate,setSelection,isMediaElement,isSelfClosingElement,isNotEditableNode,createDOMPathGenerator,closestElement,closestBlock,getOffsetAndCharSize,ZERO_WIDTH_CHARS,}=require("@web_editor/js/editor/odoo-editor/src/utils/utils");Text.prototype.oDeleteBackward=function(offset,alreadyMoved=false){const parentElement=this.parentElement;if(!offset){parentElement.oDeleteBackward([...parentElement.childNodes].indexOf(this),alreadyMoved);return;}
const[newOffset,charSize]=getOffsetAndCharSize(this.nodeValue,offset,DIRECTIONS.LEFT);deleteText.call(this,charSize,newOffset-charSize,DIRECTIONS.LEFT,alreadyMoved);};const isDeletable=(node)=>{return isMediaElement(node)||isNotEditableNode(node);}
HTMLElement.prototype.oDeleteBackward=function(offset,alreadyMoved=false,offsetLimit){const contentIsZWS=ZERO_WIDTH_CHARS.includes(this.textContent);let moveDest;if(offset){const leftNode=this.childNodes[offset-1];if(isUnremovable(leftNode)){throw UNREMOVABLE_ROLLBACK_CODE;}
if(isDeletable(leftNode)){leftNode.remove();return;}
if(!isBlock(leftNode)||isSelfClosingElement(leftNode)){leftNode.oDeleteBackward(nodeSize(leftNode),alreadyMoved);return;}
alreadyMoved=true;moveDest=endPos(leftNode);}else{if(isUnremovable(this)){throw UNREMOVABLE_ROLLBACK_CODE;}
if(isUnbreakable(this)&&(REGEX_BOOTSTRAP_COLUMN.test(this.className)||!isEmptyBlock(this))){throw UNBREAKABLE_ROLLBACK_CODE;}
const parentEl=this.parentElement;if(parentEl&&parentEl.getAttribute("contenteditable")==="true"&&parentEl.oid!=="root"&&parentEl.parentElement&&!parentEl.parentElement.isContentEditable&&paragraphRelatedElements.includes(this.tagName)&&!this.previousElementSibling){throw UNREMOVABLE_ROLLBACK_CODE;}
const closestLi=closestElement(this,'li');if((closestLi&&!closestLi.previousElementSibling)||!isBlock(this)||isSelfClosingElement(this)){const parentOffset=childNodeIndex(this);if(!nodeSize(this)||contentIsZWS){const visible=isVisible(this);const restore=prepareUpdate(...boundariesOut(this));this.remove();restore();fillEmpty(parentEl);if(visible){setSelection(parentEl,parentOffset);return;}}
parentEl.oDeleteBackward(parentOffset,alreadyMoved);return;}
const previousElementSiblingClosestBlock=closestBlock(this.previousElementSibling);if(previousElementSiblingClosestBlock&&(isEmptyBlock(previousElementSiblingClosestBlock)||previousElementSiblingClosestBlock.textContent==='\u200B')&&paragraphRelatedElements.includes(this.nodeName)){previousElementSiblingClosestBlock.remove();setSelection(this,0);return;}
if(!this.previousElementSibling&&paragraphRelatedElements.includes(this.nodeName)&&this.nodeName!=='P'&&!closestLi){if(!this.textContent){const p=document.createElement('p');p.replaceChildren(...this.childNodes);this.replaceWith(p);setSelection(p,offset);}
return;}else{moveDest=leftPos(this);}}
const domPathGenerator=createDOMPathGenerator(DIRECTIONS.LEFT,{leafOnly:true,stopTraverseFunction:isDeletable,});const domPath=domPathGenerator(this,offset)
const leftNode=domPath.next().value;if(leftNode&&isDeletable(leftNode)){const[parent,offset]=rightPos(leftNode);return parent.oDeleteBackward(offset,alreadyMoved);}
let node=this.childNodes[offset];const nextSibling=this.nextSibling;let currentNodeIndex=offset;if(offsetLimit===undefined){while(node&&!isBlock(node)){node=node.nextSibling;currentNodeIndex++;}}else{currentNodeIndex=offsetLimit;}
let[cursorNode,cursorOffset]=moveNodes(...moveDest,this,offset,currentNodeIndex);setSelection(cursorNode,cursorOffset);if(cursorNode.nodeType===Node.TEXT_NODE&&(cursorOffset===0||cursorOffset===cursorNode.length)){cursorOffset=childNodeIndex(cursorNode)+(cursorOffset===0?0:1);cursorNode=cursorNode.parentNode;}
if(cursorNode.nodeType!==Node.TEXT_NODE){const{cType}=getState(cursorNode,cursorOffset,DIRECTIONS.LEFT);if(cType&CTGROUPS.BLOCK&&(!alreadyMoved||cType===CTYPES.BLOCK_OUTSIDE)){cursorNode.oDeleteBackward(cursorOffset,alreadyMoved,cursorOffset+currentNodeIndex-offset);}else if(!alreadyMoved){const cursorNodeNode=cursorNode.childNodes[cursorOffset];const cursorNodeRightNode=cursorNodeNode?cursorNodeNode.nextSibling:undefined;if(cursorNodeRightNode&&cursorNodeRightNode.nodeType===Node.TEXT_NODE&&nextSibling===cursorNodeRightNode){moveDest[0].insertBefore(document.createElement('br'),cursorNodeRightNode);}}}};HTMLLIElement.prototype.oDeleteBackward=function(offset,alreadyMoved=false){if(offset===0){this.oToggleList(offset);return;}
HTMLElement.prototype.oDeleteBackward.call(this,offset,alreadyMoved);};HTMLBRElement.prototype.oDeleteBackward=function(offset,alreadyMoved=false){const parentOffset=childNodeIndex(this);const rightState=getState(this.parentElement,parentOffset+1,DIRECTIONS.RIGHT).cType;if(rightState&CTYPES.BLOCK_INSIDE){this.parentElement.oDeleteBackward(parentOffset,alreadyMoved);}else{HTMLElement.prototype.oDeleteBackward.call(this,offset,alreadyMoved);}};HTMLTableCellElement.prototype.oDeleteBackward=function(offset,alreadyMoved=false){if(offset){HTMLElement.prototype.oDeleteBackward.call(this,offset,alreadyMoved);}};return __exports;});;

/* /web_editor/static/src/js/editor/odoo-editor/src/commands/deleteForward.js */
odoo.define('@web_editor/js/editor/odoo-editor/src/commands/deleteForward',['@web_editor/js/editor/odoo-editor/src/utils/constants','@web_editor/js/editor/odoo-editor/src/utils/utils'],function(require){'use strict';let __exports={};const{UNREMOVABLE_ROLLBACK_CODE}=require("@web_editor/js/editor/odoo-editor/src/utils/constants");const{findNode,isSelfClosingElement,nodeSize,rightPos,getState,DIRECTIONS,CTYPES,leftPos,isFontAwesome,rightLeafOnlyNotBlockNotEditablePath,rightLeafOnlyPathNotBlockNotEditablePath,isNotEditableNode,splitTextNode,paragraphRelatedElements,prepareUpdate,isInPre,fillEmpty,setSelection,isZWS,childNodeIndex,boundariesOut,isEditorTab,isVisible,isUnbreakable,isEmptyBlock,isWhitespace,isVisibleTextNode,getOffsetAndCharSize,ZERO_WIDTH_CHARS,}=require("@web_editor/js/editor/odoo-editor/src/utils/utils");__exports.deleteText=deleteText;function deleteText(charSize,offset,direction,alreadyMoved){const parentElement=this.parentElement;const firstSplitOffset=splitTextNode(this,offset);const secondSplitOffset=splitTextNode(parentElement.childNodes[firstSplitOffset],charSize);const middleNode=parentElement.childNodes[firstSplitOffset];const restore=prepareUpdate(parentElement,firstSplitOffset,parentElement,secondSplitOffset);const isSpace=isWhitespace(middleNode)&&!isInPre(middleNode);const isZWS=ZERO_WIDTH_CHARS.includes(middleNode.nodeValue);middleNode.remove();restore();const parentState=getState(parentElement,firstSplitOffset,direction);if(isZWS||(isSpace&&(parentState.cType!==CTYPES.CONTENT||parentState.node===undefined))){if(direction===DIRECTIONS.LEFT){parentElement.oDeleteBackward(firstSplitOffset,alreadyMoved);}else{if(isSpace&&parentState.node==undefined){this.oDeleteForward(offset,alreadyMoved);}else{parentElement.oDeleteForward(firstSplitOffset,alreadyMoved);}}
if(isZWS&&parentElement.isConnected){fillEmpty(parentElement);}
return;}
fillEmpty(parentElement);setSelection(parentElement,firstSplitOffset);}
Text.prototype.oDeleteForward=function(offset,alreadyMoved=false){const parentElement=this.parentElement;if(offset===this.nodeValue.length){parentElement.oDeleteForward([...parentElement.childNodes].indexOf(this)+1);return;}
const[newOffset,charSize]=getOffsetAndCharSize(this.nodeValue,offset+1,DIRECTIONS.RIGHT);deleteText.call(this,charSize,newOffset,DIRECTIONS.RIGHT,alreadyMoved);};HTMLElement.prototype.oDeleteForward=function(offset){const filterFunc=node=>isSelfClosingElement(node)||isVisibleTextNode(node)||isNotEditableNode(node);const firstLeafNode=findNode(rightLeafOnlyNotBlockNotEditablePath(this,offset),filterFunc);if(firstLeafNode&&isZWS(firstLeafNode)&&this.parentElement.hasAttribute('data-oe-zws-empty-inline')){const grandparent=this.parentElement.parentElement;if(!grandparent){return;}
const parentIndex=childNodeIndex(this.parentElement);const restore=prepareUpdate(...boundariesOut(this.parentElement));this.parentElement.remove();restore();HTMLElement.prototype.oDeleteForward.call(grandparent,parentIndex);return;}else if(firstLeafNode&&firstLeafNode.nodeType===Node.TEXT_NODE&&firstLeafNode.textContent==='\ufeff'){firstLeafNode.oDeleteForward(1);return;}
if(this.hasAttribute&&this.hasAttribute('data-oe-zws-empty-inline')&&(isZWS(this)||(this.textContent===''&&this.childNodes.length===0))){const parent=this.parentElement;if(!parent){return;}
const index=childNodeIndex(this);const restore=prepareUpdate(...boundariesOut(this));this.remove();restore();HTMLElement.prototype.oDeleteForward.call(parent,index);return;}
if(firstLeafNode&&(isFontAwesome(firstLeafNode)||isNotEditableNode(firstLeafNode))){const nextSibling=firstLeafNode.nextSibling;const nextSiblingText=nextSibling?nextSibling.textContent:'';firstLeafNode.remove();if(isEditorTab(firstLeafNode)&&nextSiblingText[0]==='\u200B'){nextSibling.textContent=nextSiblingText.replace('\u200B','');}
return;}
if(firstLeafNode&&(firstLeafNode.nodeName!=='BR'||getState(...rightPos(firstLeafNode),DIRECTIONS.RIGHT).cType!==CTYPES.BLOCK_INSIDE)){firstLeafNode.oDeleteBackward(Math.min(1,nodeSize(firstLeafNode)));return;}
const nextSibling=this.nextSibling;if((offset===this.childNodes.length||(this.childNodes.length===1&&this.childNodes[0].tagName==='BR'))&&this.parentElement&&nextSibling&&['LI','UL','OL'].includes(nextSibling.tagName)){const nextSiblingNestedLi=nextSibling.querySelector('li:first-child');if(nextSiblingNestedLi){this.after(nextSiblingNestedLi);if(!isVisible(nextSibling,false)||nextSibling.textContent===''){nextSibling.remove();}
HTMLElement.prototype.oDeleteBackward.call(nextSiblingNestedLi,0,true);}else{HTMLElement.prototype.oDeleteBackward.call(nextSibling,0);}
return;}
if(nextSibling&&nextSibling.nodeType===Node.ELEMENT_NODE&&!nextSibling.isContentEditable){nextSibling.remove();return;}
const parentEl=this.parentElement;if(parentEl&&parentEl.getAttribute("contenteditable")==="true"&&parentEl.oid!=="root"&&parentEl.parentElement&&!parentEl.parentElement.isContentEditable&&paragraphRelatedElements.includes(this.tagName)&&!this.nextElementSibling){throw UNREMOVABLE_ROLLBACK_CODE;}
const firstOutNode=findNode(rightLeafOnlyPathNotBlockNotEditablePath(...(firstLeafNode?rightPos(firstLeafNode):[this,offset]),),filterFunc,);if(firstOutNode){if(nextSibling&&isUnbreakable(nextSibling)&&isEmptyBlock(this)){const restore=prepareUpdate(...boundariesOut(this));this.remove();restore();setSelection(firstOutNode,0);return;}
const[node,offset]=leftPos(firstOutNode);if(node.tagName==='LI'){HTMLElement.prototype.oDeleteBackward.call(node,offset);return;}
node.oDeleteBackward(offset);return;}};return __exports;});;

/* /web_editor/static/src/js/editor/odoo-editor/src/commands/enter.js */
odoo.define('@web_editor/js/editor/odoo-editor/src/commands/enter',['@web_editor/js/editor/odoo-editor/src/utils/constants','@web_editor/js/editor/odoo-editor/src/utils/utils'],function(require){'use strict';let __exports={};const{UNBREAKABLE_ROLLBACK_CODE}=require("@web_editor/js/editor/odoo-editor/src/utils/constants");const{childNodeIndex,fillEmpty,isBlock,isUnbreakable,prepareUpdate,setCursorStart,setCursorEnd,setTagName,splitTextNode,toggleClass,isVisible,descendants,isVisibleTextNode,nodeSize,}=require("@web_editor/js/editor/odoo-editor/src/utils/utils");Text.prototype.oEnter=function(offset){this.parentElement.oEnter(splitTextNode(this,offset),true);};HTMLElement.prototype.oEnter=function(offset,firstSplit=true){let didSplit=false;if(isUnbreakable(this)){throw UNBREAKABLE_ROLLBACK_CODE;}
let restore;if(firstSplit){restore=prepareUpdate(this,offset);}
let splitEl=this.cloneNode(false);while(offset<this.childNodes.length){splitEl.appendChild(this.childNodes[offset]);}
if(isBlock(this)||splitEl.hasChildNodes()){this.after(splitEl);if(isBlock(splitEl)||isVisible(splitEl)||splitEl.textContent==='\u200B'){didSplit=true;}else{splitEl.remove();}}
if(!isBlock(this)||(this.nodeName!=='LI'&&this.closest('LI'))){if(this.parentElement){this.parentElement.oEnter(childNodeIndex(this)+1,!didSplit);}else{throw UNBREAKABLE_ROLLBACK_CODE;}}
if(firstSplit&&didSplit){restore();let node=this;while(!isBlock(node)&&!isVisible(node)){const toRemove=node;node=node.parentNode;toRemove.remove();}
fillEmpty(node);fillEmpty(splitEl);if(splitEl.tagName==='A'){while(!isBlock(splitEl)&&!isVisible(splitEl)){const toRemove=splitEl;splitEl=splitEl.parentNode;toRemove.remove();}}
setCursorStart(splitEl);}
return splitEl;};HTMLHeadingElement.prototype.oEnter=function(){const newEl=HTMLElement.prototype.oEnter.call(this,...arguments);if(!descendants(newEl).some(isVisibleTextNode)){const node=setTagName(newEl,'P');node.replaceChildren(document.createElement('br'));setCursorStart(node);}};const isAtEdgeofLink=(link,offset)=>{const childNodes=[...link.childNodes];let firstVisibleIndex=childNodes.findIndex(isVisible);firstVisibleIndex=firstVisibleIndex===-1?0:firstVisibleIndex;if(offset<=firstVisibleIndex){return'start';}
let lastVisibleIndex=childNodes.reverse().findIndex(isVisible);lastVisibleIndex=lastVisibleIndex===-1?0:childNodes.length-lastVisibleIndex;if(offset>=lastVisibleIndex){return'end';}
return false;}
HTMLAnchorElement.prototype.oEnter=function(offset){const edge=isAtEdgeofLink(this,offset);if(edge==='start'){if(this.previousSibling){return HTMLElement.prototype.oEnter.call(this.previousSibling,nodeSize(this.previousSibling));}else{const index=childNodeIndex(this);return HTMLElement.prototype.oEnter.call(this.parentElement,index?index-1:0);}}else if(edge==='end'){if(this.nextSibling){return HTMLElement.prototype.oEnter.call(this.nextSibling,0);}else{return HTMLElement.prototype.oEnter.call(this.parentElement,childNodeIndex(this));}}else{HTMLElement.prototype.oEnter.call(this,...arguments);}}
HTMLQuoteElement.prototype.oEnter=HTMLHeadingElement.prototype.oEnter;HTMLLIElement.prototype.oEnter=function(){if(this.textContent){const node=HTMLElement.prototype.oEnter.call(this,...arguments);if(node.classList.contains('o_checked')){toggleClass(node,'o_checked');}
return node;}
this.oShiftTab();};HTMLPreElement.prototype.oEnter=function(offset){if(offset<this.childNodes.length){const lineBreak=document.createElement('br');this.insertBefore(lineBreak,this.childNodes[offset]);setCursorEnd(lineBreak);}else{const node=document.createElement('p');this.parentNode.insertBefore(node,this.nextSibling);fillEmpty(node);setCursorStart(node);}};return __exports;});;

/* /web_editor/static/src/js/editor/odoo-editor/src/commands/shiftEnter.js */
odoo.define('@web_editor/js/editor/odoo-editor/src/commands/shiftEnter',['@web_editor/js/editor/odoo-editor/src/utils/utils'],function(require){'use strict';let __exports={};const{CTYPES,DIRECTIONS,isFakeLineBreak,prepareUpdate,rightPos,setSelection,getState,leftPos,splitTextNode,}=require("@web_editor/js/editor/odoo-editor/src/utils/utils");Text.prototype.oShiftEnter=function(offset){return this.parentElement.oShiftEnter(splitTextNode(this,offset));};HTMLElement.prototype.oShiftEnter=function(offset){const restore=prepareUpdate(this,offset);const brEl=document.createElement('br');const brEls=[brEl];if(offset>=this.childNodes.length){this.appendChild(brEl);}else{this.insertBefore(brEl,this.childNodes[offset]);}
if(isFakeLineBreak(brEl)&&getState(...leftPos(brEl),DIRECTIONS.LEFT).cType!==CTYPES.BR){const brEl2=document.createElement('br');brEl.before(brEl2);brEls.unshift(brEl2);}
restore();for(const el of brEls){if(el.parentNode){setSelection(...rightPos(el));break;}}
return brEls;};HTMLAnchorElement.prototype.oShiftEnter=function(){const brs=HTMLElement.prototype.oShiftEnter.call(this,...arguments);const anchor=brs[0].parentElement;let firstChild=anchor.firstChild;if(firstChild&&firstChild.nodeType===Node.TEXT_NODE&&firstChild.textContent==='\uFEFF'){firstChild=anchor.childNodes[1];}
let lastChild=anchor.lastChild;if(lastChild&&lastChild.nodeType===Node.TEXT_NODE&&lastChild.textContent==='\uFEFF'){lastChild=anchor.childNodes.length>1&&anchor.childNodes[anchor.childNodes.length-2];}
if(brs.includes(firstChild)){brs.forEach(br=>anchor.before(br));setSelection(...rightPos(brs[brs.length-1]));}else if(brs.includes(lastChild)){brs.forEach(br=>anchor.after(br));setSelection(...rightPos(brs[0]));}}
return __exports;});;

/* /web_editor/static/src/js/editor/odoo-editor/src/commands/shiftTab.js */
odoo.define('@web_editor/js/editor/odoo-editor/src/commands/shiftTab',['@web_editor/js/editor/odoo-editor/src/utils/utils'],function(require){'use strict';let __exports={};const{isUnbreakable,preserveCursor,toggleClass,isBlock,isVisible}=require("@web_editor/js/editor/odoo-editor/src/utils/utils");Text.prototype.oShiftTab=function(){return this.parentElement.oShiftTab(0);};HTMLElement.prototype.oShiftTab=function(offset=undefined){if(!isUnbreakable(this)){return this.parentElement.oShiftTab(offset);}
return false;};HTMLLIElement.prototype.oShiftTab=function(){const li=this;if(li.nextElementSibling){const ul=li.parentElement.cloneNode(false);while(li.nextSibling){ul.append(li.nextSibling);}
if(li.parentNode.parentNode.tagName==='LI'){const lip=document.createElement('li');toggleClass(lip,'oe-nested');lip.append(ul);li.parentNode.parentNode.after(lip);}else{li.parentNode.after(ul);}}
const restoreCursor=preserveCursor(this.ownerDocument);if(li.parentNode.parentNode.tagName==='LI'&&!li.parentNode.parentNode.classList.contains('nav-item')){const ul=li.parentNode;const shouldRemoveParentLi=!li.previousElementSibling&&!ul.previousElementSibling;const toremove=shouldRemoveParentLi?ul.parentNode:null;ul.parentNode.after(li);if(toremove){if(toremove.classList.contains('oe-nested')){toremove.remove();}else{ul.remove();}}
restoreCursor();return li;}else{const ul=li.parentNode;const dir=ul.getAttribute('dir');let p;while(li.firstChild){if(isBlock(li.firstChild)){if(p&&isVisible(p)){ul.after(p);}
p=undefined;ul.after(li.firstChild);}else{p=p||document.createElement('P');if(dir){p.setAttribute('dir',dir);p.style.setProperty('text-align',ul.style.getPropertyValue('text-align'));}
p.append(li.firstChild);}}
if(p&&isVisible(p)){ul.after(p)}
restoreCursor(new Map([[li,ul.nextSibling]]));li.remove();if(!ul.firstElementChild){ul.remove();}}
return false;};return __exports;});;

/* /web_editor/static/src/js/editor/odoo-editor/src/commands/tab.js */
odoo.define('@web_editor/js/editor/odoo-editor/src/commands/tab',['@web_editor/js/editor/odoo-editor/src/utils/utils'],function(require){'use strict';let __exports={};const{createList,getListMode,isBlock,preserveCursor,toggleClass}=require("@web_editor/js/editor/odoo-editor/src/utils/utils");Text.prototype.oTab=function(){return this.parentElement.oTab(0);};HTMLElement.prototype.oTab=function(offset){if(!isBlock(this)){return this.parentElement.oTab(offset);}
return false;};HTMLLIElement.prototype.oTab=function(){const lip=document.createElement('li');const destul=(this.previousElementSibling&&this.previousElementSibling.querySelector('ol, ul'))||(this.nextElementSibling&&this.nextElementSibling.querySelector('ol, ul'))||this.closest('ul, ol');const ul=createList(getListMode(destul));lip.append(ul);const cr=preserveCursor(this.ownerDocument);toggleClass(lip,'oe-nested');this.before(lip);ul.append(this);cr();return true;};return __exports;});;

/* /web_editor/static/src/js/editor/odoo-editor/src/commands/toggleList.js */
odoo.define('@web_editor/js/editor/odoo-editor/src/commands/toggleList',['@web_editor/js/editor/odoo-editor/src/utils/utils'],function(require){'use strict';let __exports={};const{childNodeIndex,getListMode,isBlock,preserveCursor,setTagName,toggleClass,insertListAfter,getAdjacents,closestElement,}=require("@web_editor/js/editor/odoo-editor/src/utils/utils");Text.prototype.oToggleList=function(offset,mode){if(closestElement(this,'li').classList.contains('nav-item')){const restoreCursor=preserveCursor(this.ownerDocument);insertListAfter(this,mode,[this]);restoreCursor();}else{this.parentElement.oToggleList(childNodeIndex(this),mode);}};HTMLElement.prototype.oToggleList=function(offset,mode='UL'){if(!isBlock(this)){return this.parentElement.oToggleList(childNodeIndex(this));}
const closestLi=this.closest('li');if(closestLi&&!closestLi.classList.contains('nav-item')){return closestLi.oToggleList(0,mode);}
const restoreCursor=preserveCursor(this.ownerDocument);if(this.oid==='root'){const callingNode=this.childNodes[offset];const group=getAdjacents(callingNode,n=>!isBlock(n));insertListAfter(callingNode,mode,[group]);restoreCursor();}else{const list=insertListAfter(this,mode,[this]);if(this.hasAttribute('dir')){list.setAttribute('dir',this.getAttribute('dir'));}
restoreCursor(new Map([[this,list.firstElementChild]]));}};HTMLParagraphElement.prototype.oToggleList=function(offset,mode='UL'){const restoreCursor=preserveCursor(this.ownerDocument);const list=insertListAfter(this,mode,[[...this.childNodes]]);const classList=[...list.classList];for(const attribute of this.attributes){if(attribute.name==='class'&&attribute.value&&list.className){list.className=`${list.className} ${attribute.value}`;}else{list.setAttribute(attribute.name,attribute.value);}}
for(const className of classList){list.classList.toggle(className,true);}
this.remove();restoreCursor(new Map([[this,list.firstChild]]));return true;};HTMLLIElement.prototype.oToggleList=function(offset,mode){const pnode=this.closest('ul, ol');if(!pnode)return;const restoreCursor=preserveCursor(this.ownerDocument);const listMode=getListMode(pnode)+mode;if(['OLCL','ULCL'].includes(listMode)){pnode.classList.add('o_checklist');for(let li=pnode.firstElementChild;li!==null;li=li.nextElementSibling){if(li.style.listStyle!='none'){li.style.listStyle=null;if(!li.style.all)li.removeAttribute('style');}}
setTagName(pnode,'UL');}else if(['CLOL','CLUL'].includes(listMode)){toggleClass(pnode,'o_checklist');setTagName(pnode,mode);}else if(['OLUL','ULOL'].includes(listMode)){setTagName(pnode,mode);}else{let node=this;while(node){node=node.oShiftTab(offset);}}
restoreCursor();return false;};HTMLTableCellElement.prototype.oToggleList=function(offset,mode){const restoreCursor=preserveCursor(this.ownerDocument);const callingNode=this.childNodes[offset];const group=getAdjacents(callingNode,n=>!isBlock(n));insertListAfter(callingNode,mode,[group]);restoreCursor();};return __exports;});;

/* /web_editor/static/src/js/editor/odoo-editor/src/powerbox/Powerbox.js */
odoo.define('@web_editor/js/editor/odoo-editor/src/powerbox/Powerbox',['@web_editor/js/editor/odoo-editor/src/powerbox/patienceDiff','@web_editor/js/editor/odoo-editor/src/utils/utils'],function(require){'use strict';let __exports={};const{patienceDiff}=require("@web_editor/js/editor/odoo-editor/src/powerbox/patienceDiff");const{closestBlock,getRangePosition}=require("@web_editor/js/editor/odoo-editor/src/utils/utils");const REGEX_RESERVED_CHARS=/[\\^$.*+?()[\]{}|]/g;function cycle(num,max){const y=max+1;return((num%y)+y)%y;}
const Powerbox=__exports.Powerbox=class Powerbox{constructor({categories,commands,commandFilters,editable,getContextFromParentRect,onShow,onStop,beforeCommand,afterCommand}={}){this.categories=categories;this.commands=commands;this.commandFilters=commandFilters||[];this.editable=editable;this.getContextFromParentRect=getContextFromParentRect;this.onShow=onShow;this.onStop=onStop;this.beforeCommand=beforeCommand;this.afterCommand=afterCommand;this.isOpen=false;this.document=editable.ownerDocument;this.el=document.createElement('div');this.el.className='oe-powerbox-wrapper position-absolute overflow-hidden';this.el.style.display='none';document.body.append(this.el);this._mainWrapperElement=document.createElement('div');this._mainWrapperElement.className='oe-powerbox-mainWrapper flex-skrink-1 overflow-auto py-2';this.el.append(this._mainWrapperElement);this.el.addEventListener('mousedown',ev=>ev.stopPropagation());this._boundOnKeyup=this._onKeyup.bind(this);this._boundOnKeydown=this._onKeydown.bind(this);this._boundClose=this.close.bind(this);this._events=[[this.document,'keyup',this._boundOnKeyup],[this.document,'keydown',this._boundOnKeydown,true],[this.document,'mousedown',this._boundClose],]
if(document!==this.document){this._events.push([document,'mousedown',this._boundClose],);}}
destroy(){if(this.isOpen){this.close();}
this.el.remove();}
open(commands=this.commands,categories=this.categories){commands=(commands||[]).map(command=>({...command,category:command.category||'',name:command.name||'',priority:command.priority||0,description:command.description||'',callback:command.callback||(()=>{}),}));categories=(categories||[]).map(category=>({name:category.name||'',priority:category.priority||0,}));const order=(a,b)=>b.priority-a.priority||a.name.localeCompare(b.name);categories=[...categories].reverse().filter((category,index,cats)=>(cats.findIndex(cat=>cat.name===category.name)===index)).sort(order);for(let filter of this.commandFilters){commands=filter(commands);}
commands=commands.filter(command=>!command.isDisabled||!command.isDisabled()).sort(order);commands=this._groupCommands(commands,categories).flatMap(group=>group[1]);const selection=this.document.getSelection();const currentBlock=(selection&&closestBlock(selection.anchorNode))||this.editable;this._context={commands,categories,filteredCommands:commands,selectedCommand:undefined,initialTarget:currentBlock,initialValue:currentBlock.textContent,lastText:undefined,}
this.isOpen=true;this._render(this._context.commands,this._context.categories);this._bindEvents();this.show();}
close(){this.isOpen=false;this.hide();this._context=undefined;this._unbindEvents();this.onStop&&this.onStop();};show(){this.onShow&&this.onShow();this.el.style.display='flex';this._resetPosition();}
hide(){this.el.style.display='none';if(this.isOpen){this.close();}}
_render(commands,categories){const parser=new DOMParser();this._mainWrapperElement.innerHTML='';this._hoverActive=false;this._mainWrapperElement.classList.toggle('oe-powerbox-noResult',commands.length===0);this._context.selectedCommand=commands.find(command=>command===this._context.selectedCommand)||commands[0];for(const[category,categoryCommands]of this._groupCommands(commands,categories)){const categoryWrapperEl=parser.parseFromString(`
                <div class="oe-powerbox-categoryWrapper">
                    <div class="oe-powerbox-category mx-3 my-1 text-uppercase"></div>
                </div>`,'text/html').body.firstChild;this._mainWrapperElement.append(categoryWrapperEl);categoryWrapperEl.firstElementChild.innerText=category;for(const command of categoryCommands){const commandElWrapper=document.createElement('div');commandElWrapper.className='oe-powerbox-commandWrapper d-flex align-items-center px-3 py-2 cursor-pointer';commandElWrapper.classList.toggle('active',this._context.selectedCommand===command);commandElWrapper.replaceChildren(...parser.parseFromString(`
                    <div class="oe-powerbox-commandLeftCol border rounded">
                        <i class="oe-powerbox-commandImg d-flex align-items-center justify-content-center fa"></i>
                    </div>
                    <div class="oe-powerbox-commandRightCol ms-3">
                        <div class="oe-powerbox-commandName"></div>
                        <div class="oe-powerbox-commandDescription"></div>
                    </div>`,'text/html').body.children);commandElWrapper.querySelector('.oe-powerbox-commandImg').classList.add(command.fontawesome);commandElWrapper.querySelector('.oe-powerbox-commandName').innerText=command.name;commandElWrapper.querySelector('.oe-powerbox-commandDescription').innerText=command.description;categoryWrapperEl.append(commandElWrapper);commandElWrapper.addEventListener('mousemove',()=>{this.el.querySelector('.oe-powerbox-commandWrapper.active').classList.remove('active');this._context.selectedCommand=command;commandElWrapper.classList.add('active');});commandElWrapper.addEventListener('click',ev=>{ev.preventDefault();ev.stopImmediatePropagation();this._pickCommand(command);},true,);}}
if(this._mainWrapperElement.childElementCount===1){this._mainWrapperElement.querySelector('.oe-powerbox-category').style.display='none';}
this._resetPosition();}
async _pickCommand(command=this._context.selectedCommand){if(command){if(this.beforeCommand){await this.beforeCommand();}
await command.callback();if(this.afterCommand){await this.afterCommand();}}
this.close();};_groupCommands(commands,categories){const groups=[];for(const category of categories){const categoryCommands=commands.filter(command=>command.category===category.name);commands=commands.filter(command=>command.category!==category.name);groups.push([category.name,categoryCommands]);}
const remainingCategories=[...new Set(commands.map(command=>command.category))];for(const categoryName of remainingCategories.sort((a,b)=>a.localeCompare(b))){const categoryCommands=commands.filter(command=>command.category===categoryName);groups.push([categoryName,categoryCommands]);}
return groups.filter(group=>group[1].length);}
_orderByPriority(commandsOrCategories){return[...commandsOrCategories].sort((a,b)=>b.priority-a.priority||a.name.localeCompare(b.name));}
_resetPosition(){let options={};if(this.getContextFromParentRect){options['parentContextRect']=this.getContextFromParentRect();}
const position=getRangePosition(this.el,this.document,options);if(position){let{left,top}=position;this.el.style.left=`${left}px`;this.el.style.top=`${top}px`;}else{this.hide();}}
_bindEvents(){for(const[target,eventName,callback,option]of this._events){target.addEventListener(eventName,callback,option);}}
_unbindEvents(){for(const[target,eventName,callback,option]of this._events){target.removeEventListener(eventName,callback,option);}}
_onKeyup(ev){if(ev.key==='ArrowDown'||ev.key==='ArrowUp'){ev.preventDefault();}else{const diff=patienceDiff(this._context.initialValue.split(''),this._context.initialTarget.textContent.split(''),true,);this._context.lastText=diff.bMove.join('').replaceAll('\ufeff','');const selection=this.document.getSelection();if(this._context.lastText.match(/\s/)||!selection||this._context.initialTarget!==closestBlock(selection.anchorNode)){this.close();}else{const term=this._context.lastText.toLowerCase().replaceAll(/\s/g,'\\s').replaceAll('\u200B','').replace(REGEX_RESERVED_CHARS,'\\$&');if(term.length){const exactRegex=new RegExp(term,'i');const fuzzyRegex=new RegExp(term.match(/\\.|./g).join('.*'),'i');this._context.filteredCommands=this._context.commands.filter(command=>{const commandText=(command.category+' '+command.name);const commandDescription=command.description.replace(/\s/g,'');return commandText.match(fuzzyRegex)||commandDescription.match(exactRegex);});}else{this._context.filteredCommands=this._context.commands;}
this._render(this._context.filteredCommands,this._context.categories);}}}
_onKeydown(ev){if(ev.key==='Enter'){ev.stopImmediatePropagation();this._pickCommand();ev.preventDefault();}else if(ev.key==='Escape'){ev.stopImmediatePropagation();this.close();ev.preventDefault();}else if(ev.key==='Backspace'&&!this._context.lastText){this.close();}else if(ev.key==='ArrowDown'||ev.key==='ArrowUp'){ev.preventDefault();ev.stopImmediatePropagation();const commandIndex=this._context.filteredCommands.findIndex(command=>command===this._context.selectedCommand,);if(this._context.filteredCommands.length&&commandIndex!==-1){const nextIndex=commandIndex+(ev.key==='ArrowDown'?1:-1);const newIndex=cycle(nextIndex,this._context.filteredCommands.length-1);this._context.selectedCommand=this._context.filteredCommands[newIndex];}else{this._context.selectedCommand=undefined;}
this._render(this._context.filteredCommands,this._context.categories);const activeCommand=this.el.querySelector('.oe-powerbox-commandWrapper.active');if(activeCommand){activeCommand.scrollIntoView({block:'nearest',inline:'nearest'});}}}}
return __exports;});;

/* /web_editor/static/src/js/editor/odoo-editor/src/powerbox/patienceDiff.js */
odoo.define('@web_editor/js/editor/odoo-editor/src/powerbox/patienceDiff',[],function(require){'use strict';let __exports={};__exports.patienceDiff=patienceDiff;function patienceDiff(aLines,bLines,diffPlusFlag){function findUnique(arr,lo,hi){var lineMap=new Map();for(let i=lo;i<=hi;i++){let line=arr[i];if(lineMap.has(line)){lineMap.get(line).count++;lineMap.get(line).index=i;}else{lineMap.set(line,{count:1,index:i});}}
lineMap.forEach((val,key,map)=>{if(val.count!==1){map.delete(key);}else{map.set(key,val.index);}});return lineMap;}
function uniqueCommon(aArray,aLo,aHi,bArray,bLo,bHi){let ma=findUnique(aArray,aLo,aHi);let mb=findUnique(bArray,bLo,bHi);ma.forEach((val,key,map)=>{if(mb.has(key)){map.set(key,{indexA:val,indexB:mb.get(key)});}else{map.delete(key);}});return ma;}
function longestCommonSubsequence(abMap){var ja=[];abMap.forEach((val,key,map)=>{let i=0;while(ja[i]&&ja[i][ja[i].length-1].indexB<val.indexB){i++;}
if(!ja[i]){ja[i]=[];}
if(0<i){val.prev=ja[i-1][ja[i-1].length-1];}
ja[i].push(val);});var lcs=[];if(0<ja.length){let n=ja.length-1;var lcs=[ja[n][ja[n].length-1]];while(lcs[lcs.length-1].prev){lcs.push(lcs[lcs.length-1].prev);}}
return lcs.reverse();}
let result=[];let deleted=0;let inserted=0;let aMove=[];let aMoveIndex=[];let bMove=[];let bMoveIndex=[];function addToResult(aIndex,bIndex){if(bIndex<0){aMove.push(aLines[aIndex]);aMoveIndex.push(result.length);deleted++;}else if(aIndex<0){bMove.push(bLines[bIndex]);bMoveIndex.push(result.length);inserted++;}
result.push({line:0<=aIndex?aLines[aIndex]:bLines[bIndex],aIndex:aIndex,bIndex:bIndex,});}
function addSubMatch(aLo,aHi,bLo,bHi){while(aLo<=aHi&&bLo<=bHi&&aLines[aLo]===bLines[bLo]){addToResult(aLo++,bLo++);}
let aHiTemp=aHi;while(aLo<=aHi&&bLo<=bHi&&aLines[aHi]===bLines[bHi]){aHi--;bHi--;}
let uniqueCommonMap=uniqueCommon(aLines,aLo,aHi,bLines,bLo,bHi);if(uniqueCommonMap.size===0){while(aLo<=aHi){addToResult(aLo++,-1);}
while(bLo<=bHi){addToResult(-1,bLo++);}}else{recurseLCS(aLo,aHi,bLo,bHi,uniqueCommonMap);}
while(aHi<aHiTemp){addToResult(++aHi,++bHi);}}
function recurseLCS(aLo,aHi,bLo,bHi,uniqueCommonMap){var x=longestCommonSubsequence(uniqueCommonMap||uniqueCommon(aLines,aLo,aHi,bLines,bLo,bHi),);if(x.length===0){addSubMatch(aLo,aHi,bLo,bHi);}else{if(aLo<x[0].indexA||bLo<x[0].indexB){addSubMatch(aLo,x[0].indexA-1,bLo,x[0].indexB-1);}
let i;for(i=0;i<x.length-1;i++){addSubMatch(x[i].indexA,x[i+1].indexA-1,x[i].indexB,x[i+1].indexB-1);}
if(x[i].indexA<=aHi||x[i].indexB<=bHi){addSubMatch(x[i].indexA,aHi,x[i].indexB,bHi);}}}
recurseLCS(0,aLines.length-1,0,bLines.length-1);if(diffPlusFlag){return{lines:result,lineCountDeleted:deleted,lineCountInserted:inserted,lineCountMoved:0,aMove:aMove,aMoveIndex:aMoveIndex,bMove:bMove,bMoveIndex:bMoveIndex,};}
return{lines:result,lineCountDeleted:deleted,lineCountInserted:inserted,lineCountMoved:0,};}
return __exports;});;

/* /web_editor/static/src/js/editor/odoo-editor/src/tablepicker/TablePicker.js */
odoo.define('@web_editor/js/editor/odoo-editor/src/tablepicker/TablePicker',['@web_editor/js/editor/odoo-editor/src/utils/utils'],function(require){'use strict';let __exports={};const{getRangePosition}=require("@web_editor/js/editor/odoo-editor/src/utils/utils");const TablePicker=__exports.TablePicker=class TablePicker extends EventTarget{constructor(options={}){super();this.options=options;this.options.minRowCount=this.options.minRowCount||3;this.options.minColCount=this.options.minColCount||3;this.options.getContextFromParentRect=this.options.getContextFromParentRect||(()=>({top:0,left:0}));this.rowNumber=this.options.minRowCount;this.colNumber=this.options.minColCount;this.tablePickerWrapper=document.createElement('div');this.tablePickerWrapper.classList.add('oe-tablepicker-wrapper');this.tablePickerWrapper.innerHTML=`
            <div class="oe-tablepicker"></div>
            <div class="oe-tablepicker-size"></div>
        `;if(this.options.floating){this.tablePickerWrapper.style.position='absolute';this.tablePickerWrapper.classList.add('oe-floating');}
this.tablePickerElement=this.tablePickerWrapper.querySelector('.oe-tablepicker');this.tablePickerSizeViewElement=this.tablePickerWrapper.querySelector('.oe-tablepicker-size');this.el=this.tablePickerWrapper;this.hide();}
render(){this.tablePickerElement.innerHTML='';const colCount=Math.max(this.colNumber,this.options.minRowCount);const rowCount=Math.max(this.rowNumber,this.options.minRowCount);const extraCol=1;const extraRow=1;for(let rowNumber=1;rowNumber<=rowCount+extraRow;rowNumber++){const rowElement=document.createElement('div');rowElement.classList.add('oe-tablepicker-row');this.tablePickerElement.appendChild(rowElement);for(let colNumber=1;colNumber<=colCount+extraCol;colNumber++){const cell=this.el.ownerDocument.createElement('div');cell.classList.add('oe-tablepicker-cell','btn');rowElement.appendChild(cell);if(rowNumber<=this.rowNumber&&colNumber<=this.colNumber){cell.classList.add('active');}
const bindMouseMove=()=>{cell.addEventListener('mouseover',()=>{if(this.colNumber!==colNumber||this.rowNumber!=rowNumber){this.colNumber=colNumber;this.rowNumber=rowNumber;this.render();}});this.el.ownerDocument.removeEventListener('mousemove',bindMouseMove);};this.el.ownerDocument.addEventListener('mousemove',bindMouseMove);cell.addEventListener('mousedown',this.selectCell.bind(this));}}
this.tablePickerSizeViewElement.textContent=`${this.colNumber}x${this.rowNumber}`;}
show(){this.reset();this.el.style.display='block';if(this.options.floating){this._showFloating();}}
hide(){this.el.style.display='none';}
reset(){this.rowNumber=this.options.minRowCount;this.colNumber=this.options.minColCount;this.render();}
selectCell(){this.dispatchEvent(new CustomEvent('cell-selected',{detail:{colNumber:this.colNumber,rowNumber:this.rowNumber},}),);}
_showFloating(){const isRtl=this.options.direction==='rtl';const keydown=e=>{const actions={ArrowRight:{colNumber:(this.colNumber+(isRtl?-1:1))||1,rowNumber:this.rowNumber,},ArrowLeft:{colNumber:(this.colNumber+(isRtl?1:-1))||1,rowNumber:this.rowNumber,},ArrowUp:{colNumber:this.colNumber,rowNumber:this.rowNumber-1||1,},ArrowDown:{colNumber:this.colNumber,rowNumber:this.rowNumber+1,},};const action=actions[e.key];if(action){this.rowNumber=action.rowNumber||this.rowNumber;this.colNumber=action.colNumber||this.colNumber;this.render();e.preventDefault();}else if(e.key==='Enter'){this.selectCell();e.preventDefault();}else if(e.key==='Escape'){stop();e.preventDefault();}};const offset=getRangePosition(this.el,this.options.document,this.options);if(isRtl){this.el.style.right=`${offset.right}px`;}else{this.el.style.left=`${offset.left}px`;}
this.el.style.top=`${offset.top}px`;const stop=()=>{this.hide();this.options.document.removeEventListener('mousedown',stop);this.removeEventListener('cell-selected',stop);this.options.document.removeEventListener('keydown',keydown,true);};setTimeout(()=>{this.options.document.addEventListener('mousedown',stop);});this.options.document.addEventListener('keydown',keydown,true);this.addEventListener('cell-selected',stop);}}
return __exports;});;

/* /web_editor/static/src/js/editor/odoo-editor/src/utils/constants.js */
odoo.define('@web_editor/js/editor/odoo-editor/src/utils/constants',[],function(require){'use strict';let __exports={};const UNBREAKABLE_ROLLBACK_CODE=__exports.UNBREAKABLE_ROLLBACK_CODE='UNBREAKABLE';const UNREMOVABLE_ROLLBACK_CODE=__exports.UNREMOVABLE_ROLLBACK_CODE='UNREMOVABLE';const REGEX_BOOTSTRAP_COLUMN=__exports.REGEX_BOOTSTRAP_COLUMN=/(?:^| )col(-[a-zA-Z]+)?(-\d+)?(?:$| )/;return __exports;});;

/* /web_editor/static/src/js/editor/odoo-editor/src/utils/sanitize.js */
odoo.define('@web_editor/js/editor/odoo-editor/src/utils/sanitize',['@web_editor/js/editor/odoo-editor/src/utils/utils'],function(require){'use strict';let __exports={};const{closestBlock,closestElement,startPos,getListMode,isBlock,isSelfClosingElement,moveNodes,preserveCursor,isFontAwesome,getDeepRange,isUnbreakable,isEditorTab,isProtected,isZWS,isArtificialVoidElement,ancestors,EMAIL_REGEX,PHONE_REGEX,URL_REGEX,unwrapContents,padLinkWithZws,getTraversedNodes,ZERO_WIDTH_CHARS_REGEX,isVisible,}=require("@web_editor/js/editor/odoo-editor/src/utils/utils");const NOT_A_NUMBER=/[^\d]/g;const UNMERGEABLE_SELECTORS=__exports.UNMERGEABLE_SELECTORS=[];function hasPseudoElementContent(node,pseudoSelector){const content=getComputedStyle(node,pseudoSelector).getPropertyValue('content');return content&&content!=='none';}
__exports.areSimilarElements=areSimilarElements;function areSimilarElements(node,node2){if(![node,node2].every(n=>n?.nodeType===Node.ELEMENT_NODE)){return false;}
if(node.nodeName!==node2.nodeName){return false;}
const nodeName=node.nodeName;for(const name of new Set([...node.getAttributeNames(),...node2.getAttributeNames(),])){if(node.getAttribute(name)!==node2.getAttribute(name)){return false;}}
if([node,node2].some(n=>hasPseudoElementContent(n,':before')||hasPseudoElementContent(n,':after'))){return false;}
if(isFontAwesome(node)||isFontAwesome(node2)){return false;}
if(nodeName==='LI'&&node.classList.contains('oe-nested')){return(node.lastElementChild&&node2.firstElementChild&&getListMode(node.lastElementChild)===getListMode(node2.firstElementChild));}
if(['UL','OL'].includes(nodeName)){return!isSelfClosingElement(node)&&!isSelfClosingElement(node2);}
if(isBlock(node)||isSelfClosingElement(node)||isSelfClosingElement(node2)){return false;}
const nodeStyle=getComputedStyle(node);const node2Style=getComputedStyle(node2);return(!+nodeStyle.padding.replace(NOT_A_NUMBER,'')&&!+node2Style.padding.replace(NOT_A_NUMBER,'')&&!+nodeStyle.margin.replace(NOT_A_NUMBER,'')&&!+node2Style.margin.replace(NOT_A_NUMBER,''));}
__exports.deduceURLfromText=deduceURLfromText;function deduceURLfromText(text,link){const label=text.replace(ZERO_WIDTH_CHARS_REGEX,'').trim();let match=label.match(EMAIL_REGEX);if(match){return match[1]?match[0]:'mailto:'+match[0];}
match=label.match(URL_REGEX);if(match&&match[0]===label){const currentHttpProtocol=(link?.href.match(/^http(s)?:\/\//gi)||[])[0];if(match[2]){return match[0];}else if(currentHttpProtocol){return currentHttpProtocol+match[0];}else{return'http://'+match[0];}}
match=label.match(PHONE_REGEX);if(match){return match[1]?match[0]:'tel://'+match[0];}
return null;}
function shouldPreserveCursor(node,root){const selection=root.ownerDocument.getSelection();return node.isConnected&&selection&&selection.anchorNode&&root.contains(selection.anchorNode)&&selection.focusNode&&root.contains(selection.focusNode);}
function sanitizeNode(node,root){if(isArtificialVoidElement(node)&&node.getAttribute('contenteditable')!=='false'){node.setAttribute('contenteditable','false');}
for(const attributeName of['class','style']){if(node.nodeType===Node.ELEMENT_NODE&&node.hasAttribute(attributeName)&&!node.getAttribute(attributeName)){node.removeAttribute(attributeName);}}
if(['SPAN','FONT'].includes(node.nodeName)&&!node.hasAttributes()&&!hasPseudoElementContent(node,"::before")&&!hasPseudoElementContent(node,"::after")){getDeepRange(root,{select:true});const restoreCursor=shouldPreserveCursor(node,root)&&preserveCursor(root.ownerDocument);const parent=node.parentElement;unwrapContents(node);restoreCursor&&restoreCursor();node=parent;}else if(areSimilarElements(node,node.previousSibling)&&!isUnbreakable(node)&&!isEditorTab(node)&&!(node.attributes?.length===1&&node.hasAttribute('data-oe-zws-empty-inline')&&(node.textContent==='\u200B'||node.previousSibling.textContent==='\u200B'))&&!UNMERGEABLE_SELECTORS.some(selectorClass=>node.classList?.contains(selectorClass))){getDeepRange(root,{select:true});const restoreCursor=shouldPreserveCursor(node,root)&&preserveCursor(root.ownerDocument);moveNodes(...startPos(node),node.previousSibling);restoreCursor&&restoreCursor();}else if(node.nodeType===Node.COMMENT_NODE){const parent=node.parentElement;node.remove();node=parent;}else if(node.nodeName==='P'&&node.parentElement.nodeName==='LI'&&!node.parentElement.classList.contains('nav-item')){const previous=node.previousSibling;const attributes=node.attributes;const parent=node.parentElement;const restoreCursor=shouldPreserveCursor(node,root)&&preserveCursor(root.ownerDocument);if(attributes.length){const spanEl=document.createElement('span');for(const attribute of attributes){spanEl.setAttribute(attribute.name,attribute.value);}
if(spanEl.style.textAlign){spanEl.style.display='block';}
spanEl.append(...node.childNodes);node.replaceWith(spanEl);}else{unwrapContents(node);}
if(previous&&isVisible(previous)&&!isBlock(previous)&&previous.nodeName!=='BR'){const br=document.createElement('br');previous.after(br);}
restoreCursor&&restoreCursor(new Map([[node,parent]]));node=parent;}else if(node.nodeName==='LI'&&!node.closest('ul, ol')){const paragraph=document.createElement('p');paragraph.replaceChildren(...node.childNodes);node.replaceWith(paragraph);node=paragraph;}else if(isFontAwesome(node)&&node.textContent!=='\u200B'){node.textContent='\u200B';}else if(isEditorTab(node)){let tabPreviousSibling=node.previousSibling;while(isZWS(tabPreviousSibling)){tabPreviousSibling=tabPreviousSibling.previousSibling;}
if(isEditorTab(tabPreviousSibling)){node.style.width='40px';}else{const editable=closestElement(node,'.odoo-editor-editable');if(editable?.firstElementChild){const nodeRect=node.getBoundingClientRect();const referenceRect=editable.firstElementChild.getBoundingClientRect();if(nodeRect.width&&referenceRect.width){const width=(nodeRect.left-referenceRect.left)%40;node.style.width=(40-width)+'px';}}}}else if(node.nodeName==='A'){padLinkWithZws(root,node);}else if(node.nodeType===Node.TEXT_NODE&&node.textContent.includes('\uFEFF')&&!closestElement(node,'a')&&!(closestElement(root,'[contenteditable=true]')&&getTraversedNodes(closestElement(root,'[contenteditable=true]')).includes(node))){const startsWithLegitZws=node.textContent.startsWith('\uFEFF')&&node.previousSibling&&node.previousSibling.nodeName==='A';const endsWithLegitZws=node.textContent.endsWith('\uFEFF')&&node.nextSibling&&node.nextSibling.nodeName==='A';let newText=node.textContent.replace(/\uFEFF/g,'');if(startsWithLegitZws){newText='\uFEFF'+newText;}
if(endsWithLegitZws){newText=newText+'\uFEFF';}
if(newText!==node.textContent){let replacement;if(newText.length){replacement=document.createTextNode(newText);node.before(replacement);}else{replacement=node.parentElement;}
node.remove();node=replacement;}}
return node;}
__exports.sanitize=sanitize;function sanitize(nodeToSanitize,root=nodeToSanitize){const start=nodeToSanitize.ownerDocument.getSelection()?.anchorNode;const block=closestBlock(nodeToSanitize);if(block&&root.contains(block)){const isList=['UL','OL'].includes(block.nodeName);let node=isList?block.parentElement:block;while(node&&!(root.isConnected&&!node.isConnected)&&root.contains(node)){if(!isProtected(node)){node=sanitizeNode(node,root);}
node=node.firstChild||node.nextSibling||ancestors(node,root).find(a=>a.nextSibling)?.nextSibling;}
const elementsWithId=[...block.querySelectorAll('[id^=checkId-]')];const maxId=Math.max(...[0,...elementsWithId.map(node=>+node.getAttribute('id').substring(8))]);let nextId=maxId+1;const ids=[];for(const node of block.querySelectorAll('[id^=checkId-], .o_checklist > li, .o_stars')){if(!node.classList.contains('o_stars')&&(!node.parentElement.classList.contains('o_checklist')||[...node.children].some(child=>['UL','OL'].includes(child.nodeName)))){node.removeAttribute('id')}else{let id=node.getAttribute('id');if(!id||ids.includes(id)){id=`checkId-${nextId}`;nextId++;node.setAttribute('id',id);}
ids.push(id);}}
const startEl=start&&closestElement(start,'a');if(startEl&&root.contains(startEl)){const label=startEl.innerText;const url=deduceURLfromText(label,startEl);if(url){startEl.setAttribute('href',url);}}}
return nodeToSanitize;}
return __exports;});;

/* /web_editor/static/src/js/editor/odoo-editor/src/utils/serialize.js */
odoo.define('@web_editor/js/editor/odoo-editor/src/utils/serialize',[],function(require){'use strict';let __exports={};__exports.serializeNode=serializeNode;function serializeNode(node,nodesToStripFromChildren=new Set()){if(!node.oid){return;}
const result={nodeType:node.nodeType,oid:node.oid,};if(node.nodeType===Node.TEXT_NODE){result.textValue=node.nodeValue;}else if(node.nodeType===Node.ELEMENT_NODE){result.tagName=node.tagName;result.children=[];result.attributes={};for(let i=0;i<node.attributes.length;i++){result.attributes[node.attributes[i].name]=node.attributes[i].value;}
let child=node.firstChild;if(!["true",""].includes(node.dataset.oeTransientContent)){while(child){if(!nodesToStripFromChildren.has(child.oid)){const serializedChild=serializeNode(child,nodesToStripFromChildren);if(serializedChild){result.children.push(serializedChild);}}
child=child.nextSibling;}}}
return result;}
__exports.unserializeNode=unserializeNode;function unserializeNode(obj){if(!obj){return;}
let result=undefined;if(obj.nodeType===Node.TEXT_NODE){result=document.createTextNode(obj.textValue);}else if(obj.nodeType===Node.ELEMENT_NODE){result=document.createElement(obj.tagName);for(const key in obj.attributes){result.setAttribute(key,obj.attributes[key]);}
obj.children.forEach(child=>result.append(unserializeNode(child)));}else{console.warn('unknown node type');}
if(result){result.oid=obj.oid;return result;}}
__exports.serializeSelection=serializeSelection;function serializeSelection(selection){if(selection&&selection.anchorNode&&selection.anchorNode.oid&&typeof selection.anchorOffset!=='undefined'&&selection.focusNode&&selection.anchorNode.oid&&typeof selection.focusOffset!=='undefined'){return{anchorNodeOid:selection.anchorNode.oid,anchorOffset:selection.anchorOffset,focusNodeOid:selection.focusNode.oid,focusOffset:selection.focusOffset,};}else{return{anchorNodeOid:undefined,anchorOffset:undefined,focusNodeOid:undefined,focusOffset:undefined,};}}
return __exports;});;

/* /web_editor/static/src/js/editor/odoo-editor/src/utils/utils.js */
odoo.define('@web_editor/js/editor/odoo-editor/src/utils/utils',[],function(require){'use strict';let __exports={};const DIRECTIONS=__exports.DIRECTIONS={LEFT:false,RIGHT:true,};const CTYPES=__exports.CTYPES={CONTENT:1,SPACE:2,BLOCK_OUTSIDE:4,BLOCK_INSIDE:8,BR:16,};__exports.ctypeToString=ctypeToString;function ctypeToString(ctype){return Object.keys(CTYPES).find((key)=>CTYPES[key]===ctype);}
const CTGROUPS=__exports.CTGROUPS={INLINE:CTYPES.CONTENT|CTYPES.SPACE,BLOCK:CTYPES.BLOCK_OUTSIDE|CTYPES.BLOCK_INSIDE,BR:CTYPES.BR,};const tldWhitelist=['com','net','org','ac','ad','ae','af','ag','ai','al','am','an','ao','aq','ar','as','at','au','aw','ax','az','ba','bb','bd','be','bf','bg','bh','bi','bj','bl','bm','bn','bo','br','bq','bs','bt','bv','bw','by','bz','ca','cc','cd','cf','cg','ch','ci','ck','cl','cm','cn','co','cr','cs','cu','cv','cw','cx','cy','cz','dd','de','dj','dk','dm','do','dz','ec','ee','eg','eh','er','es','et','eu','fi','fj','fk','fm','fo','fr','ga','gb','gd','ge','gf','gg','gh','gi','gl','gm','gn','gp','gq','gr','gs','gt','gu','gw','gy','hk','hm','hn','hr','ht','hu','id','ie','il','im','in','io','iq','ir','is','it','je','jm','jo','jp','ke','kg','kh','ki','km','kn','kp','kr','kw','ky','kz','la','lb','lc','li','lk','lr','ls','lt','lu','lv','ly','ma','mc','md','me','mf','mg','mh','mk','ml','mm','mn','mo','mp','mq','mr','ms','mt','mu','mv','mw','mx','my','mz','na','nc','ne','nf','ng','ni','nl','no','np','nr','nu','nz','om','pa','pe','pf','pg','ph','pk','pl','pm','pn','pr','ps','pt','pw','py','qa','re','ro','rs','ru','rw','sa','sb','sc','sd','se','sg','sh','si','sj','sk','sl','sm','sn','so','sr','ss','st','su','sv','sx','sy','sz','tc','td','tf','tg','th','tj','tk','tl','tm','tn','to','tp','tr','tt','tv','tw','tz','ua','ug','uk','um','us','uy','uz','va','vc','ve','vg','vi','vn','vu','wf','ws','ye','yt','yu','za','zm','zr','zw','co\\.uk'];const urlRegexBase=`|(?:www.))[-a-zA-Z0-9@:%._\\+~#=]{2,256}\\.[a-zA-Z][a-zA-Z0-9]{1,62}|(?:[-a-zA-Z0-9@:%._\\+~#=]{2,256}\\.(?:${tldWhitelist.join('|')})\\b))(?:(?:[/?#])[^\\s]*[^!.,})\\]'"\\s]|(?:[^!(){}.,[\\]'"\\s]+))?`;const httpCapturedRegex=`(https?:\\/\\/)`;const URL_REGEX=__exports.URL_REGEX=new RegExp(`((?:(?:${httpCapturedRegex}${urlRegexBase})`,'i');const YOUTUBE_URL_GET_VIDEO_ID=__exports.YOUTUBE_URL_GET_VIDEO_ID=/^(?:(?:https?:)?\/\/)?(?:(?:www|m)\.)?(?:youtube\.com|youtu\.be)(?:\/(?:[\w-]+\?v=|embed\/|v\/)?)([^\s?&#]+)(?:\S+)?$/i;const EMAIL_REGEX=__exports.EMAIL_REGEX=/^(mailto:)?[\w-.]+@(?:[\w-]+\.)+[\w-]{2,4}$/i;const PHONE_REGEX=__exports.PHONE_REGEX=/^(tel:(?:\/\/)?)?\+?[\d\s.\-()\/]{3,25}$/;const PROTECTED_BLOCK_TAG=__exports.PROTECTED_BLOCK_TAG=['TR','TD','TABLE','TBODY','UL','OL','LI'];const FONT_SIZE_CLASSES=__exports.FONT_SIZE_CLASSES=["display-1-fs","display-2-fs","display-3-fs","display-4-fs","h1-fs","h2-fs","h3-fs","h4-fs","h5-fs","h6-fs","base-fs","o_small-fs","small"];const TEXT_STYLE_CLASSES=__exports.TEXT_STYLE_CLASSES=["display-1","display-2","display-3","display-4","lead","o_small","small"];const ZERO_WIDTH_CHARS=__exports.ZERO_WIDTH_CHARS=['\u200b','\ufeff'];const ZERO_WIDTH_CHARS_REGEX=__exports.ZERO_WIDTH_CHARS_REGEX=new RegExp(`[${ZERO_WIDTH_CHARS.join('')}]`,'g');__exports.leftPos=leftPos;function leftPos(node){return[node.parentNode,childNodeIndex(node)];}
__exports.rightPos=rightPos;function rightPos(node){return[node.parentNode,childNodeIndex(node)+1];}
__exports.boundariesOut=boundariesOut;function boundariesOut(node){const index=childNodeIndex(node);return[node.parentNode,index,node.parentNode,index+1];}
__exports.startPos=startPos;function startPos(node){return[node,0];}
__exports.endPos=endPos;function endPos(node){return[node,nodeSize(node)];}
__exports.boundariesIn=boundariesIn;function boundariesIn(node){return[node,0,node,nodeSize(node)];}
__exports.childNodeIndex=childNodeIndex;function childNodeIndex(node){let i=0;while(node.previousSibling){i++;node=node.previousSibling;}
return i;}
__exports.nodeSize=nodeSize;function nodeSize(node){const isTextNode=node.nodeType===Node.TEXT_NODE;return isTextNode?node.length:node.childNodes.length;}
const closestPath=__exports.closestPath=function*(node){while(node){yield node;node=node.parentNode;}};const PATH_END_REASONS={NO_NODE:0,BLOCK_OUT:1,BLOCK_HIT:2,OUT_OF_SCOPE:3,};__exports.createDOMPathGenerator=createDOMPathGenerator;function createDOMPathGenerator(direction,{leafOnly=false,inScope=false,stopTraverseFunction,stopFunction}={},){const nextDeepest=direction===DIRECTIONS.LEFT?node=>lastLeaf(node.previousSibling,stopTraverseFunction):node=>firstLeaf(node.nextSibling,stopTraverseFunction);const firstNode=direction===DIRECTIONS.LEFT?(node,offset)=>lastLeaf(node.childNodes[offset-1],stopTraverseFunction):(node,offset)=>firstLeaf(node.childNodes[offset],stopTraverseFunction);return function*(node,offset,reasons=[]){let movedUp=false;let currentNode=firstNode(node,offset);if(!currentNode){movedUp=true;currentNode=node;}
while(currentNode){if(stopFunction&&stopFunction(currentNode)){reasons.push(movedUp?PATH_END_REASONS.BLOCK_OUT:PATH_END_REASONS.BLOCK_HIT);break;}
if(inScope&&currentNode===node){reasons.push(PATH_END_REASONS.OUT_OF_SCOPE);break;}
if(!(leafOnly&&movedUp)){yield currentNode;}
movedUp=false;let nextNode=nextDeepest(currentNode);if(!nextNode){movedUp=true;nextNode=currentNode.parentNode;}
currentNode=nextNode;}
reasons.push(PATH_END_REASONS.NO_NODE);};}
__exports.findNode=findNode;function findNode(domPath,findCallback=()=>true,stopCallback=()=>false){for(const node of domPath){if(findCallback(node)){return node;}
if(stopCallback(node)){break;}}
return null;}
__exports.getFurthestUneditableParent=getFurthestUneditableParent;function getFurthestUneditableParent(node,parentLimit){if(node===parentLimit||(parentLimit&&!parentLimit.contains(node))){return undefined;}
let parent=node&&node.parentElement;let nonEditableElement;while(parent&&(!parentLimit||parent!==parentLimit)){if(!parent.isContentEditable){nonEditableElement=parent;}
if(parent.oid==="root"){break;}
parent=parent.parentElement;}
return nonEditableElement;}
__exports.closestElement=closestElement;function closestElement(node,predicate="*"){if(!node)return null;let element=node.nodeType===Node.ELEMENT_NODE?node:node.parentElement;if(typeof predicate==='function'){while(element&&!predicate(element)){element=element.parentElement;}}else{element=element?.closest(predicate);}
return element?.closest('.odoo-editor-editable')&&element;}
__exports.ancestors=ancestors;function ancestors(node,editable){if(!node||!node.parentElement||node===editable)return[];return[node.parentElement,...ancestors(node.parentElement,editable)];}
__exports.descendants=descendants;function descendants(node){const posterity=[];for(const child of(node.childNodes||[])){posterity.push(child,...descendants(child));}
return posterity;}
__exports.closestBlock=closestBlock;function closestBlock(node){return findNode(closestPath(node),node=>isBlock(node));}
__exports.lastLeaf=lastLeaf;function lastLeaf(node,stopTraverseFunction){while(node&&node.lastChild&&!(stopTraverseFunction&&stopTraverseFunction(node))){node=node.lastChild;}
return node;}
__exports.firstLeaf=firstLeaf;function firstLeaf(node,stopTraverseFunction){while(node&&node.firstChild&&!(stopTraverseFunction&&stopTraverseFunction(node))){node=node.firstChild;}
return node;}
__exports.previousLeaf=previousLeaf;function previousLeaf(node,editable,skipInvisible=false){let ancestor=node;while(ancestor&&!ancestor.previousSibling&&ancestor!==editable){ancestor=ancestor.parentElement;}
if(ancestor&&ancestor!==editable){if(skipInvisible&&!isVisible(ancestor.previousSibling)){return previousLeaf(ancestor.previousSibling,editable,skipInvisible);}else{const last=lastLeaf(ancestor.previousSibling);if(skipInvisible&&!isVisible(last)){return previousLeaf(last,editable,skipInvisible);}else{return last;}}}}
__exports.nextLeaf=nextLeaf;function nextLeaf(node,editable,skipInvisible=false){let ancestor=node;while(ancestor&&!ancestor.nextSibling&&ancestor!==editable){ancestor=ancestor.parentElement;}
if(ancestor&&ancestor!==editable){if(skipInvisible&&ancestor.nextSibling&&!isVisible(ancestor.nextSibling)){return nextLeaf(ancestor.nextSibling,editable,skipInvisible);}else{const first=firstLeaf(ancestor.nextSibling);if(skipInvisible&&!isVisible(first)){return nextLeaf(first,editable,skipInvisible);}else{return first;}}}}
__exports.getAdjacentPreviousSiblings=getAdjacentPreviousSiblings;function getAdjacentPreviousSiblings(node,predicate=n=>!!n){let previous=node.previousSibling;const list=[];while(previous&&predicate(previous)){list.push(previous);previous=previous.previousSibling;}
return list;}
__exports.getAdjacentNextSiblings=getAdjacentNextSiblings;function getAdjacentNextSiblings(node,predicate=n=>!!n){let next=node.nextSibling;const list=[];while(next&&predicate(next)){list.push(next);next=next.nextSibling;}
return list;}
__exports.getAdjacents=getAdjacents;function getAdjacents(node,predicate=n=>!!n){const previous=getAdjacentPreviousSiblings(node,predicate);const next=getAdjacentNextSiblings(node,predicate);return predicate(node)?[...previous.reverse(),node,...next]:[];}
__exports.hasTableSelection=hasTableSelection;function hasTableSelection(editable){return!!editable.querySelector('.o_selected_table');}
__exports.hasValidSelection=hasValidSelection;function hasValidSelection(editable){return hasTableSelection(editable)||editable.ownerDocument.getSelection().rangeCount>0;}
__exports.getNormalizedCursorPosition=getNormalizedCursorPosition;function getNormalizedCursorPosition(node,offset,full=true){const editable=closestElement(node,'.odoo-editor-editable');let closest=closestElement(node);while(closest&&closest!==editable&&(isSelfClosingElement(node)||!closest.isContentEditable)){[node,offset]=offset||!nodeSize(node)?rightPos(node):leftPos(node);closest=closestElement(node);}
offset=Math.min(Math.max(offset,0),nodeSize(node));if(full){let el;let elOffset;if(node.nodeType===Node.ELEMENT_NODE){el=node;elOffset=offset;}else if(node.nodeType===Node.TEXT_NODE){if(offset===0){el=node.parentNode;elOffset=childNodeIndex(node);}else if(offset===node.length){el=node.parentNode;elOffset=childNodeIndex(node)+1;}}
if(el){const leftInlineNode=leftLeafOnlyInScopeNotBlockEditablePath(el,elOffset).next().value;let leftVisibleEmpty=false;if(leftInlineNode){leftVisibleEmpty=isSelfClosingElement(leftInlineNode)||!closestElement(leftInlineNode).isContentEditable;[node,offset]=leftVisibleEmpty?rightPos(leftInlineNode):endPos(leftInlineNode);}
if(!leftInlineNode||leftVisibleEmpty){const rightInlineNode=rightLeafOnlyInScopeNotBlockEditablePath(el,elOffset).next().value;if(rightInlineNode){const closest=closestElement(rightInlineNode);const rightVisibleEmpty=isSelfClosingElement(rightInlineNode)||!closest||!closest.isContentEditable;if(!(leftVisibleEmpty&&rightVisibleEmpty)){[node,offset]=rightVisibleEmpty?leftPos(rightInlineNode):startPos(rightInlineNode);}}}}}
const prevNode=node.nodeType===Node.ELEMENT_NODE&&node.childNodes[offset-1];if(prevNode&&prevNode.nodeName==='BR'&&isFakeLineBreak(prevNode)){offset--;}
return[node,offset];}
__exports.insertSelectionChars=insertSelectionChars;function insertSelectionChars(anchorNode,anchorOffset,focusNode,focusOffset,startChar='[',endChar=']'){if(anchorNode===focusNode&&anchorOffset<=focusOffset){focusOffset+=(focusNode.nodeType===Node.TEXT_NODE?startChar.length:1);}
insertCharsAt(startChar,anchorNode,anchorOffset);insertCharsAt(endChar,focusNode,focusOffset);}
__exports.logSelection=logSelection;function logSelection(root,options={}){const sel=options.selection||root.ownerDocument.getSelection();if(!root.contains(sel.anchorNode)||!root.contains(sel.focusNode)){console.warn('The selection is not contained in the root.');return;}
let anchorClone,focusClone;const cloneTree=node=>{const clone=node.cloneNode();if(options.includeOids){clone.oid=node.oid;}
anchorClone=anchorClone||(node===sel.anchorNode&&clone);focusClone=focusClone||(node===sel.focusNode&&clone);for(const child of node.childNodes||[]){clone.append(cloneTree(child));}
return clone;}
const rootClone=cloneTree(root);insertSelectionChars(anchorClone,sel.anchorOffset,focusClone,sel.focusOffset,'%c[%c','%c]%c');rootClone.removeAttribute('data-last-history-steps');if(options.doFormat){const formatHtml=(node,spaces=0)=>{node.before(document.createTextNode('\n'+' '.repeat(spaces)));for(const child of[...node.childNodes]){formatHtml(child,spaces+4);}
if(node.nodeType!==Node.TEXT_NODE){node.appendChild(document.createTextNode('\n'+' '.repeat(spaces)));}
if(options.includeOids){if(node.nodeType===Node.TEXT_NODE){node.textContent+=` (${node.oid})`;}else{node.setAttribute('oid',node.oid);}}}
formatHtml(rootClone);}
const selectionCharacterStyle='color: #75bfff; font-weight: 700;';const defaultStyle='color: inherit; font-weight: inherit;';console.log(makeZeroWidthCharactersVisible(rootClone.outerHTML),selectionCharacterStyle,defaultStyle,selectionCharacterStyle,defaultStyle,);}
__exports.ensureFocus=ensureFocus;function ensureFocus(element){const activeElement=element.ownerDocument.activeElement;if(activeElement!==element&&(!element.contains(activeElement)||!activeElement.isContentEditable)){element.focus();}}
__exports.setSelection=setSelection;function setSelection(anchorNode,anchorOffset,focusNode=anchorNode,focusOffset=anchorOffset,normalize=true,){if(!anchorNode||!anchorNode.parentElement||!anchorNode.parentElement.closest('body')||!focusNode||!focusNode.parentElement||!focusNode.parentElement.closest('body')){return null;}
const document=anchorNode.ownerDocument;const seemsCollapsed=anchorNode===focusNode&&anchorOffset===focusOffset;[anchorNode,anchorOffset]=getNormalizedCursorPosition(anchorNode,anchorOffset,normalize);[focusNode,focusOffset]=seemsCollapsed?[anchorNode,anchorOffset]:getNormalizedCursorPosition(focusNode,focusOffset,normalize);const direction=getCursorDirection(anchorNode,anchorOffset,focusNode,focusOffset);const sel=document.getSelection();if(!sel){return null;}
try{const range=new Range();if(direction===DIRECTIONS.RIGHT){range.setStart(anchorNode,anchorOffset);range.collapse(true);}else{range.setEnd(anchorNode,anchorOffset);range.collapse(false);}
sel.removeAllRanges();sel.addRange(range);sel.extend(focusNode,focusOffset);}catch(e){if(e.name!=='NS_ERROR_FAILURE'){throw e;}}
return[anchorNode,anchorOffset,focusNode,focusOffset];}
__exports.setCursorStart=setCursorStart;function setCursorStart(node,normalize=true){const pos=startPos(node);return setSelection(...pos,...pos,normalize);}
__exports.setCursorEnd=setCursorEnd;function setCursorEnd(node,normalize=true){const pos=endPos(node);return setSelection(...pos,...pos,normalize);}
__exports.getCursorDirection=getCursorDirection;function getCursorDirection(anchorNode,anchorOffset,focusNode,focusOffset){if(anchorNode===focusNode){if(anchorOffset===focusOffset)return false;return anchorOffset<focusOffset?DIRECTIONS.RIGHT:DIRECTIONS.LEFT;}
return anchorNode.compareDocumentPosition(focusNode)&Node.DOCUMENT_POSITION_FOLLOWING?DIRECTIONS.RIGHT:DIRECTIONS.LEFT;}
__exports.getTraversedNodes=getTraversedNodes;function getTraversedNodes(editable,range=getDeepRange(editable)){const selectedTableCells=editable.querySelectorAll('.o_selected_td');const document=editable.ownerDocument;if(!range)return[];const iterator=document.createNodeIterator(range.commonAncestorContainer);let node;do{node=iterator.nextNode();}while(node&&node!==range.startContainer&&!(selectedTableCells.length&&node===selectedTableCells[0]));if(node&&!(selectedTableCells.length&&node===selectedTableCells[0])&&!range.collapsed&&node.nodeType===Node.ELEMENT_NODE&&node.childNodes.length&&range.startOffset&&node.childNodes[range.startOffset-1].nodeName==="BR"){const targetBr=node.childNodes[range.startOffset-1];while(node!=targetBr){node=iterator.nextNode();}
node=iterator.nextNode();}
if(node&&!range.collapsed&&node===range.startContainer&&range.startOffset===nodeSize(node)&&node.nextSibling&&node.nextSibling.nodeName==="BR"){node=iterator.nextNode();}
const traversedNodes=new Set([node,...descendants(node)]);while(node&&node!==range.endContainer){node=iterator.nextNode();if(node){const selectedTable=closestElement(node,'.o_selected_table');if(selectedTable){for(const selectedTd of selectedTable.querySelectorAll('.o_selected_td')){traversedNodes.add(selectedTd);descendants(selectedTd).forEach(descendant=>traversedNodes.add(descendant));}}else if(!(node===range.endContainer&&range.endOffset===0&&!range.collapsed&&node.previousSibling&&node.previousSibling.nodeName==="BR")){traversedNodes.add(node);}}}
if(node){for(const descendant of descendants(node)){if(descendant.parentElement===node&&childNodeIndex(descendant)>=range.endOffset){break;}
traversedNodes.add(descendant);}}
return[...traversedNodes];}
__exports.getSelectedNodes=getSelectedNodes;function getSelectedNodes(editable){const selectedTableCells=editable.querySelectorAll('.o_selected_td');const document=editable.ownerDocument;const sel=document.getSelection();if(!sel.rangeCount&&!selectedTableCells.length){return[];}
const range=sel.getRangeAt(0);return[...new Set(getTraversedNodes(editable).flatMap(node=>{const td=closestElement(node,'.o_selected_td');if(td){return descendants(td);}else if(range.isPointInRange(node,0)&&range.isPointInRange(node,nodeSize(node))){return node;}else{return[];}},))];}
__exports.getDeepRange=getDeepRange;function getDeepRange(editable,{range,sel,splitText,select,correctTripleClick}={}){sel=sel||editable.parentElement&&editable.ownerDocument.getSelection();if(sel&&sel.isCollapsed&&sel.anchorNode&&(sel.anchorNode.nodeName==="BR"||(sel.anchorNode.nodeType===Node.TEXT_NODE&&sel.anchorNode.textContent===''))){setSelection(sel.anchorNode.parentElement,childNodeIndex(sel.anchorNode));}
range=range?range.cloneRange():sel&&sel.rangeCount&&sel.getRangeAt(0).cloneRange();if(!range)return;let start=range.startContainer;let startOffset=range.startOffset;let end=range.endContainer;let endOffset=range.endOffset;const isBackwards=!range.collapsed&&start===sel.focusNode&&startOffset===sel.focusOffset;[start,startOffset]=getDeepestPosition(start,startOffset);[end,endOffset]=getDeepestPosition(end,endOffset);if(splitText){const isInSingleContainer=start===end;if(end.nodeType===Node.TEXT_NODE&&endOffset!==0&&endOffset!==end.textContent.length){const endParent=end.parentNode;const splitOffset=splitTextNode(end,endOffset);end=endParent.childNodes[splitOffset-1]||endParent.firstChild;if(isInSingleContainer){start=end;}
endOffset=end.textContent.length;}
if(start.nodeType===Node.TEXT_NODE&&startOffset!==0&&startOffset!==start.textContent.length){splitTextNode(start,startOffset);startOffset=0;if(isInSingleContainer){endOffset=start.textContent.length;}}}
const endLeaf=firstLeaf(end);const beforeEnd=endLeaf.previousSibling;if(correctTripleClick&&!endOffset&&(start!==end||startOffset!==endOffset)&&(!beforeEnd||(beforeEnd.nodeType===Node.TEXT_NODE&&!isVisibleTextNode(beforeEnd)&&!isZWS(beforeEnd)))){const previous=previousLeaf(endLeaf,editable,true);if(previous&&closestElement(previous).isContentEditable){[end,endOffset]=[previous,nodeSize(previous)];}}
if(select){if(isBackwards){[start,end,startOffset,endOffset]=[end,start,endOffset,startOffset];range.setEnd(start,startOffset);range.collapse(false);}else{range.setStart(start,startOffset);range.collapse(true);}
sel.removeAllRanges();sel.addRange(range);try{sel.extend(end,endOffset);}catch{}
range=sel.getRangeAt(0);}else{range.setStart(start,startOffset);range.setEnd(end,endOffset);}
return range;}
__exports.getAdjacentCharacter=getAdjacentCharacter;function getAdjacentCharacter(editable,side){let{focusNode,focusOffset}=editable.ownerDocument.getSelection();const originalBlock=closestBlock(focusNode);let adjacentCharacter;while(!adjacentCharacter&&focusNode){if(side==='previous'){adjacentCharacter=focusOffset>0&&focusNode.textContent[focusOffset-1];}else{adjacentCharacter=focusNode.textContent[focusOffset];}
if(!adjacentCharacter){if(side==='previous'){focusNode=previousLeaf(focusNode,editable);focusOffset=focusNode&&nodeSize(focusNode);}else{focusNode=nextLeaf(focusNode,editable);focusOffset=0;}
const characterIndex=side==='previous'?focusOffset-1:focusOffset;adjacentCharacter=focusNode&&focusNode.textContent[characterIndex];}}
return closestBlock(focusNode)===originalBlock?adjacentCharacter:undefined;}
function isZwnbsp(node){return node.nodeType===Node.TEXT_NODE&&node.textContent==='\ufeff';}
function isTangible(node){return isVisible(node)||isZwnbsp(node)||hasTangibleContent(node);}
function hasTangibleContent(node){return[...(node?.childNodes||[])].some(n=>isTangible(n));}
__exports.getDeepestPosition=getDeepestPosition;function getDeepestPosition(node,offset){let direction=DIRECTIONS.RIGHT;let next=node;while(next){if(isTangible(next)||isZWS(next)){if(next!==node){[node,offset]=[next,direction?0:nodeSize(next)];}
direction=offset<node.childNodes.length;next=node.childNodes[direction?offset:offset-1];}else if(direction&&next.nextSibling&&closestBlock(node).contains(next.nextSibling)){next=next.nextSibling;}else{direction=DIRECTIONS.LEFT;next=closestBlock(node).contains(next.previousSibling)&&next.previousSibling;}
next=!isSelfClosingElement(next)&&next;}
return[node,offset];}
__exports.getCursors=getCursors;function getCursors(document){const sel=document.getSelection();if(getCursorDirection(sel.anchorNode,sel.anchorOffset,sel.focusNode,sel.focusOffset)===DIRECTIONS.LEFT)
return[[sel.focusNode,sel.focusOffset],[sel.anchorNode,sel.anchorOffset],];return[[sel.anchorNode,sel.anchorOffset],[sel.focusNode,sel.focusOffset],];}
__exports.preserveCursor=preserveCursor;function preserveCursor(document){const sel=document.getSelection();const cursorPos=[sel.anchorNode,sel.anchorOffset,sel.focusNode,sel.focusOffset];return replace=>{replace=replace||new Map();cursorPos[0]=replace.get(cursorPos[0])||cursorPos[0];cursorPos[2]=replace.get(cursorPos[2])||cursorPos[2];return setSelection(...cursorPos,false);};}
__exports.isSelectionInSelectors=isSelectionInSelectors;function isSelectionInSelectors(selector){let anchor=document.getSelection().anchorNode;if(anchor&&anchor.nodeType&&anchor.nodeType!==Node.ELEMENT_NODE){anchor=anchor.parentElement;}
if(anchor&&closestElement(anchor,selector)){return true;}
return false;}
__exports.getOffsetAndCharSize=getOffsetAndCharSize;function getOffsetAndCharSize(nodeValue,offset,direction){const splittedNodeValue=[...nodeValue];let charSize=1;let newOffset=offset;let currentSize=0;for(const item of splittedNodeValue){currentSize+=item.length;if(currentSize>=offset){newOffset=direction==DIRECTIONS.LEFT?currentSize:currentSize-item.length;charSize=item.length;break;}}
return[newOffset,charSize];}
const formatsSpecs=__exports.formatsSpecs={italic:{tagName:'em',isFormatted:isItalic,isTag:(node)=>['EM','I'].includes(node.tagName),hasStyle:(node)=>Boolean(node.style&&node.style['font-style']),addStyle:(node)=>node.style['font-style']='italic',addNeutralStyle:(node)=>node.style['font-style']='normal',removeStyle:(node)=>removeStyle(node,'font-style'),},bold:{tagName:'strong',isFormatted:isBold,isTag:(node)=>['STRONG','B'].includes(node.tagName),hasStyle:(node)=>Boolean(node.style&&node.style['font-weight']),addStyle:(node)=>node.style['font-weight']='bolder',addNeutralStyle:(node)=>{node.style['font-weight']='normal'},removeStyle:(node)=>removeStyle(node,'font-weight'),},underline:{tagName:'u',isFormatted:isUnderline,isTag:(node)=>node.tagName==='U',hasStyle:(node)=>node.style&&node.style['text-decoration-line'].includes('underline'),addStyle:(node)=>node.style['text-decoration-line']+=' underline',removeStyle:(node)=>removeStyle(node,'text-decoration-line','underline'),},strikeThrough:{tagName:'s',isFormatted:isStrikeThrough,isTag:(node)=>node.tagName==='S',hasStyle:(node)=>node.style&&node.style['text-decoration-line'].includes('line-through'),addStyle:(node)=>node.style['text-decoration-line']+=' line-through',removeStyle:(node)=>removeStyle(node,'text-decoration-line','line-through'),},fontSize:{isFormatted:isFontSize,hasStyle:(node)=>node.style&&node.style['font-size'],addStyle:(node,props)=>{node.style['font-size']=props.size;node.classList.remove(...FONT_SIZE_CLASSES);},removeStyle:(node)=>removeStyle(node,'font-size'),},setFontSizeClassName:{isFormatted:hasClass,hasStyle:(node,props)=>FONT_SIZE_CLASSES.find(cls=>node.classList.contains(cls)),addStyle:(node,props)=>node.classList.add(props.className),removeStyle:(node)=>{node.classList.remove(...FONT_SIZE_CLASSES,...TEXT_STYLE_CLASSES);if(node.classList.length===0){node.removeAttribute("class");}},},switchDirection:{isFormatted:isDirectionSwitched,}}
const removeStyle=(node,styleName,item)=>{if(item){const newStyle=node.style[styleName].split(' ').filter(x=>x!==item).join(' ');node.style[styleName]=newStyle||null;}else{node.style[styleName]=null;}
if(node.getAttribute('style')===''){node.removeAttribute('style');}};const getOrCreateSpan=(node,ancestors)=>{const span=ancestors.find((element)=>element.tagName==='SPAN'&&element.isConnected);if(span){return span;}else{const span=document.createElement('span');node.after(span);span.append(node);return span;}}
const removeFormat=(node,formatSpec)=>{node=closestElement(node);if(formatSpec.hasStyle(node)){formatSpec.removeStyle(node);if(['SPAN','FONT'].includes(node.tagName)&&!node.getAttributeNames().length){return unwrapContents(node);}}
if(formatSpec.isTag&&formatSpec.isTag(node)){const attributesNames=node.getAttributeNames().filter((name)=>{return name!=='data-oe-zws-empty-inline';});if(attributesNames.length){const newNode=document.createElement('span');while(node.firstChild){newNode.appendChild(node.firstChild);}
for(let index=node.attributes.length-1;index>=0;--index){newNode.attributes.setNamedItem(node.attributes[index].cloneNode());}
node.parentNode.replaceChild(newNode,node);}else{unwrapContents(node);}}}
const formatSelection=__exports.formatSelection=(editor,formatName,{applyStyle,formatProps}={})=>{const selection=editor.document.getSelection();let direction
let wasCollapsed;if(editor.editable.querySelector('.o_selected_td')){direction=DIRECTIONS.RIGHT;}else{if(!selection.rangeCount)return;wasCollapsed=selection.getRangeAt(0).collapsed;direction=getCursorDirection(selection.anchorNode,selection.anchorOffset,selection.focusNode,selection.focusOffset);}
getDeepRange(editor.editable,{splitText:true,select:true,correctTripleClick:true});if(typeof applyStyle==='undefined'){applyStyle=!isSelectionFormat(editor.editable,formatName);}
let zws;if(wasCollapsed){if(selection.anchorNode.nodeType===Node.TEXT_NODE&&selection.anchorNode.textContent==='\u200b'){zws=selection.anchorNode;selection.getRangeAt(0).selectNode(zws);}else{zws=insertAndSelectZws(selection);}
getDeepRange(editor.editable,{splitText:true,select:true,correctTripleClick:true});}
const selectedNodesInTds=[...editor.editable.querySelectorAll('.o_selected_td')].map(node=>closestElement(node).querySelector('br'));const selectedNodes=getSelectedNodes(editor.editable).filter(n=>n.nodeType===Node.TEXT_NODE&&closestElement(n).isContentEditable&&(isVisibleTextNode(n)||isZWS(n)));const selectedTextNodes=selectedNodes.length?selectedNodes:selectedNodesInTds;const selectedFieldNodes=new Set(getSelectedNodes(editor.editable).map(n=>closestElement(n,"*[t-field],*[t-out],*[t-esc]")).filter(Boolean));const formatSpec=formatsSpecs[formatName];for(const selectedTextNode of selectedTextNodes){const inlineAncestors=[];let currentNode=selectedTextNode;let parentNode=selectedTextNode.parentElement;while(parentNode&&!isBlock(parentNode)&&!isUnbreakable(parentNode)&&!isUnbreakable(currentNode)&&(parentNode.classList.length===0||[...parentNode.classList].every(cls=>FONT_SIZE_CLASSES.includes(cls)))){const isUselessZws=parentNode.tagName==='SPAN'&&parentNode.hasAttribute('data-oe-zws-empty-inline')&&parentNode.getAttributeNames().length===1;if(isUselessZws){unwrapContents(parentNode);}else{const newLastAncestorInlineFormat=splitAroundUntil(currentNode,parentNode);removeFormat(newLastAncestorInlineFormat,formatSpec);if(newLastAncestorInlineFormat.isConnected){inlineAncestors.push(newLastAncestorInlineFormat);currentNode=newLastAncestorInlineFormat;}}
parentNode=currentNode.parentElement;}
const firstBlockOrClassHasFormat=formatSpec.isFormatted(parentNode,formatProps);if(firstBlockOrClassHasFormat&&!applyStyle){formatSpec.addNeutralStyle&&formatSpec.addNeutralStyle(getOrCreateSpan(selectedTextNode,inlineAncestors));}else if(!firstBlockOrClassHasFormat&&applyStyle){const tag=formatSpec.tagName&&document.createElement(formatSpec.tagName);if(tag){selectedTextNode.after(tag);tag.append(selectedTextNode);if(!formatSpec.isFormatted(tag,formatProps)){tag.after(selectedTextNode);tag.remove();formatSpec.addStyle(getOrCreateSpan(selectedTextNode,inlineAncestors),formatProps);}}else if(formatName!=='fontSize'||formatProps.size!==undefined){formatSpec.addStyle(getOrCreateSpan(selectedTextNode,inlineAncestors),formatProps);}}}
for(const selectedFieldNode of selectedFieldNodes){if(applyStyle){formatSpec.addStyle(selectedFieldNode,formatProps);}else{formatSpec.removeStyle(selectedFieldNode);}}
if(zws){const siblings=[...zws.parentElement.childNodes];if(!isBlock(zws.parentElement)&&selectedTextNodes.includes(siblings[0])&&selectedTextNodes.includes(siblings[siblings.length-1])){zws.parentElement.setAttribute('data-oe-zws-empty-inline','');}else{const span=document.createElement('span');span.setAttribute('data-oe-zws-empty-inline','');zws.before(span);span.append(zws);}}
if(selectedTextNodes[0]&&selectedTextNodes[0].textContent==='\u200B'){setSelection(selectedTextNodes[0],0);}else if(selectedTextNodes.length){const firstNode=selectedTextNodes[0];const lastNode=selectedTextNodes[selectedTextNodes.length-1];if(direction===DIRECTIONS.RIGHT){setSelection(firstNode,0,lastNode,lastNode.length,false);}else{setSelection(lastNode,lastNode.length,firstNode,0,false);}}}
const isLinkEligibleForZwnbsp=__exports.isLinkEligibleForZwnbsp=(editable,link)=>{return link.isContentEditable&&editable.contains(link)&&!([link,...link.querySelectorAll('*')].some(el=>el.nodeName==='IMG'||isBlock(el))||link.matches('nav a, a.nav-link'));}
const padLinkWithZws=__exports.padLinkWithZws=(editable,link)=>{if(!isLinkEligibleForZwnbsp(editable,link)){return;}
const selection=editable.ownerDocument.getSelection()||{};const{anchorOffset,focusOffset}=selection;let extraAnchorOffset=0;let extraFocusOffset=0;if(!link.textContent.startsWith('\uFEFF')){if(selection.anchorNode===link&&anchorOffset){extraAnchorOffset+=1;}
if(selection.focusNode===link&&focusOffset){extraFocusOffset+=1;}
link.prepend(document.createTextNode('\uFEFF'));}
if(!link.textContent.endsWith('\uFEFF')){if(selection.anchorNode===link&&anchorOffset+extraAnchorOffset===nodeSize(link)){extraAnchorOffset+=1;}
if(selection.focusNode===link&&focusOffset+extraFocusOffset===nodeSize(link)){extraFocusOffset+=1;}
link.append(document.createTextNode('\uFEFF'));}
const linkIndex=childNodeIndex(link);if(!(link.previousSibling&&link.previousSibling.textContent.endsWith('\uFEFF'))){if(selection.anchorNode===link.parentElement&&anchorOffset+extraAnchorOffset>linkIndex){extraAnchorOffset+=1;}
if(selection.focusNode===link.parentElement&&focusOffset+extraFocusOffset>linkIndex){extraFocusOffset+=1;}
link.before(document.createTextNode('\uFEFF'));}
if(!(link.nextSibling&&link.nextSibling.textContent.startsWith('\uFEFF'))){if(selection.anchorNode===link.parentElement&&anchorOffset+extraAnchorOffset>linkIndex+1){extraAnchorOffset+=1;}
if(selection.focusNode===link.parentElement&&focusOffset+extraFocusOffset>linkIndex+1){extraFocusOffset+=1;}
link.after(document.createTextNode('\uFEFF'));}
if(extraAnchorOffset||extraFocusOffset){setSelection(selection.anchorNode,anchorOffset+extraAnchorOffset,selection.focusNode,focusOffset+extraFocusOffset,);}}
const blockTagNames=['ADDRESS','ARTICLE','ASIDE','BLOCKQUOTE','DETAILS','DIALOG','DD','DIV','DL','DT','FIELDSET','FIGCAPTION','FIGURE','FOOTER','FORM','H1','H2','H3','H4','H5','H6','HEADER','HGROUP','HR','LI','MAIN','NAV','OL','P','PRE','SECTION','TABLE','UL','SELECT','OPTION','TR','TD','TBODY','THEAD','TH',];const computedStyles=new WeakMap();__exports.isBlock=isBlock;function isBlock(node){if(!node||node.nodeType!==Node.ELEMENT_NODE){return false;}
const tagName=node.nodeName.toUpperCase();if(tagName.startsWith('JW-')||(tagName==='T'&&node.getAttribute('t-esc')===null&&node.getAttribute('t-out')===null&&node.getAttribute('t-raw')===null)){return true;}
if(tagName==='BR'){return false;}
if(!node.isConnected){return blockTagNames.includes(tagName);}
let style=computedStyles.get(node);if(!style){style=node.ownerDocument.defaultView?.getComputedStyle(node);computedStyles.set(node,style);}
if(style?.display){return!style.display.includes('inline')&&style.display!=='contents';}
return blockTagNames.includes(tagName);}
__exports.isBold=isBold;function isBold(node){const fontWeight=+getComputedStyle(closestElement(node)).fontWeight;return fontWeight>500||fontWeight>+getComputedStyle(closestBlock(node)).fontWeight;}
__exports.isItalic=isItalic;function isItalic(node){return getComputedStyle(closestElement(node)).fontStyle==='italic';}
__exports.isUnderline=isUnderline;function isUnderline(node){let parent=closestElement(node);while(parent){if(getComputedStyle(parent).textDecorationLine.includes('underline')){return true;}
parent=parent.parentElement;}
return false;}
__exports.isStrikeThrough=isStrikeThrough;function isStrikeThrough(node){let parent=closestElement(node);while(parent){if(getComputedStyle(parent).textDecorationLine.includes('line-through')){return true;}
parent=parent.parentElement;}
return false;}
__exports.isFontSize=isFontSize;function isFontSize(node,props){const element=closestElement(node);return getComputedStyle(element)['font-size']===props.size;}
__exports.hasClass=hasClass;function hasClass(node,props){const element=closestElement(node);return element.classList.contains(props.className);}
__exports.isDirectionSwitched=isDirectionSwitched;function isDirectionSwitched(node,editable){const defaultDirection=editable.getAttribute('dir');return getComputedStyle(closestElement(node)).direction!==defaultDirection;}
__exports.isSelectionFormat=isSelectionFormat;function isSelectionFormat(editable,format){const selectedNodes=getTraversedNodes(editable).filter(n=>n.nodeType===Node.TEXT_NODE);const isFormatted=formatsSpecs[format].isFormatted;return selectedNodes.length&&selectedNodes.every(n=>isFormatted(n,editable));}
__exports.isUnbreakable=isUnbreakable;function isUnbreakable(node){if(!node||node.nodeType===Node.TEXT_NODE){return false;}
if(node.nodeType!==Node.ELEMENT_NODE){return true;}
return(isUnremovable(node)||['TABLE','THEAD','TBODY','TFOOT','TR','TH','TD','SECTION','DIV'].includes(node.tagName)||node.hasAttribute('t')||(node.nodeType===Node.ELEMENT_NODE&&(node.nodeName==='T'||node.getAttribute('t-if')||node.getAttribute('t-esc')||node.getAttribute('t-elif')||node.getAttribute('t-else')||node.getAttribute('t-foreach')||node.getAttribute('t-value')||node.getAttribute('t-out')||node.getAttribute('t-raw'))||node.getAttribute('t-field'))||node.classList.contains('oe_unbreakable'));}
__exports.isUnremovable=isUnremovable;function isUnremovable(node){return((node.nodeType!==Node.ELEMENT_NODE&&node.nodeType!==Node.TEXT_NODE)||node.oid==='root'||(node.nodeType===Node.ELEMENT_NODE&&(node.classList.contains('o_editable')||node.getAttribute('t-set')||node.getAttribute('t-call')))||(node.classList&&node.classList.contains('oe_unremovable'))||(node.nodeName==='SPAN'&&node.parentElement&&node.parentElement.getAttribute('data-oe-type')==='monetary')||(node.ownerDocument&&node.ownerDocument.defaultWindow&&!ancestors(node).find(ancestor=>ancestor.oid==='root')));}
__exports.containsUnbreakable=containsUnbreakable;function containsUnbreakable(node){if(!node){return false;}
return isUnbreakable(node)||containsUnbreakable(node.firstChild);}
const iconTags=['I','SPAN'];const iconClasses=['fa','fab','fad','far','oi'];__exports.isFontAwesome=isFontAwesome;function isFontAwesome(node){return(node&&iconTags.includes(node.nodeName)&&iconClasses.some(cls=>node.classList.contains(cls)));}
const ICON_SELECTOR=__exports.ICON_SELECTOR=iconTags.map(tag=>{return iconClasses.map(cls=>{return`${tag}.${cls}`;}).join(', ');}).join(', ');__exports.isZWS=isZWS;function isZWS(node){return(node&&node.textContent==='\u200B');}
__exports.isEditorTab=isEditorTab;function isEditorTab(node){return(node&&(node.nodeName==='SPAN')&&node.classList.contains('oe-tabs'));}
__exports.isMediaElement=isMediaElement;function isMediaElement(node){return(isFontAwesome(node)||(node.classList&&(node.classList.contains('o_image')||node.classList.contains('media_iframe_video'))));}
__exports.isProtected=isProtected;function isProtected(node){const closestProtectedElement=closestElement(node,'[data-oe-protected]');if(closestProtectedElement){return["","true"].includes(closestProtectedElement.dataset.oeProtected);}
return false;}
const VOID_ELEMENT_NAMES=['AREA','BASE','BR','COL','EMBED','HR','IMG','INPUT','KEYGEN','LINK','META','PARAM','SOURCE','TRACK','WBR'];__exports.isArtificialVoidElement=isArtificialVoidElement;function isArtificialVoidElement(node){return isMediaElement(node)||node.nodeName==='HR';}
__exports.isNotAllowedContent=isNotAllowedContent;function isNotAllowedContent(node){return isArtificialVoidElement(node)||VOID_ELEMENT_NAMES.includes(node.nodeName);}
__exports.containsUnremovable=containsUnremovable;function containsUnremovable(node){if(!node){return false;}
return isUnremovable(node)||containsUnremovable(node.firstChild);}
__exports.getInSelection=getInSelection;function getInSelection(document,selector){const selection=document.getSelection();const range=selection&&!!selection.rangeCount&&selection.getRangeAt(0);if(range){const selectorInStartAncestors=closestElement(range.startContainer,selector);if(selectorInStartAncestors){return selectorInStartAncestors;}else{const commonElementAncestor=closestElement(range.commonAncestorContainer);return commonElementAncestor&&[...commonElementAncestor.querySelectorAll(selector)].find(node=>range.intersectsNode(node),);}}}
__exports.getRowIndex=getRowIndex;function getRowIndex(trOrTd){const tr=closestElement(trOrTd,'tr');const trParent=tr&&tr.parentElement;if(!trParent){return-1;}
const trSiblings=[...trParent.children].filter(child=>child.nodeName==='TR');return trSiblings.findIndex(child=>child===tr);}
__exports.getColumnIndex=getColumnIndex;function getColumnIndex(td){const tdParent=td.parentElement;if(!tdParent){return-1;}
const tdSiblings=[...tdParent.children].filter(child=>child.nodeName==='TD'||child.nodeName==='TH');return tdSiblings.findIndex(child=>child===td);}
const paragraphRelatedElements=__exports.paragraphRelatedElements=['P','H1','H2','H3','H4','H5','H6','PRE','BLOCKQUOTE',];__exports.allowsParagraphRelatedElements=allowsParagraphRelatedElements;function allowsParagraphRelatedElements(node){return isBlock(node)&&!paragraphRelatedElements.includes(node.nodeName);}
__exports.makeContentsInline=makeContentsInline;function makeContentsInline(node){let childIndex=0;for(const child of node.childNodes){if(isBlock(child)){if(childIndex&&paragraphRelatedElements.includes(child.nodeName)){child.before(document.createElement('br'));}
for(const grandChild of child.childNodes){child.before(grandChild);makeContentsInline(grandChild);}
child.remove();}
childIndex+=1;}}
__exports.getOuid=getOuid;function getOuid(node,optimize=false){while(node&&!isUnbreakable(node)){if(node.ouid&&optimize)return node.ouid;node=node.parentNode;}
return node&&node.oid;}
__exports.isHtmlContentSupported=isHtmlContentSupported;function isHtmlContentSupported(node){return!closestElement(node,'[data-oe-model]:not([data-oe-field="arch"]):not([data-oe-type="html"]),[data-oe-translation-id]',true);}
const selfClosingElementTags=['BR','IMG','INPUT'];__exports.isSelfClosingElement=isSelfClosingElement;function isSelfClosingElement(node){return node&&selfClosingElementTags.includes(node.nodeName);}
__exports.isInPre=isInPre;function isInPre(node){const element=node.nodeType===Node.TEXT_NODE?node.parentElement:node;return(!!element&&(!!element.closest('pre')||getComputedStyle(element).getPropertyValue('white-space')==='pre'));}
const whitespace=`[^\\S\\u00A0\\u0009\\ufeff]`;const whitespaceRegex=new RegExp(`^${whitespace}*$`);__exports.isWhitespace=isWhitespace;function isWhitespace(value){const str=typeof value==='string'?value:value.nodeValue;return whitespaceRegex.test(str);}
__exports.isVisible=isVisible;function isVisible(node){return!!node&&((node.nodeType===Node.TEXT_NODE&&isVisibleTextNode(node))||(node.nodeType===Node.ELEMENT_NODE&&(node.getAttribute("t-esc")||node.getAttribute("t-out")))||isSelfClosingElement(node)||isFontAwesome(node)||hasVisibleContent(node));}
__exports.hasVisibleContent=hasVisibleContent;function hasVisibleContent(node){return[...(node?.childNodes||[])].some(n=>isVisible(n));}
const visibleCharRegex=/[^\s\u200b]|[\u00A0\u0009]$/;__exports.isVisibleTextNode=isVisibleTextNode;function isVisibleTextNode(testedNode){if(!testedNode||!testedNode.length||testedNode.nodeType!==Node.TEXT_NODE){return false;}
if(visibleCharRegex.test(testedNode.textContent)||(isInPre(testedNode)&&isWhitespace(testedNode))){return true;}
if(ZERO_WIDTH_CHARS.includes(testedNode.textContent)){return false;}
let preceding;let following;let foundTestedNode;const currentNodeParentBlock=closestBlock(testedNode);if(!currentNodeParentBlock){return false;}
const nodeIterator=document.createNodeIterator(currentNodeParentBlock);for(let node=nodeIterator.nextNode();node;node=nodeIterator.nextNode()){if(node.nodeType===Node.TEXT_NODE){if(foundTestedNode){following=node;break;}else if(testedNode===node){foundTestedNode=true;}else{preceding=node;}}else if(isBlock(node)){if(foundTestedNode){break;}else{preceding=null;}}else if(foundTestedNode&&!isWhitespace(node)){following=node;break;}}
while(following&&!visibleCharRegex.test(following.textContent)){following=following.nextSibling;}
if(!(preceding&&following)||currentNodeParentBlock!==closestBlock(preceding)||currentNodeParentBlock!==closestBlock(following)){return false;}
return visibleCharRegex.test(preceding.textContent);}
__exports.parentsGet=parentsGet;function parentsGet(node,root=undefined){const parents=[];while(node){parents.unshift(node);if(node===root){break;}
node=node.parentNode;}
return parents;}
__exports.commonParentGet=commonParentGet;function commonParentGet(node1,node2,root=undefined){if(!node1||!node2){return null;}
const n1p=parentsGet(node1,root);const n2p=parentsGet(node2,root);while(n1p.length>1&&n1p[1]===n2p[1]){n1p.shift();n2p.shift();}
return n1p[0]===n2p[0]?n1p[0]:null;}
__exports.getListMode=getListMode;function getListMode(pnode){if(pnode.tagName=='OL')return'OL';return pnode.classList.contains('o_checklist')?'CL':'UL';}
__exports.createList=createList;function createList(mode){const node=document.createElement(mode=='OL'?'OL':'UL');if(mode=='CL'){node.classList.add('o_checklist');}
return node;}
__exports.insertListAfter=insertListAfter;function insertListAfter(afterNode,mode,content=[]){const list=createList(mode);afterNode.after(list);list.append(...content.map(c=>{const li=document.createElement('LI');li.append(...[].concat(c));return li;}),);return list;}
__exports.toggleClass=toggleClass;function toggleClass(node,className){node.classList.toggle(className);if(!node.className){node.removeAttribute('class');}}
__exports.makeZeroWidthCharactersVisible=makeZeroWidthCharactersVisible;function makeZeroWidthCharactersVisible(text){return text.replaceAll('\u200B','//ZWSP//').replaceAll('\uFEFF','//ZWNBSP//');}
__exports.isFakeLineBreak=isFakeLineBreak;function isFakeLineBreak(brEl){return!(getState(...rightPos(brEl),DIRECTIONS.RIGHT).cType&(CTYPES.CONTENT|CTGROUPS.BR));}
__exports.isEmptyBlock=isEmptyBlock;function isEmptyBlock(blockEl){if(!blockEl||blockEl.nodeType!==Node.ELEMENT_NODE){return false;}
if(isFontAwesome(blockEl)||visibleCharRegex.test(blockEl.textContent)){return false;}
if(blockEl.querySelectorAll('br').length>=2){return false;}
const nodes=blockEl.querySelectorAll('*');for(const node of nodes){if(node.nodeName!='BR'&&(isSelfClosingElement(node)||isFontAwesome(node))){return false;}}
return true;}
__exports.isShrunkBlock=isShrunkBlock;function isShrunkBlock(blockEl){return(isEmptyBlock(blockEl)&&!blockEl.querySelector('br')&&blockEl.nodeName!=="IMG");}
__exports.isColorGradient=isColorGradient;function isColorGradient(value){return value&&value.includes('-gradient(');}
__exports.getFontSizeDisplayValue=getFontSizeDisplayValue;function getFontSizeDisplayValue(sel,getCSSVariableValue,convertNumericToUnit){const tagNameRelatedToFontSize=["h1","h2","h3","h4","h5","h6"];const styleClassesRelatedToFontSize=["display-1","display-2","display-3","display-4"];const closestStartContainerEl=closestElement(sel.getRangeAt(0).startContainer);const closestFontSizedEl=closestStartContainerEl.closest(`
        [style*='font-size'],
        ${FONT_SIZE_CLASSES.map(className => `.${className}`)},
        ${styleClassesRelatedToFontSize.map(className => `.${className}`)},
        ${tagNameRelatedToFontSize}
    `);let remValue;if(closestFontSizedEl){const useFontSizeInput=closestFontSizedEl.style.fontSize;if(useFontSizeInput){return parseFloat(getComputedStyle(closestStartContainerEl).fontSize);}
const fontSizeClass=FONT_SIZE_CLASSES.find(className=>closestFontSizedEl.classList.contains(className));let fsName;if(fontSizeClass){fsName=fontSizeClass.substring(0,fontSizeClass.length-3);}else{fsName=styleClassesRelatedToFontSize.find(className=>closestFontSizedEl.classList.contains(className))||closestFontSizedEl.tagName.toLowerCase();}
remValue=parseFloat(getCSSVariableValue(`${fsName}-font-size`));}
if(remValue===undefined){remValue=parseFloat(getCSSVariableValue("font-size-base"));}
const pxValue=convertNumericToUnit(remValue,"rem","px");return pxValue||parseFloat(getComputedStyle(closestStartContainerEl).fontSize);}
__exports.splitTextNode=splitTextNode;function splitTextNode(textNode,offset,originalNodeSide=DIRECTIONS.RIGHT){let parentOffset=childNodeIndex(textNode);if(offset>0){parentOffset++;if(offset<textNode.length){const left=textNode.nodeValue.substring(0,offset);const right=textNode.nodeValue.substring(offset);if(originalNodeSide===DIRECTIONS.LEFT){const newTextNode=document.createTextNode(right);textNode.after(newTextNode);textNode.nodeValue=left;}else{const newTextNode=document.createTextNode(left);textNode.before(newTextNode);textNode.nodeValue=right;}}}
return parentOffset;}
__exports.splitElement=splitElement;function splitElement(element,offset){const before=element.cloneNode();const after=element.cloneNode();let index=0;for(const child of[...element.childNodes]){index<offset?before.appendChild(child):after.appendChild(child);index++;}
const blockEl=closestBlock(after);if(blockEl){fillEmpty(blockEl);}
element.before(before);element.after(after);element.remove();return[before,after];}
__exports.splitAroundUntil=splitAroundUntil;function splitAroundUntil(elements,limitAncestor){elements=Array.isArray(elements)?elements:[elements];const firstNode=elements[0];const lastNode=elements[elements.length-1];if([firstNode,lastNode].includes(limitAncestor)){return limitAncestor;}
let before=firstNode.previousSibling;let after=lastNode.nextSibling;let beforeSplit,afterSplit;if(!before&&!after&&elements[0]!==limitAncestor){return splitAroundUntil(elements[0].parentElement,limitAncestor);}
while(after&&after.parentElement!==limitAncestor){afterSplit=splitElement(after.parentElement,childNodeIndex(after))[0];after=afterSplit.nextSibling;}
if(after){afterSplit=splitElement(limitAncestor,childNodeIndex(after))[0];limitAncestor=afterSplit;}
while(before&&before.parentElement!==limitAncestor){beforeSplit=splitElement(before.parentElement,childNodeIndex(before)+1)[1];before=beforeSplit.previousSibling;}
if(before){beforeSplit=splitElement(limitAncestor,childNodeIndex(before)+1)[1];}
return beforeSplit||afterSplit||limitAncestor;}
__exports.insertText=insertText;function insertText(sel,content){if(!content){return;}
if(sel.anchorNode.nodeType===Node.TEXT_NODE){const pos=[sel.anchorNode.parentElement,splitTextNode(sel.anchorNode,sel.anchorOffset)];setSelection(...pos,...pos,false);}
const txt=document.createTextNode(content||'#');const restore=prepareUpdate(sel.anchorNode,sel.anchorOffset);sel.getRangeAt(0).insertNode(txt);restore();setSelection(...boundariesOut(txt),false);return txt;}
__exports.insertCharsAt=insertCharsAt;function insertCharsAt(chars,node,offset){if(node.nodeType===Node.TEXT_NODE){const startValue=node.nodeValue;if(offset<0||offset>startValue.length){throw new Error(`Invalid ${chars} insertion in text node`);}
node.nodeValue=startValue.slice(0,offset)+chars+startValue.slice(offset);}else{if(offset<0||offset>node.childNodes.length){throw new Error(`Invalid ${chars} insertion in non-text node`);}
const textNode=document.createTextNode(chars);if(offset<node.childNodes.length){node.insertBefore(textNode,node.childNodes[offset]);}else{node.appendChild(textNode);}}}
__exports.unwrapContents=unwrapContents;function unwrapContents(node){const contents=[...node.childNodes];for(const child of contents){node.parentNode.insertBefore(child,node);}
node.parentNode.removeChild(node);return contents;}
__exports.fillEmpty=fillEmpty;function fillEmpty(el){const fillers={};const blockEl=closestBlock(el);if(isShrunkBlock(blockEl)){const br=document.createElement('br');blockEl.appendChild(br);fillers.br=br;}
if(!isTangible(el)&&!el.hasAttribute("data-oe-zws-empty-inline")&&!el.hasChildNodes()){const zws=document.createTextNode('\u200B');el.appendChild(zws);el.setAttribute("data-oe-zws-empty-inline","");fillers.zws=zws;const previousSibling=el.previousSibling;if(previousSibling&&previousSibling.nodeName==="BR"){previousSibling.remove();}
setSelection(zws,0,zws,0);}
if(!isVisible(el)&&el.nodeName!=='A'&&closestElement(el,'a')&&getComputedStyle(el).display==='inline'){el.style.display='inline-block';}
return fillers;}
__exports.insertAndSelectZws=insertAndSelectZws;function insertAndSelectZws(selection){const offset=selection.anchorOffset;const zws=insertText(selection,'\u200B');splitTextNode(zws,offset);selection.getRangeAt(0).selectNode(zws);return zws;}
__exports.setTagName=setTagName;function setTagName(el,newTagName){if(el.tagName===newTagName){return el;}
const n=document.createElement(newTagName);if(el.nodeName!=='LI'){const attributes=el.attributes;for(const attr of attributes){n.setAttribute(attr.name,attr.value);}}
while(el.firstChild){n.append(el.firstChild);}
if(el.tagName==='LI'){el.append(n);}else{el.parentNode.replaceChild(n,el);}
return n;}
__exports.moveNodes=moveNodes;function moveNodes(destinationEl,destinationOffset,sourceEl,startIndex=0,endIndex=sourceEl.childNodes.length,){if(selfClosingElementTags.includes(destinationEl.nodeName)){throw new Error(`moveNodes: Invalid destination element ${destinationEl.nodeName}`);}
const nodes=[];for(let i=startIndex;i<endIndex;i++){nodes.push(sourceEl.childNodes[i]);}
if(nodes.length){const restoreDestination=prepareUpdate(destinationEl,destinationOffset);const restoreMoved=prepareUpdate(...leftPos(sourceEl.childNodes[startIndex]),...rightPos(sourceEl.childNodes[endIndex-1]),);const fragment=document.createDocumentFragment();nodes.forEach(node=>fragment.appendChild(node));const posRightNode=destinationEl.childNodes[destinationOffset];if(posRightNode){destinationEl.insertBefore(fragment,posRightNode);}else{destinationEl.appendChild(fragment);}
restoreDestination();restoreMoved();}
if(!nodeSize(sourceEl)){const restoreOrigin=prepareUpdate(...boundariesOut(sourceEl));sourceEl.remove();restoreOrigin();}
const firstNode=nodes.find(node=>!!node.parentNode);return firstNode?leftPos(firstNode):[destinationEl,destinationOffset];}
__exports.resetOuids=resetOuids;function resetOuids(node){node.ouid=undefined;for(const descendant of descendants(node)){descendant.ouid=undefined;}}
const prepareUpdateLockedEditables=new Set();__exports.prepareUpdate=prepareUpdate;function prepareUpdate(...args){const closestRoot=args.length&&ancestors(args[0]).find(ancestor=>ancestor.oid==='root');const isPrepareUpdateLocked=closestRoot&&prepareUpdateLockedEditables.has(closestRoot);const hash=(Math.random()+1).toString(36).substring(7);const options={allowReenter:true,label:hash,debug:false,...(args.length&&args[args.length-1]instanceof Object?args.pop():{}),};if(options.debug){console.log('%cPreparing%c update: '+options.label+
(options.label===hash?'':` (${hash})`)+'%c'+(isPrepareUpdateLocked?' LOCKED':''),'color: cyan;','color: white;','color: red; font-weight: bold;',);}
if(isPrepareUpdateLocked){return()=>{if(options.debug){console.log('%cRestoring%c update: '+options.label+
(options.label===hash?'':` (${hash})`)+'%c LOCKED','color: lightgreen;','color: white;','color: red; font-weight: bold;',);}};}
if(!options.allowReenter&&closestRoot){prepareUpdateLockedEditables.add(closestRoot);}
const positions=[...args];const restoreData=[];let el,offset;while(positions.length){offset=positions.pop();el=positions.pop();const left=getState(el,offset,DIRECTIONS.LEFT);const right=getState(el,offset,DIRECTIONS.RIGHT,left.cType);if(options.debug){const editable=el&&closestElement(el,'.odoo-editor-editable');const oldEditableHTML=editable&&makeZeroWidthCharactersVisible(editable.innerHTML).replaceAll(' ','_')||'';left.oldEditableHTML=oldEditableHTML;right.oldEditableHTML=oldEditableHTML;}
restoreData.push(left,right);}
return function restoreStates(){if(options.debug){console.log('%cRestoring%c update: '+options.label+
(options.label===hash?'':` (${hash})`),'color: lightgreen;','color: white;',);}
for(const data of restoreData){restoreState(data,options.debug);}
if(!options.allowReenter&&closestRoot){prepareUpdateLockedEditables.delete(closestRoot);}};}
__exports.getState=getState;function getState(el,offset,direction,leftCType){const leftDOMPath=leftLeafOnlyNotBlockPath;const rightDOMPath=rightLeafOnlyNotBlockPath;let domPath;let inverseDOMPath;const whitespaceAtStartRegex=new RegExp('^'+whitespace+'+');const whitespaceAtEndRegex=new RegExp(whitespace+'+$');const reasons=[];if(direction===DIRECTIONS.LEFT){domPath=leftDOMPath(el,offset,reasons);inverseDOMPath=rightDOMPath(el,offset);}else{domPath=rightDOMPath(el,offset,reasons);inverseDOMPath=leftDOMPath(el,offset);}
const boundaryNode=inverseDOMPath.next().value;let cType=undefined;let lastSpace=null;for(const node of domPath){if(node.nodeType===Node.TEXT_NODE){const value=node.nodeValue.replaceAll('\ufeff','');if(direction===DIRECTIONS.LEFT){if(!isWhitespace(value)){if(lastSpace){cType=CTYPES.SPACE;}else{const rightLeaf=rightLeafOnlyNotBlockPath(node).next().value;const hasContentRight=rightLeaf&&!whitespaceAtStartRegex.test(rightLeaf.textContent);cType=!hasContentRight&&whitespaceAtEndRegex.test(node.textContent)?CTYPES.SPACE:CTYPES.CONTENT;}
break;}
if(value.length){lastSpace=node;}}else{leftCType=leftCType||getState(el,offset,DIRECTIONS.LEFT).cType;if(whitespaceAtStartRegex.test(value)){const leftLeaf=leftLeafOnlyNotBlockPath(node).next().value;const hasContentLeft=leftLeaf&&!whitespaceAtEndRegex.test(leftLeaf.textContent);const rct=!isWhitespace(value)?CTYPES.CONTENT:getState(...rightPos(node),DIRECTIONS.RIGHT).cType;cType=leftCType&CTYPES.CONTENT&&rct&(CTYPES.CONTENT|CTYPES.BR)&&!hasContentLeft?CTYPES.SPACE:rct;break;}
if(!isWhitespace(value)){cType=CTYPES.CONTENT;break;}}}else if(node.nodeName==='BR'){cType=CTYPES.BR;break;}else if(isVisible(node)){cType=CTYPES.CONTENT;break;}}
if(cType===undefined){cType=reasons.includes(PATH_END_REASONS.BLOCK_HIT)?CTYPES.BLOCK_OUTSIDE:CTYPES.BLOCK_INSIDE;}
return{node:boundaryNode,direction:direction,cType:cType,};}
const priorityRestoreStateRules=[[{cType1:CTYPES.CONTENT,cType2:CTYPES.SPACE|CTGROUPS.BLOCK},{spaceVisibility:true},],[{direction:DIRECTIONS.LEFT,cType1:CTGROUPS.INLINE,cType2:CTGROUPS.BR},{spaceVisibility:true},],[{direction:DIRECTIONS.RIGHT,cType1:CTGROUPS.CONTENT,cType2:CTGROUPS.BR},{spaceVisibility:true},],[{direction:DIRECTIONS.RIGHT,cType1:CTGROUPS.BR,cType2:CTYPES.SPACE|CTGROUPS.BLOCK},{spaceVisibility:true},],[{cType1:CTYPES.SPACE},{spaceVisibility:false},],[{direction:DIRECTIONS.LEFT,cType1:CTGROUPS.BR},{spaceVisibility:false},],[{cType1:CTGROUPS.BLOCK,cType2:CTGROUPS.INLINE|CTGROUPS.BR},{spaceVisibility:false},],[{direction:DIRECTIONS.RIGHT,cType1:CTGROUPS.INLINE,cType2:CTGROUPS.BLOCK},{brVisibility:true},],[{direction:DIRECTIONS.RIGHT,cType1:CTGROUPS.BLOCK,cType2:CTGROUPS.INLINE|CTGROUPS.BR,},{brVisibility:false},],[{direction:DIRECTIONS.LEFT,cType1:CTGROUPS.BR|CTGROUPS.BLOCK,cType2:CTGROUPS.INLINE,},{brVisibility:false,extraBRRemovalCondition:brNode=>isFakeLineBreak(brNode)},],];function restoreStateRuleHashCode(direction,cType1,cType2){return`${direction}-${cType1}-${cType2}`;}
const allRestoreStateRules=(function(){const map=new Map();const keys=['direction','cType1','cType2'];for(const direction of Object.values(DIRECTIONS)){for(const cType1 of Object.values(CTYPES)){for(const cType2 of Object.values(CTYPES)){const rule={direction:direction,cType1:cType1,cType2:cType2};const matchedRules=[];for(const entry of priorityRestoreStateRules){let priority=0;for(const key of keys){const entryKeyValue=entry[0][key];if(entryKeyValue!==undefined){if(typeof entryKeyValue==='boolean'?rule[key]===entryKeyValue:rule[key]&entryKeyValue){priority++;}else{priority=-1;break;}}}
if(priority>=0){matchedRules.push([priority,entry[1]]);}}
const finalRule={};for(let p=0;p<=keys.length;p++){for(const entry of matchedRules){if(entry[0]===p){Object.assign(finalRule,entry[1]);}}}
const hashCode=restoreStateRuleHashCode(direction,cType1,cType2);map.set(hashCode,finalRule);}}}
return map;})();__exports.restoreState=restoreState;function restoreState(prevStateData,debug=false){const{node,direction,cType:cType1,oldEditableHTML}=prevStateData;if(!node||!node.parentNode){return;}
const[el,offset]=direction===DIRECTIONS.LEFT?leftPos(node):rightPos(node);const{cType:cType2}=getState(el,offset,direction);const ruleHashCode=restoreStateRuleHashCode(direction,cType1,cType2);const rule=allRestoreStateRules.get(ruleHashCode);if(debug){const editable=closestElement(node,'.odoo-editor-editable');console.log('%c'+makeZeroWidthCharactersVisible(node.textContent).replaceAll(' ','_')+'\n'+'%c'+(direction===DIRECTIONS.LEFT?'left':'right')+'\n'+'%c'+ctypeToString(cType1)+'\n'+'%c'+ctypeToString(cType2)+'\n'+'%c'+'BEFORE: '+(oldEditableHTML||'(unavailable)')+'\n'+'%c'+'AFTER:  '+(editable?makeZeroWidthCharactersVisible(editable.innerHTML).replaceAll(' ','_'):'(unavailable)')+'\n','color: white; display: block; width: 100%;','color: '+(direction===DIRECTIONS.LEFT?'magenta':'lightgreen')+'; display: block; width: 100%;','color: pink; display: block; width: 100%;','color: lightblue; display: block; width: 100%;','color: white; display: block; width: 100%;','color: white; display: block; width: 100%;',rule,);}
if(Object.values(rule).filter(x=>x!==undefined).length){const inverseDirection=direction===DIRECTIONS.LEFT?DIRECTIONS.RIGHT:DIRECTIONS.LEFT;enforceWhitespace(el,offset,inverseDirection,rule);}
return rule;}
__exports.enforceWhitespace=enforceWhitespace;function enforceWhitespace(el,offset,direction,rule){let domPath,whitespaceAtEdgeRegex;if(direction===DIRECTIONS.LEFT){domPath=leftLeafOnlyNotBlockPath(el,offset);whitespaceAtEdgeRegex=new RegExp(whitespace+'+$');}else{domPath=rightLeafOnlyNotBlockPath(el,offset);whitespaceAtEdgeRegex=new RegExp('^'+whitespace+'+');}
const invisibleSpaceTextNodes=[];let foundVisibleSpaceTextNode=null;for(const node of domPath){if(node.nodeName==='BR'){if(rule.brVisibility===undefined){break;}
if(rule.brVisibility){node.before(document.createElement('br'));}else{if(!rule.extraBRRemovalCondition||rule.extraBRRemovalCondition(node)){node.remove();}}
break;}else if(node.nodeType===Node.TEXT_NODE&&!isInPre(node)){if(whitespaceAtEdgeRegex.test(node.nodeValue)){if(!isWhitespace(node)){foundVisibleSpaceTextNode=node;break;}else{invisibleSpaceTextNodes.push(node);}}else if(!isWhitespace(node)){break;}}else{break;}}
if(rule.spaceVisibility===undefined){return;}
if(!rule.spaceVisibility){for(const node of invisibleSpaceTextNodes){node.nodeValue='';const ancestorPath=closestPath(node.parentNode);let toRemove=null;for(const pNode of ancestorPath){if(toRemove){toRemove.remove();}
if(pNode.childNodes.length===1&&!isBlock(pNode)){pNode.after(node);toRemove=pNode;}else{break;}}}}
const spaceNode=foundVisibleSpaceTextNode||invisibleSpaceTextNodes[0];if(spaceNode){let spaceVisibility=rule.spaceVisibility;if(spaceVisibility&&!foundVisibleSpaceTextNode&&getState(...rightPos(spaceNode),DIRECTIONS.RIGHT).cType&CTGROUPS.BLOCK&&getState(...leftPos(spaceNode),DIRECTIONS.LEFT).cType!==CTYPES.CONTENT){spaceVisibility=false;}
spaceNode.nodeValue=spaceNode.nodeValue.replace(whitespaceAtEdgeRegex,spaceVisibility?'\u00A0':'');}}
__exports.rgbToHex=rgbToHex;function rgbToHex(rgb='',node=null){if(rgb.startsWith('#')){return rgb;}else if(rgb.startsWith('rgba')){const values=rgb.match(/[\d\.]{1,5}/g)||[];const alpha=parseFloat(values.pop());let bgRgbValues=[];if(node){let bgColor=getComputedStyle(node).backgroundColor;if(bgColor.startsWith('rgba')){bgColor=rgbToHex(bgColor,node.parentElement);}
if(bgColor&&bgColor.startsWith('#')){bgRgbValues=(bgColor.match(/[\da-f]{2}/gi)||[]).map(val=>parseInt(val,16));}else if(bgColor&&bgColor.startsWith('rgb')){bgRgbValues=(bgColor.match(/[\d\.]{1,5}/g)||[]).map(val=>parseInt(val));}}
bgRgbValues=bgRgbValues.length?bgRgbValues:[255,255,255];return('#'+
values.map((value,index)=>{const converted=Math.floor(alpha*parseInt(value)+(1-alpha)*bgRgbValues[index]);const hex=parseInt(converted).toString(16);return hex.length===1?'0'+hex:hex;}).join(''));}else{return('#'+
(rgb.match(/\d{1,3}/g)||[]).map(x=>{x=parseInt(x).toString(16);return x.length===1?'0'+x:x;}).join(''));}}
__exports.parseHTML=parseHTML;function parseHTML(document,html){const fragment=document.createDocumentFragment();const parser=new document.defaultView.DOMParser();const parsedDocument=parser.parseFromString(html,'text/html');fragment.replaceChildren(...parsedDocument.body.childNodes);return fragment;}
__exports.pxToFloat=pxToFloat;function pxToFloat(sizeString){return parseFloat(sizeString.replace('px',''));}
__exports.getRangePosition=getRangePosition;function getRangePosition(el,document,options={}){const selection=document.getSelection();if(!selection.rangeCount)return;const range=selection.getRangeAt(0);const isRtl=options.direction==='rtl';const marginRight=options.marginRight||20;const marginBottom=options.marginBottom||20;const marginTop=options.marginTop||10;const marginLeft=options.marginLeft||10;let offset;if(range.endOffset-1>0){const clonedRange=range.cloneRange();clonedRange.setStart(range.endContainer,range.endOffset-1);clonedRange.setEnd(range.endContainer,range.endOffset);const rect=clonedRange.getBoundingClientRect();offset={height:rect.height,left:rect.left+rect.width,top:rect.top};clonedRange.detach();}
if(!offset||offset.height===0){const clonedRange=range.cloneRange();const shadowCaret=document.createTextNode('|');clonedRange.insertNode(shadowCaret);clonedRange.selectNode(shadowCaret);const rect=clonedRange.getBoundingClientRect();offset={height:rect.height,left:rect.left,top:rect.top};shadowCaret.remove();clonedRange.detach();}
if(isRtl){offset.right=offset.left-el.offsetWidth;const leftMove=Math.max(0,offset.right+el.offsetWidth+marginLeft-window.innerWidth);if(leftMove&&offset.right-leftMove>marginRight){offset.right-=leftMove;}else if(offset.right-leftMove<marginRight){offset.right=marginRight;}}
const leftMove=Math.max(0,offset.left+el.offsetWidth+marginRight-window.innerWidth);if(leftMove&&offset.left-leftMove>marginLeft){offset.left-=leftMove;}else if(offset.left-leftMove<marginLeft){offset.left=marginLeft;}
if(options.parentContextRect){offset.left+=options.parentContextRect.left;offset.top+=options.parentContextRect.top;if(isRtl){offset.right+=options.parentContextRect.left;}}
if(offset.top-marginTop+offset.height+el.offsetHeight>window.innerHeight&&offset.top-el.offsetHeight-marginBottom>0){offset.top-=el.offsetHeight;}else{offset.top+=offset.height;}
if(offset){offset.top+=window.scrollY;offset.left+=window.scrollX;if(isRtl){offset.right+=window.scrollX;}}
if(isRtl){offset.right=window.innerWidth-offset.right-el.offsetWidth;}
return offset;}
const isNotEditableNode=__exports.isNotEditableNode=node=>node.getAttribute&&node.getAttribute('contenteditable')&&node.getAttribute('contenteditable').toLowerCase()==='false';const leftLeafFirstPath=__exports.leftLeafFirstPath=createDOMPathGenerator(DIRECTIONS.LEFT);const leftLeafOnlyNotBlockPath=__exports.leftLeafOnlyNotBlockPath=createDOMPathGenerator(DIRECTIONS.LEFT,{leafOnly:true,stopTraverseFunction:isBlock,stopFunction:isBlock,});const leftLeafOnlyInScopeNotBlockEditablePath=__exports.leftLeafOnlyInScopeNotBlockEditablePath=createDOMPathGenerator(DIRECTIONS.LEFT,{leafOnly:true,inScope:true,stopTraverseFunction:node=>isNotEditableNode(node)||isBlock(node),stopFunction:node=>isNotEditableNode(node)||isBlock(node),});const rightLeafOnlyNotBlockPath=__exports.rightLeafOnlyNotBlockPath=createDOMPathGenerator(DIRECTIONS.RIGHT,{leafOnly:true,stopTraverseFunction:isBlock,stopFunction:isBlock,});const rightLeafOnlyPathNotBlockNotEditablePath=__exports.rightLeafOnlyPathNotBlockNotEditablePath=createDOMPathGenerator(DIRECTIONS.RIGHT,{leafOnly:true,});const rightLeafOnlyInScopeNotBlockEditablePath=__exports.rightLeafOnlyInScopeNotBlockEditablePath=createDOMPathGenerator(DIRECTIONS.RIGHT,{leafOnly:true,inScope:true,stopTraverseFunction:node=>isNotEditableNode(node)||isBlock(node),stopFunction:node=>isNotEditableNode(node)||isBlock(node),});const rightLeafOnlyNotBlockNotEditablePath=__exports.rightLeafOnlyNotBlockNotEditablePath=createDOMPathGenerator(DIRECTIONS.RIGHT,{leafOnly:true,stopTraverseFunction:node=>isNotEditableNode(node)||isBlock(node),stopFunction:node=>isBlock(node)&&!isNotEditableNode(node),});__exports.peek=peek;function peek(arr){return arr[arr.length-1];}
__exports.isMacOS=isMacOS;function isMacOS(){return window.navigator.userAgent.includes('Mac');}
__exports.cleanZWS=cleanZWS;function cleanZWS(node){[node,...descendants(node)].filter(node=>node.nodeType===Node.TEXT_NODE&&node.nodeValue.includes('\u200B')).forEach(node=>node.nodeValue=node.nodeValue.replace(/\u200B/g,''));}
return __exports;});